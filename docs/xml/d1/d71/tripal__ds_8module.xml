<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.15">
  <compounddef id="d1/d71/tripal__ds_8module" kind="file" language="C++">
    <compoundname>tripal_ds.module</compoundname>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline><highlight class="normal">&lt;?php</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">require_once<sp/>&quot;includes/tripal_ds.inc&quot;;</highlight></codeline>
<codeline><highlight class="normal">require_once<sp/>&quot;includes/tripal_ds.ds.inc&quot;;</highlight></codeline>
<codeline><highlight class="normal">require_once<sp/>&quot;includes/tripal_ds.field_group.inc&quot;;</highlight></codeline>
<codeline><highlight class="normal">require_once<sp/>&quot;includes/tripal_ds.field_formatter.inc&quot;;</highlight></codeline>
<codeline><highlight class="normal">require_once<sp/>&quot;includes/tripal_ds.field_formatter.inc&quot;;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">//<sp/>Import<sp/>the<sp/>full<sp/>Tripal_DS<sp/>API<sp/>into<sp/>scope.</highlight></codeline>
<codeline><highlight class="normal">tripal_ds_import_api();</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_init().</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Injects<sp/>required<sp/>javascript<sp/>and<sp/>css.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_init()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>drupal_add_css(drupal_get_path(&apos;module&apos;,<sp/>&apos;tripal_ds&apos;)<sp/>.<sp/>&apos;/theme/css/tripal_ds.css&apos;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>drupal_add_js(drupal_get_path(&apos;module&apos;,<sp/>&apos;tripal_ds&apos;)<sp/>.<sp/>&apos;/theme/js/tripal_ds.js&apos;);</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>$theme_dir<sp/>=<sp/>url(drupal_get_path(&apos;module&apos;,<sp/>&apos;tripal_ds&apos;)<sp/>.<sp/>&apos;/theme&apos;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>drupal_add_js(&quot;var<sp/>ds_theme_dir<sp/><sp/>=<sp/>&apos;$theme_dir&apos;;&quot;,<sp/>&apos;inline&apos;,<sp/>&apos;header&apos;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Icon<sp/>fonts.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>drupal_add_css(drupal_get_path(&apos;module&apos;,<sp/>&apos;tripal_ds&apos;)<sp/>.<sp/>&apos;/theme/fonts/font-awesome-4.7.0/css/font-awesome.min.css&apos;);</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_views_api().</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_views_api()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>&apos;api&apos;<sp/>=&gt;<sp/>3,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>&apos;path&apos;<sp/>=&gt;<sp/>drupal_get_path(&apos;module&apos;,<sp/>&apos;tripal_ds&apos;)<sp/>.<sp/>&apos;/includes/views&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_menu().</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Defines<sp/>all<sp/>menu<sp/>items<sp/>needed<sp/>by<sp/>Tripal<sp/>DS</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_menu()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$items<sp/>=<sp/>array();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Adds<sp/>a<sp/>+Apply<sp/>Tripal<sp/>Display<sp/>Suite<sp/>option<sp/>to<sp/>&apos;Tripal<sp/>Content<sp/>Types&apos;<sp/>page.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$items[&apos;admin/structure/bio_data/manage/%/display/apply&apos;]<sp/>=<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;title&apos;<sp/>=&gt;<sp/>&apos;Apply<sp/>Default<sp/>Tripal<sp/>Layout<sp/>(will<sp/>reset<sp/>current<sp/>layout)&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;description&apos;<sp/>=&gt;<sp/>t(&apos;Apply<sp/>the<sp/>Tripal<sp/>Display<sp/>Suite<sp/>settings<sp/>to<sp/>this<sp/>content<sp/>type.&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;page<sp/>callback&apos;<sp/>=&gt;<sp/>&apos;drupal_get_form&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;access<sp/>arguments&apos;<sp/>=&gt;<sp/>array(&apos;administer<sp/>tripal&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;page<sp/>arguments&apos;<sp/>=&gt;<sp/>array(&apos;tripal_ds_update_layout_form&apos;,<sp/>4),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;type&apos;<sp/>=&gt;<sp/>MENU_LOCAL_ACTION,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Adds<sp/>a<sp/>+Add<sp/>Tripal<sp/>Pane<sp/>button<sp/>to<sp/>&apos;Tripal<sp/>Content<sp/>Types&apos;<sp/>page.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$items[&apos;admin/structure/bio_data/manage/%/display/create&apos;]<sp/>=<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;title&apos;<sp/>=&gt;<sp/>&apos;Create<sp/>an<sp/>empty<sp/>Tripal<sp/>Pane&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;description&apos;<sp/>=&gt;<sp/>t(&apos;Create<sp/>a<sp/>new<sp/>empty<sp/>tripal<sp/>pane.&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;page<sp/>callback&apos;<sp/>=&gt;<sp/>&apos;drupal_get_form&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;access<sp/>arguments&apos;<sp/>=&gt;<sp/>array(&apos;administer<sp/>tripal&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;page<sp/>arguments&apos;<sp/>=&gt;<sp/>array(&apos;tripal_ds_pane_addition_button_form&apos;,<sp/>4),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;type&apos;<sp/>=&gt;<sp/>MENU_LOCAL_ACTION,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>$items;</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_bundle_postcreate().</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>This<sp/>is<sp/>a<sp/>Triapl<sp/>defined<sp/>hook<sp/>and<sp/>is<sp/>called<sp/>in<sp/>the<sp/>TripalBundle::create()</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>function<sp/>to<sp/>allow<sp/>modules<sp/>to<sp/>perform<sp/>tasks<sp/>when<sp/>a<sp/>bundle<sp/>is<sp/>created.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_bundle_postcreate($bundle)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_name<sp/>=<sp/>$bundle-&gt;name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_data_table<sp/>=<sp/>$bundle-&gt;data_table;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$instances<sp/>=<sp/>field_info_instances(&apos;TripalEntity&apos;,<sp/>$bundle_name);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if($bundle_data_table<sp/>==<sp/>&apos;pub&apos;){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>_ds_layout_pub_settings_info($bundle_name,<sp/>$instances);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>else<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>_ds_layout_settings_info($bundle_name,<sp/>$instances);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Update<sp/>the<sp/>tripal_ds<sp/>table<sp/>when<sp/>a<sp/>tripal<sp/>pane<sp/>is<sp/>deleted.<sp/>This<sp/>will<sp/>remove</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>the<sp/>link<sp/>from<sp/>the<sp/>table<sp/>of<sp/>contents<sp/>block.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_table_column_delete($bundle){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$bundle_name<sp/>=<sp/>$bundle-&gt;name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>db_delete(&apos;tripal_ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Trigger<sp/>the<sp/>update<sp/>to<sp/>the<sp/>tripal_ds<sp/>table<sp/>when<sp/>a<sp/>tripal<sp/>pane<sp/>is<sp/>deleted.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_bundle_delete($bundle){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>tripal_ds_table_column_delete($bundle);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_ds_field_settings_alter()</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Upon<sp/>save<sp/>field<sp/>groups<sp/>are<sp/>reviewed<sp/>so<sp/>that<sp/>the<sp/>tripal_ds<sp/>table<sp/>is<sp/>update<sp/>and</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>thus<sp/>the<sp/>table<sp/>of<sp/>contents<sp/>block<sp/>is<sp/>be<sp/>updated.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$field_settings</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form_state</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_ds_field_settings_alter(&amp;$field_settings,<sp/>$form,<sp/>$form_state){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Get<sp/>the<sp/>form<sp/>info<sp/>from<sp/>the<sp/>bundle<sp/>about<sp/>to<sp/>be<sp/>saved.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$tripal_entity_object<sp/>=<sp/>$form_state[&apos;build_info&apos;][&apos;args&apos;][&apos;1&apos;];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Grab<sp/>the<sp/>bundle.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_id<sp/>=<sp/>$tripal_entity_object-&gt;name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Grab<sp/>the<sp/>field<sp/>groups<sp/>from<sp/>the<sp/>bundle.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$updated_field_groups<sp/>=<sp/>$form_state[&apos;field_group&apos;];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Grab<sp/>the<sp/>fields<sp/>from<sp/>the<sp/>bundle.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$fields<sp/>=<sp/>$form_state[&apos;values&apos;][&apos;fields&apos;];</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Delete<sp/>the<sp/>menu<sp/>items<sp/>associated<sp/>with<sp/>the<sp/>bundle<sp/>id.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>db_delete(&apos;tripal_ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_id,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Traverse<sp/>the<sp/>updated<sp/>field_groups<sp/>grabbing<sp/>the<sp/>tripal<sp/>pane<sp/>items.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$tripal_pane_field_groups<sp/>=<sp/>array();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$i<sp/>=<sp/>0;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>foreach($updated_field_groups<sp/>as<sp/>$updated_field_group){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if($updated_field_group-&gt;format_type<sp/>==<sp/>&apos;tripalpane&apos;){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$tripal_pane_field_groups<sp/>+=<sp/>[<sp/>$i<sp/>=&gt;<sp/>$updated_field_group-&gt;group_name];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$i++;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Now<sp/>grab<sp/>the<sp/>labels<sp/>of<sp/>the<sp/>tripalpane.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>foreach($updated_field_groups<sp/>as<sp/>$updated_field_group){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>foreach($tripal_pane_field_groups<sp/>as<sp/>$tripal_pane_field_group){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if($updated_field_group-&gt;group_name<sp/>==<sp/>$tripal_pane_field_group){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if($fields[$tripal_pane_field_group][&apos;region&apos;]<sp/>!==<sp/>&apos;hidden&apos;){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tripal_ds_bundle_menu_item($bundle_id,<sp/>$updated_field_group-&gt;label,<sp/>$tripal_pane_field_group,<sp/>&apos;tripalentity&apos;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Update<sp/>the<sp/>menu<sp/>items<sp/>weight.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>tripal_ds_toc_order($bundle_id,<sp/>$form_state[&apos;values&apos;][&apos;fields&apos;]);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Trigger<sp/>the<sp/>update<sp/>to<sp/>the<sp/>tripal_ds<sp/>table<sp/>when<sp/>a<sp/>tripal<sp/>pane<sp/>is<sp/>deleted.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$field_label</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$field_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$entity_type</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_bundle_menu_item($bundle_name,<sp/>$field_label,<sp/>$field_name,<sp/>$entity_type){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Check<sp/>the<sp/>record<sp/>does<sp/>not<sp/>already<sp/>exist</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$tripal_ds_rows<sp/>=<sp/>db_select(&apos;tripal_ds&apos;,<sp/>&apos;ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;ds&apos;,<sp/>array(&apos;tripal_ds_field_name&apos;,<sp/>&apos;tripal_ds_field_label&apos;))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;tripal_ds_field_label&apos;,<sp/>$field_label,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;tripal_ds_field_name&apos;,<sp/>$field_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()-&gt;fetchAll();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if(!empty($tripal_ds_rows)){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>foreach<sp/>($tripal_ds_rows<sp/>as<sp/>$tripal_ds_row){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if(($field_label<sp/>==<sp/>$tripal_ds_row-&gt;tripal_ds_field_label)<sp/>&amp;&amp;<sp/>($field_name<sp/>==<sp/>$tripal_ds_row-&gt;tripal_ds_field_name)<sp/>&amp;&amp;<sp/>($bundle_name<sp/>==<sp/>$tripal_ds_rows-&gt;bundle))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>Do<sp/>not<sp/>write<sp/>the<sp/>field<sp/>to<sp/>the<sp/>table</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(&quot;Could<sp/>not<sp/>update<sp/>the<sp/>bundle<sp/>menu<sp/>because<sp/>that<sp/>field<sp/>already<sp/>exists.&quot;,<sp/>&apos;error&apos;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>else<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>//Write<sp/>to<sp/>the<sp/>tripal_ds<sp/>table<sp/>to<sp/>record<sp/>the<sp/>new<sp/>tripal<sp/>pane.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$field_for_table<sp/>=<sp/>new<sp/>stdClass();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$field_for_table-&gt;tripal_ds_field_name<sp/>=<sp/>$field_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$field_for_table-&gt;tripal_ds_field_label<sp/>=<sp/>$field_label;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$field_for_table-&gt;entity_type<sp/>=<sp/>$entity_type;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$field_for_table-&gt;bundle<sp/>=<sp/>$bundle_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_write_record(&apos;tripal_ds&apos;,<sp/>$field_for_table);</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_ds_layout_info()<sp/>to<sp/>define<sp/>layouts<sp/>from<sp/>code<sp/>in<sp/>a<sp/>module<sp/>for</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>display<sp/>suite.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Defines<sp/>the<sp/>Tripal<sp/>Feature<sp/>Layout<sp/>option.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_ds_layout_info()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$path<sp/>=<sp/>drupal_get_path(&apos;module&apos;,<sp/>&apos;tripal_ds&apos;);</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>$layouts<sp/>=<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;tripal_ds_feature&apos;<sp/>=&gt;<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&apos;label&apos;<sp/>=&gt;<sp/>t(&apos;Tripal<sp/>Feature<sp/>Layout&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&apos;path&apos;<sp/>=&gt;<sp/>$path<sp/>.<sp/>&apos;/theme/templates&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&apos;regions&apos;<sp/>=&gt;<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&apos;left&apos;<sp/>=&gt;<sp/>t(&apos;Left&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&apos;right&apos;<sp/>=&gt;<sp/>t(&apos;Right&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&apos;css&apos;<sp/>=&gt;<sp/>TRUE,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>$layouts;</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_form()</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Adds<sp/>a<sp/>confirmation<sp/>message<sp/>to<sp/>applying<sp/>default<sp/>layout<sp/>option<sp/>in<sp/>&apos;Manage</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Display&apos;.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form_state</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@return<sp/>mixed</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_update_layout_form($form,<sp/>&amp;$form_state,<sp/>$bundle_name)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$form<sp/>=<sp/>array();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$form[&apos;bundle_name&apos;]<sp/>=<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#type&apos;<sp/>=&gt;<sp/>&apos;value&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#value&apos;<sp/>=&gt;<sp/>$bundle_name,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle<sp/>=<sp/>tripal_load_bundle_entity(array(&apos;name&apos;<sp/>=&gt;<sp/>$bundle_name));</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_label<sp/>=<sp/>$bundle-&gt;label;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>confirm_form($form,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;Please<sp/>confirm<sp/>you<sp/>would<sp/>like<sp/>to<sp/>apply<sp/>this<sp/>layout:<sp/>&apos;<sp/>.<sp/>$bundle_label),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;admin/structure/bio_data/manage/&apos;<sp/>.<sp/>$bundle_name<sp/>.<sp/>&apos;/display&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;This<sp/>action<sp/>cannot<sp/>be<sp/>undone.&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;Yes,<sp/>apply<sp/>layout&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;No,<sp/>cancel&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_form_submit()</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Deletes<sp/>all<sp/>existing<sp/>settings<sp/>associated<sp/>with<sp/>a<sp/>bundle&apos;s<sp/>display<sp/>settings</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>so<sp/>that<sp/>the<sp/>default<sp/>layout<sp/>is<sp/>applied<sp/>cleanly.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form_state</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_update_layout_form_submit($form,<sp/>&amp;$form_state)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_name<sp/>=<sp/>$form_state[&apos;build_info&apos;][&apos;args&apos;][0];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle<sp/>=<sp/>tripal_load_bundle_entity(array(&apos;name&apos;<sp/>=&gt;<sp/>$bundle_name));</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Build<sp/>the<sp/>identifier<sp/>to<sp/>check<sp/>against<sp/>ds_layout_settings.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$ds_identifier<sp/>=<sp/>&apos;TripalEntity|&apos;.$bundle_name.&apos;|default&apos;;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Check<sp/>to<sp/>see<sp/>if<sp/>the<sp/>layout<sp/>already<sp/>exists.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$result<sp/>=<sp/>db_select(&apos;ds_layout_settings&apos;,<sp/>&apos;ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;id&apos;,<sp/>$ds_identifier,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fetchField();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Check<sp/>to<sp/>see<sp/>if<sp/>there<sp/>are<sp/>any<sp/>field<sp/>groups<sp/>associated<sp/>with<sp/>the<sp/>bundle.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$result_fg<sp/>=<sp/>db_select(&apos;field_group&apos;,<sp/>&apos;fg&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;fg&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fetchField();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Check<sp/>to<sp/>see<sp/>if<sp/>there<sp/>are<sp/>any<sp/>tripal<sp/>ds<sp/>fields<sp/>associated<sp/>with<sp/>the<sp/>bundle.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$result_tds<sp/>=<sp/>db_select(&apos;tripal_ds&apos;,<sp/>&apos;tds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;tds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Check<sp/>to<sp/>see<sp/>if<sp/>there<sp/>are<sp/>any<sp/>field<sp/>settings<sp/>associated<sp/>with<sp/>the<sp/>bundle.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$result_fs<sp/>=<sp/>db_select(&apos;ds_field_settings&apos;,<sp/>&apos;fs&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;fs&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//If<sp/>the<sp/>layout<sp/>exists,<sp/>delete<sp/>it.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if(!empty($result))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>db_delete(&apos;ds_layout_settings&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;id&apos;,<sp/>$ds_identifier,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Then<sp/>delete<sp/>the<sp/>field_group_fields<sp/>associated<sp/>with<sp/>the<sp/>identifier.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if(!empty($result_fg))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>db_delete(&apos;field_group&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Then<sp/>delete<sp/>the<sp/>ds_field_settings<sp/>associated<sp/>with<sp/>the<sp/>identifier.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if(!empty($result_tds))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>db_delete(&apos;ds_field_settings&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Then<sp/>delete<sp/>the<sp/>tripal_ds<sp/>menu<sp/>item.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if(!empty($result_fs))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>db_delete(&apos;tripal_ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Now<sp/>you<sp/>can<sp/>build<sp/>the<sp/>layout<sp/>fresh.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$instances<sp/>=<sp/>field_info_instances(&apos;TripalEntity&apos;,<sp/>$bundle_name);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_data_table<sp/>=<sp/>$bundle-&gt;data_table;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if($bundle_data_table<sp/>==<sp/>&apos;pub&apos;){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$success<sp/>=<sp/>_ds_layout_pub_settings_info($bundle_name,<sp/>$instances);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>else<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$success<sp/>=<sp/>_ds_layout_settings_info($bundle_name,<sp/>$instances);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>($success)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_set_message(&quot;Layout<sp/>applied<sp/>successfully<sp/>and<sp/>saved.&quot;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>else<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_set_message(&quot;Could<sp/>not<sp/>apply<sp/>layout.&quot;,<sp/>&apos;error&apos;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>drupal_goto(&quot;admin/structure/bio_data/manage/$bundle_name/display&quot;);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_form()</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Creates<sp/>the<sp/>button<sp/>that<sp/>creates<sp/>an<sp/>empty<sp/>tripal<sp/>pane.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form_state</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@return<sp/>mixed</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_pane_addition_button_form($form,<sp/>&amp;$form_state,<sp/>$bundle_name)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$form<sp/>=<sp/>array();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$form[&apos;bundle_name&apos;]<sp/>=<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#type&apos;<sp/>=&gt;<sp/>&apos;value&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#value&apos;<sp/>=&gt;<sp/>$bundle_name,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$form[&apos;field_name&apos;]<sp/>=<sp/>array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#type&apos;<sp/>=&gt;<sp/>&apos;textfield&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#title&apos;<sp/>=&gt;<sp/>t(&apos;Tripal<sp/>Panel<sp/>Label&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#required&apos;<sp/>=&gt;<sp/>TRUE,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#description&apos;<sp/>=&gt;<sp/>&quot;Please<sp/>enter<sp/>the<sp/>label<sp/>for<sp/>the<sp/>new<sp/>Tripal<sp/>Pane&quot;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#size&apos;<sp/>=&gt;<sp/>20,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;#maxlength&apos;<sp/>=&gt;<sp/>50,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle<sp/>=<sp/>tripal_load_bundle_entity(array(&apos;name&apos;<sp/>=&gt;<sp/>$bundle_name));</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_label<sp/>=<sp/>$bundle-&gt;label;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>confirm_form($form,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;Please<sp/>confirm<sp/>you<sp/>would<sp/>like<sp/>to<sp/>create<sp/>a<sp/>new<sp/>field<sp/>for:<sp/>&apos;<sp/>.<sp/>$bundle_label),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&apos;admin/structure/bio_data/manage/&apos;<sp/>.<sp/>$bundle_name<sp/>.<sp/>&apos;/display&apos;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;Create<sp/>new<sp/>Tripal<sp/>Pane&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;Yes&apos;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>t(&apos;No,<sp/>cancel&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_form_submit()</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form_state</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$form</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_pane_addition_button_form_submit($form,<sp/>&amp;$form_state)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$bundle_name<sp/>=<sp/>$form_state[&apos;build_info&apos;][&apos;args&apos;][0];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Build<sp/>the<sp/>rest<sp/>of<sp/>the<sp/>passed<sp/>variables.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$field_name<sp/>=<sp/>$form_state[&apos;input&apos;][&apos;field_name&apos;];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$field_label<sp/>=<sp/>$form_state[&apos;input&apos;][&apos;field_name&apos;];</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>tripal_ds_create_field($field_label,<sp/>$field_name,<sp/>$bundle_name);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>drupal_goto(&quot;admin/structure/bio_data/manage/$bundle_name/display&quot;);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>When<sp/>called<sp/>the<sp/>function<sp/>will<sp/>add<sp/>field_groups<sp/>to<sp/>the<sp/>existing<sp/>tripal_ds</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>layout<sp/>in<sp/>the<sp/>correct<sp/>regions.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/><sp/>The<sp/>name<sp/>of<sp/>the<sp/>bundle<sp/>the<sp/>pane<sp/>is<sp/>being<sp/>added<sp/>to.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$field_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/><sp/>The<sp/>machine<sp/>name<sp/>for<sp/>the<sp/>field.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$tripal_pane_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/><sp/>The<sp/>machine<sp/>name<sp/>for<sp/>the<sp/>tripal<sp/>pane.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_update_ds_layout($bundle_name,<sp/>$field_name,<sp/>$tripal_pane_name)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Build<sp/>the<sp/>identifier<sp/>to<sp/>check<sp/>against<sp/>ds_layout_settings.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$ds_identifier<sp/>=<sp/>&apos;TripalEntity|&apos;.$bundle_name.&apos;|default&apos;;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//Check<sp/>to<sp/>see<sp/>if<sp/>the<sp/>layout<sp/>already<sp/>exists.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$result<sp/>=<sp/>db_select(&apos;ds_layout_settings&apos;,<sp/>&apos;ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;ds&apos;,<sp/>array(&apos;settings&apos;))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;ds.id&apos;,<sp/>$ds_identifier,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fetchObject();</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//If<sp/>the<sp/>layout<sp/>exists<sp/>unserialize<sp/>it.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if(!empty($result))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$layout_info<sp/>=<sp/>$result-&gt;settings;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$layout_info<sp/>=<sp/>unserialize($layout_info);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>//Count<sp/>the<sp/>number<sp/>of<sp/>rows<sp/>in<sp/>the<sp/>region<sp/>and<sp/>add<sp/>the<sp/>field<sp/>to<sp/>the<sp/>region.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$index<sp/>=<sp/>count($layout_info[&apos;regions&apos;][&apos;right&apos;]);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>//Now<sp/>add<sp/>the<sp/>tripal<sp/>pane<sp/>and<sp/>field<sp/>to<sp/>the<sp/>right<sp/>region<sp/>and<sp/>field<sp/>array.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if(!empty($field_name)){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$layout_info[&apos;regions&apos;][&apos;right&apos;][$index]<sp/>=<sp/>$field_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$incremented_index<sp/>=<sp/>$index++;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$layout_info[&apos;fields&apos;][$field_name]<sp/>=<sp/>&apos;right&apos;;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if(!empty($tripal_pane_name)){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if(!empty($incremented_index)){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$layout_info[&apos;regions&apos;][&apos;right&apos;][$incremented_index]<sp/>=<sp/>$tripal_pane_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$layout_info[&apos;fields&apos;][$tripal_pane_name]<sp/>=<sp/>&apos;right&apos;;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$layout_info[&apos;regions&apos;][&apos;right&apos;][$index]<sp/>=<sp/>$tripal_pane_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$layout_info[&apos;fields&apos;][$tripal_pane_name]<sp/>=<sp/>&apos;right&apos;;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>//Update<sp/>the<sp/>ds_layout_settings<sp/>table<sp/>with<sp/>the<sp/>new<sp/>layout<sp/>info.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_write_record(&apos;ds_layout_settings&apos;,<sp/>$layout_info);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline><highlight class="normal">/*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Code<sp/>for<sp/>the<sp/>view<sp/>of<sp/>the<sp/>menu<sp/>items</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>//get<sp/>tripal<sp/>entity<sp/>id<sp/>from<sp/>url<sp/>then<sp/>run<sp/>it<sp/>against<sp/>tripal<sp/>entity<sp/>db</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>//and<sp/>grab<sp/>the<sp/>bundle<sp/>id,<sp/>then<sp/>pass<sp/>bundle<sp/>id<sp/>to<sp/>view</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$url<sp/>=<sp/>current_path();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$url_exploded<sp/>=<sp/>explode(&quot;/&quot;,<sp/>$url);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$tripal_entity_id<sp/>=<sp/>(int)$url_exploded[1];</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$result<sp/>=<sp/>db_select(&apos;tripal_entity&apos;,<sp/>&apos;te&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;fields(&apos;te&apos;,<sp/>array(&apos;bundle&apos;))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;id&apos;,<sp/>$tripal_entity_id,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;fetchField();</highlight></codeline>
<codeline><highlight class="normal">*/</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Implements<sp/>hook_field_display_alter().</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Alters<sp/>the<sp/>display<sp/>settings<sp/>of<sp/>a<sp/>field<sp/>before<sp/>it<sp/>gets<sp/>displayed.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Hides<sp/>the<sp/>empty<sp/>tripal<sp/>panes<sp/>if<sp/>the<sp/>content<sp/>type<sp/>has<sp/>been<sp/>set<sp/>to<sp/>hide<sp/>empty</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>fields.<sp/>This<sp/>option<sp/>is<sp/>found<sp/>in<sp/>the<sp/>edit<sp/>tab<sp/>of<sp/>the<sp/>tripal<sp/>content<sp/>type<sp/>with</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>a<sp/>title<sp/>&apos;Field<sp/>Display&apos;.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$display</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$context</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_field_display_alter(&amp;$display,<sp/>$context){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>($context[&apos;entity_type&apos;]<sp/>==<sp/>&apos;TripalEntity&apos;)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$field_name<sp/>=<sp/>$context[&apos;field&apos;][&apos;field_name&apos;];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$bundle<sp/>=<sp/>$context[&apos;entity&apos;]-&gt;bundle;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$bundle_info<sp/>=<sp/>tripal_load_bundle_entity(array(&apos;name&apos;<sp/>=&gt;<sp/>$bundle));</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$hide_variable<sp/>=<sp/>tripal_get_bundle_variable(&apos;hide_empty_field&apos;,<sp/>$bundle_info-&gt;id,<sp/>&apos;hide&apos;);</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>($field_name<sp/>&amp;&amp;<sp/>($hide_variable<sp/>==<sp/>&apos;hide&apos;))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$item<sp/>=<sp/>field_get_items(&apos;TripalEntity&apos;,<sp/>$context[&apos;entity&apos;],<sp/>$field_name);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$field<sp/>=<sp/>field_info_field($field_name);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>($item)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(tripal_field_is_empty($item[0],<sp/>$field))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$parent_field_info<sp/>=<sp/>tripal_ds_find_field_group_parent($field_name,<sp/>&apos;TripalEntity&apos;,<sp/>$bundle,<sp/>$context);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!empty($parent_field_info))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>foreach<sp/>($parent_field_info<sp/>as<sp/>$parent_key<sp/>=&gt;<sp/>$parent_field){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>We<sp/>want<sp/>to<sp/>use<sp/>JavaScript<sp/>to<sp/>remove<sp/>the<sp/>fields<sp/>rather<sp/>than</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>CSS<sp/>to<sp/>hide<sp/>them<sp/>so<sp/>that<sp/>when<sp/>users<sp/>theme<sp/>the<sp/>table<sp/>of</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>contents<sp/>using<sp/>CSS<sp/>they<sp/>aren&apos;t<sp/>theming<sp/>empty<sp/>rows.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_add_js(&apos;jQuery(document).ready(function<sp/>()<sp/>{<sp/>jQuery(&quot;#&apos;<sp/>.<sp/>$parent_field_info[$parent_key]<sp/>.<sp/>&apos;&quot;).parents(&quot;.views-row&quot;).remove()<sp/>});&apos;,<sp/>&apos;inline&apos;);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Identifies<sp/>field_group<sp/>parents<sp/>to<sp/>find<sp/>tripal_panes<sp/>and<sp/>return<sp/>that</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>information<sp/>to<sp/>the<sp/>function<sp/>that<sp/>calls<sp/>it.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$field_name</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$entity_type</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@return<sp/>array</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_find_field_group_parent($field_name,<sp/>$entity_type,<sp/>$bundle,<sp/>$context){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$field_groups_to_hide<sp/>=<sp/>array();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$increment<sp/>=<sp/>0;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Get<sp/>the<sp/>field<sp/>groups<sp/>associated<sp/>with<sp/>this<sp/>bundle.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$fg_for_bundle<sp/>=<sp/>db_select(&apos;field_group&apos;,<sp/>&apos;fg&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;fg&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;entity_type&apos;,<sp/>$entity_type,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()-&gt;fetchAll();</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Run<sp/>through<sp/>the<sp/>field<sp/>groups<sp/>looking<sp/>for<sp/>the<sp/>provided<sp/>$field_name</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>foreach<sp/>($fg_for_bundle<sp/>as<sp/>$field_groups<sp/>=&gt;<sp/>$field_group)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>$field_group_data<sp/>=<sp/>unserialize($field_group-&gt;data);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>//<sp/>There<sp/>is<sp/>a<sp/>separate<sp/>function<sp/>to<sp/>deal<sp/>with<sp/>tables,<sp/>so<sp/>disregard.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>($field_group_data[&apos;format_type&apos;]<sp/>==<sp/>&apos;table&apos;){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>Do<sp/>nothing</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>elseif<sp/>(!empty($field_group_data[&apos;children&apos;][0]))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$children<sp/>=<sp/>$field_group_data[&apos;children&apos;];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>//If<sp/>there<sp/>is<sp/>more<sp/>than<sp/>one<sp/>child<sp/>all<sp/>need<sp/>to<sp/>be<sp/>checked.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(count($children)<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>foreach<sp/>($children<sp/>as<sp/>$kids<sp/>=&gt;<sp/>$child)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>Now<sp/>check<sp/>if<sp/>each<sp/>child<sp/>if<sp/>empty.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$item<sp/>=<sp/>field_get_items(&apos;TripalEntity&apos;,<sp/>$context[&apos;entity&apos;],<sp/>$child);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$field<sp/>=<sp/>field_info_field($child);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(!tripal_field_is_empty($item[0],<sp/>$field)){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//If<sp/>any<sp/>of<sp/>the<sp/>fields<sp/>are<sp/>not<sp/>empty<sp/>do<sp/>not<sp/>add<sp/>the<sp/>parent.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break<sp/>2;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$field_groups_to_hide[$increment]<sp/>=<sp/>$field_group-&gt;group_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>elseif($children[0]<sp/>==<sp/>$field_name)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$field_groups_to_hide[$increment]<sp/>=<sp/>$field_group-&gt;group_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$increment++;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Remove<sp/>duplicate<sp/>values.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$field_groups_to_hide<sp/>=<sp/>array_unique($field_groups_to_hide);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>$field_groups_to_hide;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Updates<sp/>the<sp/>tripal_ds<sp/>table<sp/>with<sp/>weight<sp/>information<sp/>of<sp/>field_groups<sp/>on</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>save<sp/>of<sp/>&quot;manage<sp/>display&apos;<sp/>of<sp/>content<sp/>type.<sp/>Weight<sp/>is<sp/>what<sp/>is<sp/>used<sp/>to<sp/>order</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>the<sp/>menu<sp/>items.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>$bundle</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>@param<sp/>array<sp/>$fields</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_toc_order($bundle,<sp/>$fields<sp/>=<sp/>array()){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Find<sp/>all<sp/>menu<sp/>items<sp/>associated<sp/>with<sp/>the<sp/>bundle<sp/>id.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>$menu_items<sp/>=<sp/>db_select(&apos;tripal_ds&apos;,<sp/>&apos;ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(&apos;ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()-&gt;fetchAll();</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>//<sp/>Now<sp/>find<sp/>all<sp/>menu<sp/>items<sp/>in<sp/>the<sp/>$fields<sp/>array</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>foreach<sp/>($menu_items<sp/>as<sp/>$menu_items<sp/>=&gt;<sp/>$menu_item)<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$toc_field_name<sp/>=<sp/>$menu_item-&gt;tripal_ds_field_name;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>//<sp/>Compare<sp/>the<sp/>field<sp/>name<sp/>from<sp/>the<sp/>table<sp/>with<sp/>the<sp/>fields<sp/>in<sp/>the<sp/>array.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>(array_key_exists($toc_field_name,<sp/>$fields))<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$weight<sp/>=<sp/>$fields[$toc_field_name][&apos;weight&apos;];</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>//If<sp/>a<sp/>weight<sp/>is<sp/>returned<sp/>update<sp/>the<sp/>tripal_ds<sp/>table.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if(!empty($weight)){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db_update(&apos;tripal_ds&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;fields(array(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&apos;weight&apos;<sp/>=&gt;<sp/>$weight,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;bundle&apos;,<sp/>$bundle,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(&apos;tripal_ds_field_name&apos;,<sp/>$toc_field_name,<sp/>&apos;=&apos;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">/**</highlight></codeline>
<codeline><highlight class="normal"><sp/>*<sp/>Imports<sp/>all<sp/>of<sp/>the<sp/>Tripal_DS<sp/>API<sp/>into<sp/>scope.</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/>*/</highlight></codeline>
<codeline><highlight class="normal">function<sp/>tripal_ds_import_api()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>module_load_include(&apos;inc&apos;,<sp/>&apos;tripal_ds&apos;,<sp/>&apos;api/tripal_ds.pane.api&apos;);</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="tripal_ds/tripal_ds.module"/>
  </compounddef>
</doxygen>

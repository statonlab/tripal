<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.15">
  <compounddef id="d8/d68/tripal__chado_8mviews_8api_8inc" kind="file" language="PHP">
    <compoundname>tripal_chado.mviews.api.inc</compoundname>
      <sectiondef kind="func">
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1ga6df34f1c008e4269f179d8d2e51ef650" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_add_mview</definition>
        <argsstring>($name, $modulename, $mv_schema, $query, $comment=NULL, $redirect=TRUE)</argsstring>
        <name>chado_add_mview</name>
        <param>
          <declname>$name</declname>
        </param>
        <param>
          <declname>$modulename</declname>
        </param>
        <param>
          <declname>$mv_schema</declname>
        </param>
        <param>
          <declname>$query</declname>
        </param>
        <param>
          <declname>$comment</declname>
          <defval>NULL</defval>
        </param>
        <param>
          <declname>$redirect</declname>
          <defval>TRUE</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Add a materialized view to the chado database.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$name</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the materialized view. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$modulename</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the module submitting the materialized view (e.g. &apos;tripal_library&apos;). </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$mv_schema</parametername>
</parameternamelist>
<parameterdescription>
<para>If using the newer Schema API array to define the materialized view then this variable should contain the array or a string representation of the array. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$query</parametername>
</parameternamelist>
<parameterdescription>
<para>The SQL query that loads the materialized view with data. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$comment</parametername>
</parameternamelist>
<parameterdescription>
<para>A string containing a description of the materialized view. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$redirect</parametername>
</parameternamelist>
<parameterdescription>
<para>Optional (default: TRUE). By default this function redirects back to admin pages. However, when called by Drush we don&apos;t want to redirect. This parameter allows this to be used as a true API function.</para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>TRUE if the materialized view was successfully added, FALSE otherwise. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="44" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="44" bodyend="114"/>
      </memberdef>
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1ga6b7bea36769a0eb69792bb03f5e326ef" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_delete_mview</definition>
        <argsstring>($mview_id)</argsstring>
        <name>chado_delete_mview</name>
        <param>
          <declname>$mview_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Does the specified action for the specified Materialized View.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$op</parametername>
</parameternamelist>
<parameterdescription>
<para>The action to be taken. One of update or delete. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$mview_id</parametername>
</parameternamelist>
<parameterdescription>
<para>The unique ID of the materialized view for the action to be performed on.</para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>TRUE if the deletion was a success, FALSE on error. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="328" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="328" bodyend="379"/>
      </memberdef>
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1ga8c1e8378e693283994ada0455f037147" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_edit_mview</definition>
        <argsstring>($mview_id, $name, $modulename, $mv_table, $mv_specs, $indexed, $query, $special_index, $comment=NULL, $mv_schema=NULL)</argsstring>
        <name>chado_edit_mview</name>
        <param>
          <declname>$mview_id</declname>
        </param>
        <param>
          <declname>$name</declname>
        </param>
        <param>
          <declname>$modulename</declname>
        </param>
        <param>
          <declname>$mv_table</declname>
        </param>
        <param>
          <declname>$mv_specs</declname>
        </param>
        <param>
          <declname>$indexed</declname>
        </param>
        <param>
          <declname>$query</declname>
        </param>
        <param>
          <declname>$special_index</declname>
        </param>
        <param>
          <declname>$comment</declname>
          <defval>NULL</defval>
        </param>
        <param>
          <declname>$mv_schema</declname>
          <defval>NULL</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Edits a materialized view to the chado database to help speed data access. This function supports the older style where postgres column specifications are provided using the $mv_table, $mv_specs and $indexed variables. It also supports the newer preferred method where the materialized view is described using the Drupal Schema API array.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$mview_id</parametername>
</parameternamelist>
<parameterdescription>
<para>The mview_id of the materialized view to edit. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$name</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the materialized view. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$modulename</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the module submitting the materialized view (e.g. &apos;tripal_library&apos;). </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$mv_table</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the table to add to chado. This is the table that can be queried. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$mv_specs</parametername>
</parameternamelist>
<parameterdescription>
<para>The table definition. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$indexed</parametername>
</parameternamelist>
<parameterdescription>
<para>The columns that are to be indexed. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$query</parametername>
</parameternamelist>
<parameterdescription>
<para>The SQL query that loads the materialized view with data. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$special_index</parametername>
</parameternamelist>
<parameterdescription>
<para>currently not used. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$comment</parametername>
</parameternamelist>
<parameterdescription>
<para>A string containing a description of the materialized view. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$mv_schema</parametername>
</parameternamelist>
<parameterdescription>
<para>If using the newer Schema API array to define the materialized view then this variable should contain the array. </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="149" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="149" bodyend="216"/>
      </memberdef>
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1gaf36270cbaaaafb46bf039707cddc2ba4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_get_mview_id</definition>
        <argsstring>($view_name)</argsstring>
        <name>chado_get_mview_id</name>
        <param>
          <declname>$view_name</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Retrieve the materialized view_id given the name.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$view_name</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the materialized view.</para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The unique identifier for the given view. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="229" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="229" bodyend="240"/>
      </memberdef>
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1ga3fc9f750c4b46202ec59cf7f8e785d6b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_get_mview_table_names</definition>
        <argsstring>()</argsstring>
        <name>chado_get_mview_table_names</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Retrieves the list of materialized views in this site.</para><para><simplesect kind="return"><para>An associative array where the key and value pairs are the table names. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="250" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="250" bodyend="262"/>
      </memberdef>
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1gaf802e5f630f43355ca5ad637bf9b251a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_get_mviews</definition>
        <argsstring>()</argsstring>
        <name>chado_get_mviews</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Retrieves the list of materialized view IDs and their names.</para><para><simplesect kind="return"><para>An array of objects with the following properties: mview_id, name. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="302" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="302" bodyend="313"/>
      </memberdef>
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1gafd288ceff53400702a7174ef2a35511e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_populate_mview</definition>
        <argsstring>($mview_id)</argsstring>
        <name>chado_populate_mview</name>
        <param>
          <declname>$mview_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Update a Materialized View.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$mview_id</parametername>
</parameternamelist>
<parameterdescription>
<para>The unique identifier for the materialized view to be updated.</para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>True if successful, FALSE otherwise. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="392" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="392" bodyend="435"/>
      </memberdef>
      <memberdef kind="function" id="d0/de5/group__tripal__mviews__api_1gab0ae59dbeaa76c54f0594437ab8b863a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_refresh_mview</definition>
        <argsstring>($mview_id)</argsstring>
        <name>chado_refresh_mview</name>
        <param>
          <declname>$mview_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Populates the specified Materialized View.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$mview_id</parametername>
</parameternamelist>
<parameterdescription>
<para>The unique ID of the materialized view for the action to be performed on. </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.mviews.api.inc" line="272" column="1" bodyfile="tripal_chado/api/tripal_chado.mviews.api.inc" bodystart="272" bodyend="291"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
<para>Provides an application programming interface (API) to manage materialized views in Chado. </para>    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal">&lt;?php</highlight></codeline>
<codeline lineno="44" refid="d0/de5/group__tripal__mviews__api_1ga6df34f1c008e4269f179d8d2e51ef650" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1ga6df34f1c008e4269f179d8d2e51ef650" kindref="member">chado_add_mview</ref>($name,<sp/>$modulename,<sp/>$mv_schema,<sp/>$query,<sp/>$comment<sp/>=<sp/>NULL,<sp/>$redirect<sp/>=<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">,<sp/>$mv_schema))<sp/>{</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;Must<sp/>have<sp/>a<sp/>table<sp/>name<sp/>when<sp/>creating<sp/>an<sp/>mview.&apos;</highlight><highlight class="normal">,<sp/>array());</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/>$mv_table<sp/>=<sp/>$mv_schema[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/></highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>See<sp/>if<sp/>the<sp/>mv_table<sp/>name<sp/>already<sp/>exsists.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/>$mview_id<sp/>=<sp/>db_select(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;tm&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(</highlight><highlight class="stringliteral">&apos;tm&apos;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;mview_id&apos;</highlight><highlight class="normal">))</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(</highlight><highlight class="stringliteral">&apos;name&apos;</highlight><highlight class="normal">,<sp/>$name)</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fetchField();</highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>the<sp/>materialized<sp/>view<sp/>actually<sp/>exists<sp/>and<sp/>if<sp/>not,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>remove<sp/>the<sp/>entry<sp/>from<sp/>tripal_mviews.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($mview_id<sp/>AND<sp/>!<ref refid="d4/d51/group__tripal__chado__schema__api_1ga432ffbbb35405f7ca897c9985e9d1bed" kindref="member">chado_table_exists</ref>($name))<sp/>{</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/>db_delete(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;condition(</highlight><highlight class="stringliteral">&apos;mview_id&apos;</highlight><highlight class="normal">,<sp/>$mview_id)</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/>$mview_id<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!$mview_id)<sp/>{</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/>$transaction<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Create<sp/>a<sp/>new<sp/>record.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>stdClass();</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;name<sp/>=<sp/>$name;</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;modulename<sp/>=<sp/>$modulename;</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mv_table<sp/>=<sp/>$mv_table;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;query<sp/>=<sp/>$query;</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;comment<sp/>=<sp/>$comment;</highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Convert<sp/>the<sp/>schema<sp/>into<sp/>a<sp/>string<sp/>format.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$str_schema<sp/>=<sp/>var_export($mv_schema,<sp/>TRUE);</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$str_schema<sp/>=<sp/>preg_replace(</highlight><highlight class="stringliteral">&apos;/=&gt;\s+\n\s+array/&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;=&gt;<sp/>array&apos;</highlight><highlight class="normal">,<sp/>$str_schema);</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mv_schema<sp/>=<sp/>$str_schema;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>the<sp/>record<sp/>to<sp/>the<sp/>tripal_mviews<sp/>table<sp/>and<sp/>if<sp/>successful</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>create<sp/>the<sp/>new<sp/>materialized<sp/>view<sp/>in<sp/>the<sp/>chado<sp/>schema.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(drupal_write_record(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">,<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>))<sp/>{</highlight></codeline>
<codeline lineno="89"><highlight class="normal"></highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Drop<sp/>the<sp/>table<sp/>from<sp/>chado<sp/>if<sp/>it<sp/>exists.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="d4/d51/group__tripal__chado__schema__api_1ga432ffbbb35405f7ca897c9985e9d1bed" kindref="member">chado_table_exists</ref>($mv_table))<sp/>{</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;DROP<sp/>TABLE<sp/>{&apos;</highlight><highlight class="normal"><sp/>.<sp/>$mv_table<sp/>.<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>($sql);</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Create<sp/>the<sp/>table.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d4/d3f/group__tripal__custom__tables__api_1ga1f231a83ef5b725d87965df25ec42283" kindref="member">chado_create_custom_table</ref>($mv_table,<sp/>$mv_schema,<sp/>0,<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mview_id,<sp/>$redirect);</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>$e)<sp/>{</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$transaction-&gt;rollback();</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>watchdog_exception(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/>$e);</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$error<sp/>=<sp/>_drupal_decode_exception($e);</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,<sp/></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>create<sp/>the<sp/>materialized<sp/>view<sp/>%table_name:<sp/>%message.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;%table_name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$name,<sp/></highlight><highlight class="stringliteral">&apos;%message&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$error[</highlight><highlight class="stringliteral">&apos;!message&apos;</highlight><highlight class="normal">]));</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;Materialized<sp/>view<sp/>&apos;%name&apos;<sp/>created&quot;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$name)));</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;Materialized<sp/>view,<sp/>$name,<sp/>already<sp/>exists.<sp/>Skipping<sp/>creation.&quot;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$name)));</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="114"><highlight class="normal">}</highlight></codeline>
<codeline lineno="115"><highlight class="normal"></highlight></codeline>
<codeline lineno="149" refid="d0/de5/group__tripal__mviews__api_1ga8c1e8378e693283994ada0455f037147" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1ga8c1e8378e693283994ada0455f037147" kindref="member">chado_edit_mview</ref>($mview_id,<sp/>$name,<sp/>$modulename,<sp/>$mv_table,<sp/>$mv_specs,</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/>$indexed,<sp/>$query,<sp/>$special_index,<sp/>$comment<sp/>=<sp/>NULL,<sp/>$mv_schema<sp/>=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/>$transaction<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>the<sp/>table<sp/>name<sp/>from<sp/>the<sp/>schema<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/>$schema_arr<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($mv_schema)<sp/>{</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>the<sp/>schema<sp/>from<sp/>the<sp/>mv_specs<sp/>and<sp/>use<sp/>it<sp/>to<sp/>add<sp/>the<sp/>custom<sp/>table</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>eval(</highlight><highlight class="stringliteral">&quot;\$schema_arr<sp/>=<sp/>$mv_schema;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$mv_table<sp/>=<sp/>$schema_arr[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>stdClass();</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mview_id<sp/><sp/><sp/><sp/>=<sp/>$mview_id;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;name<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>$name;</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;modulename<sp/><sp/>=<sp/>$modulename;</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;query<sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>$query;</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;last_update<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;status<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;comment<sp/><sp/><sp/><sp/><sp/>=<sp/>$comment;</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mv_schema<sp/><sp/><sp/>=<sp/>$mv_schema;</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mv_table<sp/><sp/><sp/><sp/>=<sp/>$mv_table;</highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>update<sp/>the<sp/>record<sp/>to<sp/>the<sp/>tripal_mviews<sp/>table</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_write_record(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">,<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>,<sp/></highlight><highlight class="stringliteral">&apos;mview_id&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="175"><highlight class="normal"></highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>the<sp/>view<sp/>before<sp/>we<sp/>update<sp/>and<sp/>check<sp/>to<sp/>see<sp/>if<sp/>the<sp/>table<sp/>structure<sp/>has</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>changed.<sp/>If<sp/>so,<sp/>then<sp/>we<sp/>want<sp/>to<sp/>drop<sp/>and<sp/>recreate<sp/>the<sp/>table.<sp/>If<sp/>not,<sp/>then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>just<sp/>save<sp/>the<sp/>updated<sp/>SQL.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/>$create_table<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>*<sp/>FROM<sp/>{tripal_mviews}<sp/>WHERE<sp/>mview_id<sp/>=<sp/>:mview_id&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/>db_query($sql,<sp/>array(</highlight><highlight class="stringliteral">&apos;:mview_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$mview_id));</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/>$mview<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>-&gt;fetchObject();</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($mview-&gt;mv_schema<sp/>==<sp/>$mv_schema<sp/>and<sp/>$mview-&gt;mv_table<sp/>==<sp/>$mv_table)<sp/>{</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d4/d3f/group__tripal__custom__tables__api_1ga1f231a83ef5b725d87965df25ec42283" kindref="member">chado_create_custom_table</ref>($mv_table,<sp/>$schema_arr,<sp/>0,<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mview_id);</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;Materialized<sp/>view<sp/>&apos;%name&apos;<sp/>created&quot;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$name)));</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$message<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;View<sp/>&apos;%name&apos;<sp/>updated.<sp/><sp/>All<sp/>records<sp/>remain.<sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($query<sp/>!=<sp/>$mview-&gt;query)<sp/>{</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$message<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;Please<sp/>repopulate<sp/>the<sp/>view<sp/>to<sp/>use<sp/>the<sp/>updated<sp/>query.&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(t($message,<sp/>array(</highlight><highlight class="stringliteral">&apos;%name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$name)));</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="194"><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>construct<sp/>the<sp/>indexes<sp/>SQL<sp/>if<sp/>needed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/>$index<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($indexed)<sp/>{</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>to<sp/>the<sp/>array<sp/>of<sp/>values</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$vals<sp/>=<sp/>preg_split(</highlight><highlight class="stringliteral">&quot;/[\n,]+/&quot;</highlight><highlight class="normal">,<sp/>$indexed);</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$index<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($vals<sp/>as<sp/>$field)<sp/>{</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$field<sp/>=<sp/>trim($field);</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$index<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;CREATE<sp/>INDEX<sp/>idx_${mv_table}_${field}<sp/>ON<sp/>$mv_table<sp/>($field);&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="206"><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>$e)<sp/>{</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/>$transaction-&gt;rollback();</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/>watchdog_exception(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/>$e);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/>$error<sp/>=<sp/>_drupal_decode_exception($e);</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>update<sp/>materialized<sp/>view<sp/>&apos;%table_name&apos;:<sp/>%message.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;%table_name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$mv_table,<sp/></highlight><highlight class="stringliteral">&apos;%message&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$error[</highlight><highlight class="stringliteral">&apos;!message&apos;</highlight><highlight class="normal">])),<sp/></highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="216"><highlight class="normal">}</highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight></codeline>
<codeline lineno="229" refid="d0/de5/group__tripal__mviews__api_1gaf36270cbaaaafb46bf039707cddc2ba4" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1gaf36270cbaaaafb46bf039707cddc2ba4" kindref="member">chado_get_mview_id</ref>($view_name)<sp/>{</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(db_table_exists(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>*<sp/>FROM<sp/>{tripal_mviews}<sp/>WHERE<sp/>name<sp/>=<sp/>:name&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/>db_query($sql,<sp/>array(</highlight><highlight class="stringliteral">&apos;:name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$view_name));</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/>$mview<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>-&gt;fetchObject();</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($mview)<sp/>{</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$mview-&gt;mview_id;</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="238"><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="240"><highlight class="normal">}</highlight></codeline>
<codeline lineno="241"><highlight class="normal"></highlight></codeline>
<codeline lineno="250" refid="d0/de5/group__tripal__mviews__api_1ga3fc9f750c4b46202ec59cf7f8e785d6b" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1ga3fc9f750c4b46202ec59cf7f8e785d6b" kindref="member">chado_get_mview_table_names</ref>()<sp/>{</highlight></codeline>
<codeline lineno="251"><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>name<sp/>FROM<sp/>{tripal_mviews}&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/>$resource<sp/>=<sp/>db_query($sql);</highlight></codeline>
<codeline lineno="254"><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/>$tables<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($resource<sp/>as<sp/>$r)<sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/>$tables[$r-&gt;name]<sp/>=<sp/>$r-&gt;name;</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="259"><highlight class="normal"></highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/>asort($tables);</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$tables;</highlight></codeline>
<codeline lineno="262"><highlight class="normal">}</highlight></codeline>
<codeline lineno="263"><highlight class="normal"></highlight></codeline>
<codeline lineno="272" refid="d0/de5/group__tripal__mviews__api_1gab0ae59dbeaa76c54f0594437ab8b863a" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1gab0ae59dbeaa76c54f0594437ab8b863a" kindref="member">chado_refresh_mview</ref>($mview_id)<sp/>{</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/>global<sp/>$user;</highlight></codeline>
<codeline lineno="274"><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$mview_id)<sp/>{</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;Must<sp/>provide<sp/>an<sp/>mview_id<sp/>when<sp/>refreshing<sp/>an<sp/>mview.&apos;</highlight><highlight class="normal">,<sp/>array());</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="280"><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>this<sp/>mview<sp/>details.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>*<sp/>FROM<sp/>{tripal_mviews}<sp/>WHERE<sp/>mview_id<sp/>=<sp/>:mview_id&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/>db_query($sql,<sp/>array(</highlight><highlight class="stringliteral">&apos;:mview_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$mview_id));</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/>$mview<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>-&gt;fetchObject();</highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>a<sp/>job<sp/>to<sp/>populate<sp/>the<sp/>mview.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/>$args<sp/>=<sp/>array(</highlight><highlight class="stringliteral">&quot;$mview_id&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><ref refid="d0/db7/group__tripal__jobs__api_1gae7fa345a83829ddc37f727c8d04c02d6" kindref="member">tripal_add_job</ref>(</highlight><highlight class="stringliteral">&quot;Populate<sp/>materialized<sp/>view<sp/>&apos;$mview-&gt;name&apos;&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;chado_populate_mview&apos;</highlight><highlight class="normal">,<sp/>$args,<sp/>$user-&gt;uid);</highlight></codeline>
<codeline lineno="290"><highlight class="normal"></highlight></codeline>
<codeline lineno="291"><highlight class="normal">}</highlight></codeline>
<codeline lineno="292"><highlight class="normal"></highlight></codeline>
<codeline lineno="302" refid="d0/de5/group__tripal__mviews__api_1gaf802e5f630f43355ca5ad637bf9b251a" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1gaf802e5f630f43355ca5ad637bf9b251a" kindref="member">chado_get_mviews</ref>()<sp/>{</highlight></codeline>
<codeline lineno="303"><highlight class="normal"></highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/>db_select(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;tm&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(</highlight><highlight class="stringliteral">&apos;tm&apos;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;mview_id&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;name&apos;</highlight><highlight class="normal">))</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline lineno="307"><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/>$list<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>($mview<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>-&gt;fetchObject())<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/>$list[]<sp/>=<sp/>$mview;</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$list;</highlight></codeline>
<codeline lineno="313"><highlight class="normal">}</highlight></codeline>
<codeline lineno="314"><highlight class="normal"></highlight></codeline>
<codeline lineno="328" refid="d0/de5/group__tripal__mviews__api_1ga6b7bea36769a0eb69792bb03f5e326ef" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1ga6b7bea36769a0eb69792bb03f5e326ef" kindref="member">chado_delete_mview</ref>($mview_id)<sp/>{</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/>global<sp/>$user;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$mview_id)<sp/>{</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;Must<sp/>provide<sp/>an<sp/>mview_id<sp/>when<sp/>deleting<sp/>an<sp/>mview.&apos;</highlight><highlight class="normal">,<sp/>array());</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="336"><highlight class="normal"></highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/>$transaction<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>this<sp/>mview<sp/>details.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>*<sp/>FROM<sp/>{tripal_mviews}<sp/>WHERE<sp/>mview_id<sp/>=<sp/>:mview_id&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/>db_query($sql,<sp/>array(</highlight><highlight class="stringliteral">&apos;:mview_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$mview_id));</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/>$mview<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>-&gt;fetchObject();</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>op<sp/>is<sp/>to<sp/>delete<sp/>then<sp/>do<sp/>so.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>the<sp/>mview<sp/>from<sp/>the<sp/>tripal_mviews<sp/>table.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;DELETE<sp/>FROM<sp/>{tripal_mviews}<sp/>WHERE<sp/>mview_id<sp/>=<sp/>$mview_id&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/>db_query($sql);</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Does<sp/>the<sp/>table<sp/>already<sp/>exist?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/>$mview_exists<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga432ffbbb35405f7ca897c9985e9d1bed" kindref="member">chado_table_exists</ref>($mview-&gt;mv_table);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/></highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Drop<sp/>the<sp/>table<sp/>from<sp/>chado<sp/>if<sp/>it<sp/>exists.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($mview_exists)<sp/>{</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;DROP<sp/>TABLE<sp/>{&quot;</highlight><highlight class="normal"><sp/>.<sp/>$mview-&gt;mv_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;}&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$success<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>($sql);</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($success)<sp/>{</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;Materialized<sp/>view,<sp/>%name,<sp/>deleted.&quot;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$mview-&gt;name)));</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;Problem<sp/>deleting<sp/>materialized<sp/>view,<sp/>%name.&quot;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$mview-&gt;name)),<sp/></highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>$e)<sp/>{</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/>$transaction-&gt;rollback();</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/>watchdog_exception(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/>$e);</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/>$error<sp/>=<sp/>_drupal_decode_exception($e);</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>delete<sp/>the<sp/>materialized<sp/>view<sp/>%table_name:<sp/>%message.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;%table_name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$name,<sp/></highlight><highlight class="stringliteral">&apos;%message&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$error[</highlight><highlight class="stringliteral">&apos;!message&apos;</highlight><highlight class="normal">]));</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="379"><highlight class="normal">}</highlight></codeline>
<codeline lineno="380"><highlight class="normal"></highlight></codeline>
<codeline lineno="392" refid="d0/de5/group__tripal__mviews__api_1gafd288ceff53400702a7174ef2a35511e" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d0/de5/group__tripal__mviews__api_1gafd288ceff53400702a7174ef2a35511e" kindref="member">chado_populate_mview</ref>($mview_id)<sp/>{</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>*<sp/>FROM<sp/>{tripal_mviews}<sp/>WHERE<sp/>mview_id<sp/>=<sp/>:mview_id<sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/>db_query($sql,<sp/>array(</highlight><highlight class="stringliteral">&apos;:mview_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$mview_id));</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/>$mview<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>-&gt;fetchObject();</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($mview)<sp/>{</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Execute<sp/>the<sp/>query<sp/>inside<sp/>a<sp/>transaction<sp/>so<sp/>that<sp/>it<sp/>doesn&apos;t<sp/>destroy<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>existing<sp/>data<sp/>that<sp/>may<sp/>leave<sp/>parts<sp/>of<sp/>the<sp/>site<sp/>unfunctional.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/>$transaction<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/>$previous_db<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gab385af166be5f0707544ccbc18c3fe72" kindref="member">chado_set_active</ref>(</highlight><highlight class="stringliteral">&apos;chado&apos;</highlight><highlight class="normal">);<sp/><sp/></highlight><highlight class="comment">//<sp/>use<sp/>chado<sp/>database</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$success<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>(</highlight><highlight class="stringliteral">&quot;DELETE<sp/>FROM<sp/>{&quot;</highlight><highlight class="normal"><sp/>.<sp/>$mview-&gt;mv_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;}&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$success<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>(</highlight><highlight class="stringliteral">&quot;INSERT<sp/>INTO<sp/>{&quot;</highlight><highlight class="normal"><sp/>.<sp/>$mview-&gt;mv_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;}<sp/>($mview-&gt;query)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>success<sp/>get<sp/>the<sp/>number<sp/>of<sp/>results<sp/>and<sp/>update<sp/>the<sp/>table<sp/>record.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($success)<sp/>{</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>count(*)<sp/>as<sp/>cnt<sp/>FROM<sp/>{&quot;</highlight><highlight class="normal"><sp/>.<sp/>$mview-&gt;mv_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;}&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>($sql);</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$count<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>-&gt;fetchObject();</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>stdClass();</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mview_id<sp/>=<sp/>$mview_id;</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;last_update<sp/>=<sp/>time();</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;status<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Populated<sp/>with<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>number_format($count-&gt;cnt)<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;<sp/>rows&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_write_record(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">,<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>,<sp/></highlight><highlight class="stringliteral">&apos;mview_id&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>not<sp/>success<sp/>then<sp/>throw<sp/>an<sp/>error.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>Exception(</highlight><highlight class="stringliteral">&quot;ERROR<sp/>populating<sp/>the<sp/>materialized<sp/>view<sp/>&quot;</highlight><highlight class="normal">.<sp/>$mview-&gt;mv_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;.<sp/>See<sp/>Drupal&apos;s<sp/>recent<sp/>log<sp/>entries<sp/>for<sp/>details.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gab385af166be5f0707544ccbc18c3fe72" kindref="member">chado_set_active</ref>($previous_db);</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>$e)<sp/>{</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$transaction-&gt;rollback();</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gab385af166be5f0707544ccbc18c3fe72" kindref="member">chado_set_active</ref>($previous_db);</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Print<sp/>and<sp/>save<sp/>the<sp/>error<sp/>message.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>stdClass();</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;mview_id<sp/>=<sp/>$mview_id;</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;status<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;ERROR<sp/>populating<sp/>$mview-&gt;mv_table.<sp/>See<sp/>Drupal&apos;s<sp/>recent<sp/>log<sp/>entries<sp/>for<sp/>details.\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>drupal_write_record(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">,<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>,<sp/></highlight><highlight class="stringliteral">&apos;mview_id&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>watchdog_exception(</highlight><highlight class="stringliteral">&apos;tripal_mviews&apos;</highlight><highlight class="normal">,<sp/>$e);</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;Done.\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="435"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="tripal_chado/api/tripal_chado.mviews.api.inc"/>
  </compounddef>
</doxygen>

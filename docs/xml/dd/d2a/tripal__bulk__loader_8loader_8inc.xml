<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.15">
  <compounddef id="dd/d2a/tripal__bulk__loader_8loader_8inc" kind="file" language="PHP">
    <compoundname>tripal_bulk_loader.loader.inc</compoundname>
      <sectiondef kind="func">
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a61d49a349ec8bf8420e688c73955abc3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>process_data_array_for_line</definition>
        <argsstring>($priority, &amp;$data, &amp;$default_data, $addt)</argsstring>
        <name>process_data_array_for_line</name>
        <param>
          <declname>$priority</declname>
        </param>
        <param>
          <type>&amp;</type>
          <declname>$data</declname>
        </param>
        <param>
          <type>&amp;</type>
          <declname>$default_data</declname>
        </param>
        <param>
          <declname>$addt</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Process the data array for a given line</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$addt</parametername>
</parameternamelist>
<parameterdescription>
<para>Requires: field2column&apos;, &apos;record2priority&apos;, &apos;line&apos;, &apos;line_num&apos;, &apos;group_index&apos;, &apos;node&apos;, &apos;nid&apos; </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="491" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="491" bodyend="862"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1ad1535d34d616ebc2e5059247b78a2c68" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_add_foreignkey_to_values</definition>
        <argsstring>($table_array, $values, $data, $record2priority, $nid, $priority, $default_data)</argsstring>
        <name>tripal_bulk_loader_add_foreignkey_to_values</name>
        <param>
          <declname>$table_array</declname>
        </param>
        <param>
          <declname>$values</declname>
        </param>
        <param>
          <declname>$data</declname>
        </param>
        <param>
          <declname>$record2priority</declname>
        </param>
        <param>
          <declname>$nid</declname>
        </param>
        <param>
          <declname>$priority</declname>
        </param>
        <param>
          <declname>$default_data</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Handles foreign keys in the values array.</para><para>Specifically, if the value for a field is an array then it is assumed that the array contains the name of the record whose values array should be substituted here. Thus the foreign record is looked up and the values array is substituted in. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="909" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="909" bodyend="996"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a37387be2a90993522278b5c3ac34a699" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_add_loader_job_form</definition>
        <argsstring>($form, &amp;$form_state, $node)</argsstring>
        <name>tripal_bulk_loader_add_loader_job_form</name>
        <param>
          <declname>$form</declname>
        </param>
        <param>
          <type>&amp;</type>
          <declname>$form_state</declname>
        </param>
        <param>
          <declname>$node</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Add Loader Job Form</para><para>This form is meant to be included on the node page to allow users to submit/re-submit loading jobs </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="18" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="18" bodyend="61"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1ab4c78220ea99b1692e9eff584e6ade85" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_add_loader_job_form_submit</definition>
        <argsstring>($form, $form_state)</argsstring>
        <name>tripal_bulk_loader_add_loader_job_form_submit</name>
        <param>
          <declname>$form</declname>
        </param>
        <param>
          <declname>$form_state</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Add Loader Job Form (Submit) </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="68" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="68" bodyend="123"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a3f6c4d50cbf34a9c42ed3b888a82e9ef" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_add_spreadsheetdata_to_values</definition>
        <argsstring>($values, $line, $field2column)</argsstring>
        <name>tripal_bulk_loader_add_spreadsheetdata_to_values</name>
        <param>
          <declname>$values</declname>
        </param>
        <param>
          <declname>$line</declname>
        </param>
        <param>
          <declname>$field2column</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>This function adds the file data to the values array</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$values</parametername>
</parameternamelist>
<parameterdescription>
<para>The default values array -contains all constants </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$line</parametername>
</parameternamelist>
<parameterdescription>
<para>An array of values for the current line </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$field2column</parametername>
</parameternamelist>
<parameterdescription>
<para>An array mapping values fields to line columns </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Supplemented values array </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="878" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="878" bodyend="898"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a8e75f5e948ddf5dab63f2f77800b82da" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_finish_loading</definition>
        <argsstring>($nid, $loaded_without_errors)</argsstring>
        <name>tripal_bulk_loader_finish_loading</name>
        <param>
          <declname>$nid</declname>
        </param>
        <param>
          <declname>$loaded_without_errors</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Finishes the loading job by setting variables and exiting. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="1213" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="1213" bodyend="1231"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a10c50320f3b4b1709556e32a08d78fa9" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_flatten_array</definition>
        <argsstring>($values)</argsstring>
        <name>tripal_bulk_loader_flatten_array</name>
        <param>
          <declname>$values</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Flattens an array up to two levels Used for printing of arrays without taking up much space </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="1057" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="1057" bodyend="1080"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1ac1020f705b1cbf257bd31a6a9ede36f7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_load_data</definition>
        <argsstring>($nid, $job_id)</argsstring>
        <name>tripal_bulk_loader_load_data</name>
        <param>
          <declname>$nid</declname>
        </param>
        <param>
          <declname>$job_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Tripal Bulk Loader</para><para>This is the function that&apos;s run by tripal_launch_jobs to bulk load chado data.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$nid</parametername>
</parameternamelist>
<parameterdescription>
<para>The Node ID of the bulk loading job node to be loaded. All other needed data is expected to be in the node (ie: template ID and file)</para></parameterdescription>
</parameteritem>
</parameterlist>
Note: Instead of returning a value this function updates the tripal_bulk_loader.status. Errors are thrown through watchdog and can be viewed at admin/reports/dblog. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="139" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="139" bodyend="480"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a6295d053f208f0a93ff62995f96993cd" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_progress_bar</definition>
        <argsstring>($current=0, $total=100, $size=50)</argsstring>
        <name>tripal_bulk_loader_progress_bar</name>
        <param>
          <declname>$current</declname>
          <defval>0</defval>
        </param>
        <param>
          <declname>$total</declname>
          <defval>100</defval>
        </param>
        <param>
          <declname>$size</declname>
          <defval>50</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Used to display loader progress to the user </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="1087" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="1087" bodyend="1139"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a984a22a1a599ccdfbc92228c4da38205" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_progress_file_track_job</definition>
        <argsstring>($job_id, $record_added, $line_complete=FALSE, $close=FALSE)</argsstring>
        <name>tripal_bulk_loader_progress_file_track_job</name>
        <param>
          <declname>$job_id</declname>
        </param>
        <param>
          <declname>$record_added</declname>
        </param>
        <param>
          <declname>$line_complete</declname>
          <defval>FALSE</defval>
        </param>
        <param>
          <declname>$close</declname>
          <defval>FALSE</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Keep track of progress in file rather then database</para><para>This provides an alternative method to keep track of progress that doesn&apos;t require the database. It was needed because you can&apos;t switch databases within a transaction... Waiting until the end of a constant set is much too long to wait for any indication that things are working.</para><para>Each line represents a line processed in the loading file. Each period (.) represents a successfully inserted record.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$job_id</parametername>
</parameternamelist>
<parameterdescription>
<para>The ID of the current tripal job </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$record_added</parametername>
</parameternamelist>
<parameterdescription>
<para>A boolean indicated whether a record was added successfully </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$line_complete</parametername>
</parameternamelist>
<parameterdescription>
<para>A boolean indicating whether the current line is finished </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$close</parametername>
</parameternamelist>
<parameterdescription>
<para>A boolean indicating that the file should be closed </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="1163" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="1163" bodyend="1186"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1aba46b252142760b713ed73150e11295c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_regex_tranform_values</definition>
        <argsstring>($values, $table_data, $line)</argsstring>
        <name>tripal_bulk_loader_regex_tranform_values</name>
        <param>
          <declname>$values</declname>
        </param>
        <param>
          <declname>$table_data</declname>
        </param>
        <param>
          <declname>$line</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Uses a supplied regex to transform spreadsheet values</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$values</parametername>
</parameternamelist>
<parameterdescription>
<para>The select/insert values array for the given table </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$table_data</parametername>
</parameternamelist>
<parameterdescription>
<para>The data array for the given table </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="1008" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="1008" bodyend="1049"/>
      </memberdef>
      <memberdef kind="function" id="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>tripal_bulk_loader_throw_error</definition>
        <argsstring>($msg, $args, $severity)</argsstring>
        <name>tripal_bulk_loader_throw_error</name>
        <param>
          <declname>$msg</declname>
        </param>
        <param>
          <declname>$args</declname>
        </param>
        <param>
          <declname>$severity</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Used to throw a hopefully human-readable error. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" line="1193" column="1" bodyfile="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc" bodystart="1193" bodyend="1206"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
<para>Handles the actual loading of data. </para>    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal">&lt;?php</highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="18" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a37387be2a90993522278b5c3ac34a699" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a37387be2a90993522278b5c3ac34a699" kindref="member">tripal_bulk_loader_add_loader_job_form</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>,<sp/>&amp;$form_state,<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>)<sp/>{</highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref><sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>--notify--</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;job_status<sp/>==<sp/></highlight><highlight class="stringliteral">&apos;Loading...&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="23"><highlight class="normal"><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;The<sp/>Loading<sp/>Summary<sp/>only<sp/>updates<sp/>at<sp/>the<sp/>end<sp/>of<sp/>each<sp/>constant<sp/>set.</highlight></codeline>
<codeline lineno="24"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/>Although<sp/>records<sp/>may<sp/>have<sp/>already<sp/>been<sp/>inserted,<sp/>they<sp/>won&apos;t<sp/>be<sp/>available<sp/>until<sp/>the</highlight></codeline>
<codeline lineno="25"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/>current<sp/>constant<sp/>set<sp/>is<sp/>full<sp/>loaded<sp/>and<sp/>no<sp/>errors<sp/>are<sp/>encountered.&quot;</highlight><highlight class="normal">,<sp/>array()),<sp/></highlight><highlight class="stringliteral">&apos;warning&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>[</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">]<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#type&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;hidden&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#value&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;nid,</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>[</highlight><highlight class="stringliteral">&apos;file&apos;</highlight><highlight class="normal">]<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#type&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;hidden&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#value&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;file</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>[</highlight><highlight class="stringliteral">&apos;job_id&apos;</highlight><highlight class="normal">]<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#type&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;hidden&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#value&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;job_id,</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>[</highlight><highlight class="stringliteral">&apos;submit&apos;</highlight><highlight class="normal">]<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#type&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;submit&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#value&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;job_id)<sp/>?<sp/></highlight><highlight class="stringliteral">&apos;Re-Submit<sp/>Job&apos;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&apos;Submit<sp/>Job&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="47"><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>[</highlight><highlight class="stringliteral">&apos;submit-cancel&apos;</highlight><highlight class="normal">]<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#type&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;job_id)?<sp/></highlight><highlight class="stringliteral">&apos;submit&apos;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&apos;hidden&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#value&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;Cancel<sp/>Job&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;keep_track_inserted)<sp/>{</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>[</highlight><highlight class="stringliteral">&apos;submit-revert&apos;</highlight><highlight class="normal">]<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#type&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;job_id)<sp/>?<sp/></highlight><highlight class="stringliteral">&apos;submit&apos;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&apos;hidden&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;#value&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;Revert&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>;</highlight></codeline>
<codeline lineno="61"><highlight class="normal">}</highlight></codeline>
<codeline lineno="62"><highlight class="normal"></highlight></codeline>
<codeline lineno="68" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1ab4c78220ea99b1692e9eff584e6ade85" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1ab4c78220ea99b1692e9eff584e6ade85" kindref="member">tripal_bulk_loader_add_loader_job_form_submit</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a24227bb4b9c4c11f6f138476251ff34c" kindref="member">$form</ref>,<sp/>$form_state)<sp/>{</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/>global<sp/>$user;</highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/Submit<sp/>Job/&apos;</highlight><highlight class="normal">,<sp/>$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;op&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//Submit<sp/>Tripal<sp/>Job</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/>$job_args[1]<sp/>=<sp/>$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_readable($form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;file&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$fname<sp/>=<sp/>basename($form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;file&apos;</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job_id<sp/>=<sp/><ref refid="d0/db7/group__tripal__jobs__api_1gae7fa345a83829ddc37f727c8d04c02d6" kindref="member">tripal_add_job</ref>(</highlight><highlight class="stringliteral">&quot;Bulk<sp/>Loading<sp/>Job:<sp/>$fname&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;tripal_bulk_loader&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_load_data&apos;</highlight><highlight class="normal">,<sp/>$job_args,<sp/>$user-&gt;uid);</highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>job_id<sp/>to<sp/>bulk_loader<sp/>node</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$success<sp/>=<sp/>db_update(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader&apos;</highlight><highlight class="normal">)-&gt;fields(array(</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;job_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$job_id,</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;job_status&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;Submitted<sp/>to<sp/>Queue&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>))-&gt;condition(</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">,$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">])-&gt;execute();</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&quot;Can<sp/>not<sp/>open<sp/>%file.<sp/>Job<sp/>not<sp/>scheduled.&quot;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%file&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;file&apos;</highlight><highlight class="normal">])));</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/>elseif<sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/Re-Submit<sp/>Job/&apos;</highlight><highlight class="normal">,<sp/>$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;op&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d0/db7/group__tripal__jobs__api_1ga3b535cc716ccea28d82c0bd274a3efa7" kindref="member">tripal_rerun_job</ref>($form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;job_id&apos;</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/>$success<sp/>=<sp/>db_update(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader&apos;</highlight><highlight class="normal">)-&gt;fields(array(</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;job_status&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;Submitted<sp/>to<sp/>Queue&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>))-&gt;condition(</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">,$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">])-&gt;execute();</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/>elseif<sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/Cancel<sp/>Job/&apos;</highlight><highlight class="normal">,<sp/>$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;op&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/>$success<sp/>=<sp/>db_update(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader&apos;</highlight><highlight class="normal">)-&gt;fields(array(</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;job_status&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;Job<sp/>Cancelled&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>))-&gt;condition(</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">,$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">])-&gt;execute();</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d0/db7/group__tripal__jobs__api_1ga7d1baa38344008ac242385fbabca10c5" kindref="member">tripal_cancel_job</ref>($form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;job_id&apos;</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/>elseif<sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/Revert/&apos;</highlight><highlight class="normal">,<sp/>$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;op&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>the<sp/>records<sp/>from<sp/>the<sp/>database<sp/>that<sp/>were<sp/>already<sp/>inserted</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/>$resource<sp/>=<sp/>db_query(</highlight><highlight class="stringliteral">&apos;SELECT<sp/>*<sp/>FROM<sp/>{tripal_bulk_loader_inserted}<sp/>WHERE<sp/>nid=:nid<sp/>ORDER<sp/>BY<sp/>tripal_bulk_loader_inserted_id<sp/>DESC&apos;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;:nid&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">]));</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>($r<sp/>=<sp/>$resource-&gt;fetchObject())<sp/>{</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$ids<sp/>=<sp/>preg_split(</highlight><highlight class="stringliteral">&apos;/,/&apos;</highlight><highlight class="normal">,<sp/>$r-&gt;ids_inserted);</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>db_query(</highlight><highlight class="stringliteral">&apos;DELETE<sp/>FROM<sp/>{&apos;</highlight><highlight class="normal">.$r-&gt;table_inserted_into.</highlight><highlight class="stringliteral">&apos;}<sp/>WHERE<sp/>&apos;</highlight><highlight class="normal">.$r-&gt;table_primary_key.</highlight><highlight class="stringliteral">&apos;<sp/>IN<sp/>(&apos;</highlight><highlight class="normal">.$r-&gt;ids_inserted.</highlight><highlight class="charliteral">&apos;)&apos;</highlight><highlight class="normal">)-&gt;execute();</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$result<sp/>=<sp/>db_query(</highlight><highlight class="stringliteral">&apos;SELECT<sp/>true<sp/>as<sp/>present<sp/>FROM<sp/>{&apos;</highlight><highlight class="normal">.$r-&gt;table_inserted_into.</highlight><highlight class="stringliteral">&apos;}<sp/>WHERE<sp/>&apos;</highlight><highlight class="normal">.$r-&gt;table_primary_key.</highlight><highlight class="stringliteral">&apos;<sp/>IN<sp/>(&apos;</highlight><highlight class="normal">.$r-&gt;ids_inserted.</highlight><highlight class="charliteral">&apos;)&apos;</highlight><highlight class="normal">)-&gt;fetchObject();</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$result-&gt;present)<sp/>{</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&apos;Successfully<sp/>Removed<sp/>data<sp/>Inserted<sp/>into<sp/>the<sp/>%tableto<sp/>table.&apos;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%tableto&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$r-&gt;table_inserted_into)));</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db_query(</highlight><highlight class="stringliteral">&apos;DELETE<sp/>FROM<sp/>{tripal_bulk_loader_inserted}<sp/>WHERE<sp/>tripal_bulk_loader_inserted_id=:id&apos;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;:id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$r-&gt;tripal_bulk_loader_inserted_id))-&gt;execute();</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(t(</highlight><highlight class="stringliteral">&apos;Unable<sp/>to<sp/>remove<sp/>data<sp/>Inserted<sp/>into<sp/>the<sp/>%tableto<sp/>table!&apos;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;%tableto&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$r-&gt;table_inserted_into)),<sp/></highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reset<sp/>status</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/>$success<sp/>=<sp/>db_update(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader&apos;</highlight><highlight class="normal">)-&gt;fields(array(</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;job_status&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;Reverted<sp/>-Data<sp/>Deleted&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>))-&gt;condition(</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">,$form_state[</highlight><highlight class="stringliteral">&apos;values&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">])-&gt;execute();</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="122"><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal">}</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="139" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1ac1020f705b1cbf257bd31a6a9ede36f7" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1ac1020f705b1cbf257bd31a6a9ede36f7" kindref="member">tripal_bulk_loader_load_data</ref>($nid,<sp/>$job_id)<sp/>{</highlight></codeline>
<codeline lineno="140"><highlight class="normal"></highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>ensure<sp/>no<sp/>timeout</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/>drupal_set_time_limit(0);</highlight></codeline>
<codeline lineno="143"><highlight class="normal"></highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>the<sp/>status<sp/>of<sp/>the<sp/>job<sp/>(in<sp/>the<sp/>node<sp/>not<sp/>the<sp/>tripal<sp/>jobs)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/>db_update(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(array(</highlight><highlight class="stringliteral">&apos;job_status&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;Loading...&apos;</highlight><highlight class="normal">))</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">,<sp/>$nid)</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref><sp/>=<sp/>node_load($nid);</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;Template:<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;template-&gt;name<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;<sp/>(&quot;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;template_id<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;)\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>the<sp/>total<sp/>number<sp/>of<sp/>lines<sp/>in<sp/>the<sp/>file.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/>$total_lines<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/>$handle<sp/>=<sp/>fopen(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;file,<sp/></highlight><highlight class="stringliteral">&quot;r&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(!feof($handle)){</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/>$line<sp/>=<sp/>fgets($handle);</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/>$total_lines++;</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/>fclose($handle);</highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Correct<sp/>for<sp/>files<sp/>with<sp/>a<sp/>single<sp/>line<sp/>and<sp/>no<sp/>enter<sp/>character.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/>$total_lines<sp/>=<sp/>($total_lines<sp/>==<sp/>0)<sp/>?<sp/>1<sp/>:<sp/>$total_lines;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;File:<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;file<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;<sp/>(&quot;</highlight><highlight class="normal"><sp/>.<sp/>$total_lines<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;<sp/>lines)\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="165"><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//print<sp/>&quot;\nClearing<sp/>all<sp/>prepared<sp/>statements<sp/>from<sp/>previous<sp/>runs<sp/>of<sp/>this<sp/>loader...\n&quot;;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//tripal_core_chado_clear_prepared(&apos;_&apos;.$node-&gt;nid.&apos;_&apos;);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Prep<sp/>Work<sp/>==================================================================================</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\nPreparing<sp/>to<sp/>load...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/>$loaded_without_errors<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Generate<sp/>default<sp/>values<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/>$default_data<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/>$field2column<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/>$record2priority<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/>$tables<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/>$template_array<sp/>=<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;template-&gt;template_array;</highlight></codeline>
<codeline lineno="179"><highlight class="normal"></highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>first<sp/>build<sp/>the<sp/>record2priority<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($template_array<sp/>as<sp/>$priority<sp/>=&gt;<sp/>$record_array)<sp/>{</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/>$record2priority[$record_array[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$priority;</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="184"><highlight class="normal"></highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($template_array<sp/>as<sp/>$priority<sp/>=&gt;<sp/>$record_array)<sp/>{</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!is_array($record_array))<sp/>{</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>tables<sp/>being<sp/>inserted<sp/>into<sp/>to<sp/>a<sp/>list<sp/>to<sp/>be<sp/>treated<sp/>differently</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>is<sp/>used<sp/>to<sp/>acquire<sp/>locks<sp/>on<sp/>these<sp/>tables</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/insert/&apos;</highlight><highlight class="normal">,<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$tables[$record_array[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="196"><highlight class="normal"></highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>iterate<sp/>through<sp/>each<sp/>of<sp/>the<sp/>fields<sp/>for<sp/>the<sp/>current<sp/>record<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>the<sp/>default_data<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($record_array[</highlight><highlight class="stringliteral">&apos;fields&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$field_index<sp/>=&gt;<sp/>$field_array)<sp/>{</highlight></codeline>
<codeline lineno="200"><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>=<sp/>($record_array[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">])<sp/>?<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>:<sp/></highlight><highlight class="stringliteral">&apos;insert&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;select_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>=<sp/>($record_array[</highlight><highlight class="stringliteral">&apos;select_if_duplicate&apos;</highlight><highlight class="normal">])<sp/>?<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;select_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;update_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>=<sp/>($record_array[</highlight><highlight class="stringliteral">&apos;update_if_duplicate&apos;</highlight><highlight class="normal">])<sp/>?<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;update_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;disabled&apos;</highlight><highlight class="normal">]<sp/>=<sp/>($record_array[</highlight><highlight class="stringliteral">&apos;disable&apos;</highlight><highlight class="normal">])<sp/>?<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;disable&apos;</highlight><highlight class="normal">]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;optional&apos;</highlight><highlight class="normal">]<sp/>=<sp/>($record_array[</highlight><highlight class="stringliteral">&apos;optional&apos;</highlight><highlight class="normal">])<sp/>?<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;optional&apos;</highlight><highlight class="normal">]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;select_optional&apos;</highlight><highlight class="normal">]<sp/>=<sp/>($record_array[</highlight><highlight class="stringliteral">&apos;select_optional&apos;</highlight><highlight class="normal">])<sp/>?<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;select_optional&apos;</highlight><highlight class="normal">]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$record_array[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;required&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;required&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="210"><highlight class="normal"></highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$one<sp/>=<sp/>$default_data[$priority];</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(isset($field_array[</highlight><highlight class="stringliteral">&apos;regex&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;regex_transform&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;regex&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="215"><highlight class="normal"></highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$two<sp/>=<sp/>$default_data[$priority];</highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/table<sp/>field/&apos;</highlight><highlight class="normal">,<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;type&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;need_further_processing&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$field2column[$priority][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;spreadsheet<sp/>column&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>elseif<sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/constant/&apos;</highlight><highlight class="normal">,<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;type&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;constant<sp/>value&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="226"><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>elseif<sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/foreign<sp/>key/&apos;</highlight><highlight class="normal">,<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;type&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;need_further_processing&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]][</highlight><highlight class="stringliteral">&apos;foreign<sp/>record&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;record&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;foreign<sp/>key&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="232"><highlight class="normal"></highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>in<sp/>the<sp/>FK<sp/>/<sp/>Referral<sp/>table</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$fk_priority<sp/>=<sp/>$record2priority[$field_array[</highlight><highlight class="stringliteral">&apos;foreign<sp/>key&apos;</highlight><highlight class="normal">]];</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$fk_table<sp/>=<sp/>$template_array[$fk_priority][</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]][</highlight><highlight class="stringliteral">&apos;foreign<sp/>record&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$fk_table;</highlight></codeline>
<codeline lineno="237"><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>in<sp/>the<sp/>FK<sp/>/<sp/>Referral<sp/>field</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>backwards<sp/>compatibility<sp/>we<sp/>need<sp/>to<sp/>get<sp/>the<sp/>FK<sp/>relationship<sp/>to<sp/>find</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>out<sp/>what<sp/>field<sp/>we&apos;re<sp/>joining<sp/>on.<sp/><sp/>For<sp/>templates<sp/>created<sp/>using<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>previous<sp/>version<sp/>it<sp/>was<sp/>assumed<sp/>that<sp/>the<sp/>FK<sp/>field<sp/>was<sp/>always<sp/>the<sp/>field<sp/>to<sp/>join</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;foreign<sp/>field&apos;</highlight><highlight class="normal">,<sp/>$field_array))<sp/>{</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$tbl_description<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>($record_array[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($tbl_description[</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$key_table<sp/>=&gt;<sp/>$key_array)<sp/>{</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($key_table<sp/>==<sp/>$fk_table)<sp/>{</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($key_array[</highlight><highlight class="stringliteral">&apos;columns&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$left_field<sp/>=&gt;<sp/>$right_field)<sp/>{</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($left_field<sp/>==<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">])<sp/>{</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$field_array[</highlight><highlight class="stringliteral">&apos;foreign<sp/>field&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$right_field;</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]][</highlight><highlight class="stringliteral">&apos;foreign<sp/>record&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;foreign<sp/>field&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&apos;WARNING:<sp/>Unsupported<sp/>type:<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;type&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>for<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal"><sp/>.<sp/>$field_array[</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;!\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$three<sp/>=<sp/>$default_data[$priority];</highlight></codeline>
<codeline lineno="260"><highlight class="normal"></highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>end<sp/>of<sp/>foreach<sp/>field</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="comment">//end<sp/>of<sp/>foreach<sp/>record</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="263"><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>each<sp/>set<sp/>of<sp/>constants</highlight></codeline>
<codeline lineno="267"><highlight class="comment"></highlight><highlight class="normal"><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;Loading...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/>$original_default_data<sp/>=<sp/>$default_data;</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/>$group_index<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/>$total_num_groups<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;constants);</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>there<sp/>are<sp/>no<sp/>constant<sp/>sets<sp/>and<sp/>no<sp/>exposed<sp/>fields</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>then<sp/>create<sp/>an<sp/>empty<sp/>constant<sp/>set<sp/>so<sp/>loader<sp/>runs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($total_num_groups<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>empty(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;exposed_fields))<sp/>{</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;constants<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>0<sp/>=&gt;<sp/>array()</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/>$total_num_groups<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;constants<sp/>as<sp/>$group_id<sp/>=&gt;<sp/>$set)<sp/>{</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>revert<sp/>default<sp/>data<sp/>array<sp/>for<sp/>next<sp/>set<sp/>of<sp/>constants</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/>$default_data<sp/>=<sp/>$original_default_data;</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/>$group_index++;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>constants</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!empty($set))<sp/>{</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;Constants:\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($set<sp/>as<sp/>$priority<sp/>=&gt;<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>)<sp/>{</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>as<sp/>$field_id<sp/>=&gt;<sp/>$field)<sp/>{</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\t-<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$field[</highlight><highlight class="stringliteral">&apos;chado_table&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal"><sp/>.<sp/>$field[</highlight><highlight class="stringliteral">&apos;chado_field&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>=<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$field[</highlight><highlight class="stringliteral">&apos;value&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="291"><highlight class="normal"></highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($default_data[$priority][</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">]<sp/>==<sp/>$field[</highlight><highlight class="stringliteral">&apos;chado_table&apos;</highlight><highlight class="normal">])<sp/>{</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(isset($default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field[</highlight><highlight class="stringliteral">&apos;chado_field&apos;</highlight><highlight class="normal">]]))<sp/>{</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(isset($field2column[$priority][$field[</highlight><highlight class="stringliteral">&apos;chado_field&apos;</highlight><highlight class="normal">]]))<sp/>{</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$field2column[$priority][$field[</highlight><highlight class="stringliteral">&apos;chado_field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$field[</highlight><highlight class="stringliteral">&apos;value&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">][$field[</highlight><highlight class="stringliteral">&apos;chado_field&apos;</highlight><highlight class="normal">]]<sp/>=<sp/>$field[</highlight><highlight class="stringliteral">&apos;value&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;ERROR:<sp/>Template<sp/>has<sp/>changed<sp/>after<sp/>constants<sp/>were<sp/>assigned!\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>(</highlight><highlight class="stringliteral">&apos;Template<sp/>has<sp/>changed<sp/>after<sp/>constants<sp/>were<sp/>assigned&apos;</highlight><highlight class="normal">,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1ad9759873be1ae0c3d8ccc37d121aeb3c" kindref="member">TRIPAL_NOTICE</ref>);</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exit(1);</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;ERROR:<sp/>Template<sp/>has<sp/>changed<sp/>after<sp/>constants<sp/>were<sp/>assigned!\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>(</highlight><highlight class="stringliteral">&apos;Template<sp/>has<sp/>changed<sp/>after<sp/>constants<sp/>were<sp/>assigned&apos;</highlight><highlight class="normal">,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1ad9759873be1ae0c3d8ccc37d121aeb3c" kindref="member">TRIPAL_NOTICE</ref>);</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exit(1);</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="315"><highlight class="normal"></highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Open<sp/>File</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\tPreparing<sp/>to<sp/>load<sp/>the<sp/>current<sp/>constant<sp/>set...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\t\tOpen<sp/>File...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$file<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>SplFileObject(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;file,<sp/></highlight><highlight class="charliteral">&apos;r&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>$e)<sp/>{</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>(</highlight><highlight class="stringliteral">&apos;Could<sp/>not<sp/>open<sp/>file<sp/>%file&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;%file&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;file),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>);</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="327"><highlight class="normal"></highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>defaults</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d8/d21/tripal__bulk__loader__modify__template__base__form__fields_8tpl_8php_1a4f44601f2b9dc8a1644bce53c94ce622" kindref="member">$header</ref><sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/(t|true|1)/&apos;</highlight><highlight class="normal">,<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;file_has_header))<sp/>{</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$file-&gt;next();</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d8/d21/tripal__bulk__loader__modify__template__base__form__fields_8tpl_8php_1a4f44601f2b9dc8a1644bce53c94ce622" kindref="member">$header</ref><sp/>=<sp/>$file-&gt;current();</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/>$num_records<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/>$num_lines<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/>$num_errors<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/>$interval<sp/>=<sp/>intval($total_lines<sp/>*<sp/>0.0001);</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($interval<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$interval<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="341"><highlight class="normal"></highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>Transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/>$savepoint<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(variable_get(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_transactions&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;row&apos;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;none&quot;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;all&quot;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\t\tStart<sp/>Transaction...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$TRANSACTION<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$transactions<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;row&quot;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\t\tStart<sp/>Transaction...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$TRANSACTION<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$transactions<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$new_transaction_per_row<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="359"><highlight class="normal"></highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disable<sp/>triggers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/>$triggers_disabled<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($transactions<sp/>AND<sp/>variable_get(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_disable_triggers&apos;</highlight><highlight class="normal">,<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\t\tDefer<sp/>Constraints...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$triggers_disabled<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>(</highlight><highlight class="stringliteral">&quot;SET<sp/>CONSTRAINTS<sp/>ALL<sp/>DEFERRED&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="367"><highlight class="normal"></highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Acquire<sp/>Locks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($transactions)<sp/>{</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\t\tAcquiring<sp/>Table<sp/>Locks...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$lockmode<sp/>=<sp/>variable_get(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_lock&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;ROW<sp/>EXCLUSIVE&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($tables<sp/>as<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>)<sp/>{</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\t\t\t$lockmode<sp/>for<sp/>$table\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>(</highlight><highlight class="stringliteral">&quot;LOCK<sp/>TABLE<sp/>{&quot;</highlight><highlight class="normal">.<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>.</highlight><highlight class="stringliteral">&quot;}<sp/>IN<sp/>&quot;</highlight><highlight class="normal">.$lockmode.</highlight><highlight class="stringliteral">&quot;<sp/>MODE&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="377"><highlight class="normal"></highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\tLoading<sp/>the<sp/>current<sp/>constant<sp/>set...\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a6295d053f208f0a93ff62995f96993cd" kindref="member">tripal_bulk_loader_progress_bar</ref>(0,<sp/>$total_lines);</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!$file-&gt;eof())<sp/>{</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$file-&gt;next();</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$raw_line<sp/>=<sp/>$file-&gt;current();</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$raw_line<sp/>=<sp/>trim($raw_line);</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(empty($raw_line))<sp/>{</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>skips<sp/>blank<sp/>lines</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$line<sp/>=<sp/>explode(</highlight><highlight class="stringliteral">&quot;\t&quot;</highlight><highlight class="normal">,<sp/>$raw_line);</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$num_lines++;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"></highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>update<sp/>the<sp/>job<sp/>status<sp/>every<sp/>1%<sp/>of<sp/>lines<sp/>processed<sp/>for<sp/>the<sp/>current<sp/>group</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;job_id<sp/>and<sp/>$num_lines<sp/>%<sp/>$interval<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="392"><highlight class="normal"></highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>percentage<sp/>of<sp/>lines<sp/>processed<sp/>for<sp/>the<sp/>current<sp/>group</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$group_progress<sp/>=<sp/>round(($num_lines<sp/>/<sp/>$total_lines)<sp/>*<sp/>100);</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a6295d053f208f0a93ff62995f96993cd" kindref="member">tripal_bulk_loader_progress_bar</ref>($num_lines,<sp/>$total_lines);</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>percentage<sp/>of<sp/>lines<sp/>processed<sp/>for<sp/>all<sp/>groups</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>&lt;previous<sp/>group<sp/>index&gt;<sp/>*<sp/>100<sp/>+<sp/>&lt;current<sp/>group<sp/>progress&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>--------------------------------------------------------</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;total<sp/>number<sp/>of<sp/>groups&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>example,<sp/>if<sp/>you<sp/>were<sp/>in<sp/>the<sp/>third<sp/>group<sp/>of<sp/>3<sp/>constant<sp/>sets</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>had<sp/>a<sp/>group<sp/>percentage<sp/>of<sp/>50%<sp/>then<sp/>the<sp/>job<sp/>progress<sp/>would<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(2*100<sp/>+<sp/>50%)<sp/>/<sp/>3<sp/>=<sp/>250%/3<sp/>=<sp/>83%</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$job_progress<sp/>=<sp/>round(((($group_index<sp/>-<sp/>1)<sp/>*<sp/>100)<sp/>+<sp/>$group_progress)<sp/>/<sp/>$total_num_groups);</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d0/db7/group__tripal__jobs__api_1ga9d47a24fd67bb0434432d6f10f2d1054" kindref="member">tripal_set_job_progress</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;job_id,<sp/>$job_progress);</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="407"><highlight class="normal"></highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$data<sp/>=<sp/>$default_data;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"></highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>iterate<sp/>through<sp/>each<sp/>record<sp/>and<sp/>process<sp/>the<sp/>line</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$data_keys<sp/>=<sp/>array_keys($data);</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($data_keys<sp/>as<sp/>$priority)<sp/>{</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref><sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;field2column&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$field2column,</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;record2priority&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$record2priority,</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;line&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$line,</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;line_num&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$num_lines,</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;group_index&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$group_index,</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;node&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>,</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;nid,</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight></codeline>
<codeline lineno="423"><highlight class="normal"></highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>execute<sp/>all<sp/>records<sp/>that<sp/>are<sp/>not<sp/>disabled</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists($priority,<sp/>$data)<sp/>and</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array_key_exists(</highlight><highlight class="stringliteral">&apos;disabled&apos;</highlight><highlight class="normal">,<sp/>$data[$priority])<sp/>and</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;disabled&apos;</highlight><highlight class="normal">]<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a61d49a349ec8bf8420e688c73955abc3" kindref="member">process_data_array_for_line</ref>($priority,<sp/>$data,<sp/>$default_data,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>);</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>status<sp/>to<sp/>true<sp/>for<sp/>skipped<sp/>records</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="435"><highlight class="normal"></highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a984a22a1a599ccdfbc92228c4da38205" kindref="member">tripal_bulk_loader_progress_file_track_job</ref>($job_id,<sp/>$no_errors);</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$failed<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($no_errors<sp/>==<sp/>FALSE)<sp/>{</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Encountered<sp/>an<sp/>error</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($transactions)<sp/>{</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$TRANSACTION-&gt;rollback();</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a8e75f5e948ddf5dab63f2f77800b82da" kindref="member">tripal_bulk_loader_finish_loading</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;nid,<sp/>FALSE);</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>end<sp/>of<sp/>foreach<sp/>table<sp/>in<sp/>default<sp/>data<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="447"><highlight class="normal"></highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a984a22a1a599ccdfbc92228c4da38205" kindref="member">tripal_bulk_loader_progress_file_track_job</ref>($job_id,<sp/>FALSE,<sp/>TRUE);</highlight></codeline>
<codeline lineno="449"><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($failed)<sp/>{</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$TRANSACTION-&gt;rollback();</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a8e75f5e948ddf5dab63f2f77800b82da" kindref="member">tripal_bulk_loader_finish_loading</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;nid,<sp/>FALSE);</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Row<sp/>inserted<sp/>successfully</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($transactions<sp/>&amp;&amp;<sp/>$new_transaction_per_row)<sp/>{</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>commit<sp/>current<sp/>transaction<sp/>and<sp/>start<sp/>a<sp/>new<sp/>one</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset($TRANSACTION);</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$TRANSACTION<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//end<sp/>of<sp/>foreach<sp/>line<sp/>of<sp/>file</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="464"><highlight class="normal"></highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>END<sp/>Transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($transactions)<sp/>{</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>unset($TRANSACTION);</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="469"><highlight class="normal"></highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($failed)<sp/>{</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$loaded_without_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a6295d053f208f0a93ff62995f96993cd" kindref="member">tripal_bulk_loader_progress_bar</ref>($total_lines,<sp/>$total_lines);</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a984a22a1a599ccdfbc92228c4da38205" kindref="member">tripal_bulk_loader_progress_file_track_job</ref>($job_id,<sp/>FALSE,<sp/>FALSE,<sp/>TRUE);</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="comment">//end<sp/>of<sp/>foreach<sp/>constant<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="477"><highlight class="normal"></highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a8e75f5e948ddf5dab63f2f77800b82da" kindref="member">tripal_bulk_loader_finish_loading</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1a15955933e72700564e1a76d7f97c1ac7" kindref="member">$node</ref>-&gt;nid,<sp/>$loaded_without_errors);</highlight></codeline>
<codeline lineno="479"><highlight class="normal"></highlight></codeline>
<codeline lineno="480"><highlight class="normal">}</highlight></codeline>
<codeline lineno="481"><highlight class="normal"></highlight></codeline>
<codeline lineno="491" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a61d49a349ec8bf8420e688c73955abc3" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a61d49a349ec8bf8420e688c73955abc3" kindref="member">process_data_array_for_line</ref>($priority,<sp/>&amp;$data,<sp/>&amp;$default_data,<sp/>$addt)<sp/>{</highlight></codeline>
<codeline lineno="492"><highlight class="normal"></highlight><highlight class="comment">//$time_start<sp/>=<sp/>microtime(true);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="493"><highlight class="normal"></highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/>$table_data<sp/>=<sp/>$data[$priority];</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/>$addt<sp/>=<sp/>(object)<sp/>$addt;</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/>$no_errors<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="497"><highlight class="normal"></highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>=<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>=<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="500"><highlight class="normal"></highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>populate<sp/>the<sp/>values<sp/>array<sp/>with<sp/>real<sp/>value<sp/>either<sp/>from<sp/>the<sp/>input<sp/>data<sp/>file<sp/>line</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>from<sp/>the<sp/>foreign<sp/>key<sp/>/<sp/>referral<sp/>record</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;need_further_processing&apos;</highlight><highlight class="normal">,<sp/>$table_data)<sp/>and<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;need_further_processing&apos;</highlight><highlight class="normal">])<sp/>{</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists($priority,<sp/>$addt-&gt;field2column))<sp/>{</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>=<sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a3f6c4d50cbf34a9c42ed3b888a82e9ef" kindref="member">tripal_bulk_loader_add_spreadsheetdata_to_values</ref>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>$addt-&gt;line,<sp/>$addt-&gt;field2column[$priority]);</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>=<sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1ad1535d34d616ebc2e5059247b78a2c68" kindref="member">tripal_bulk_loader_add_foreignkey_to_values</ref>($table_data,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>$data,<sp/>$addt-&gt;record2priority,<sp/>$addt-&gt;nid,<sp/>$priority,<sp/>$default_data);</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="509"><highlight class="normal"></highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>=<sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1aba46b252142760b713ed73150e11295c" kindref="member">tripal_bulk_loader_regex_tranform_values</ref>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>$table_data,<sp/>$addt-&gt;line);</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>{</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//tripal_bulk_loader_throw_error(&apos;Line<sp/>&apos;<sp/>.<sp/>$addt-&gt;line_num<sp/>.<sp/>&apos;<sp/>Regex:&lt;pre&gt;&apos;<sp/>.<sp/>print_r($values,<sp/>TRUE)<sp/>.<sp/>print_r($table_data,<sp/>TRUE)<sp/>.<sp/>&apos;&lt;/pre&gt;&apos;<sp/>.<sp/>&apos;&lt;/pre&gt;&apos;,<sp/>array(),<sp/>TRIPAL_NOTICE);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="514"><highlight class="normal"></highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>the<sp/>table<sp/>description</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/>$table_desc<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>);</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$table_desc)<sp/>{</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/>$msg<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Tripal<sp/>does<sp/>not<sp/>know<sp/>about<sp/>the<sp/>table<sp/>named<sp/>&apos;%table&apos;.<sp/>If<sp/>this<sp/>is<sp/>a<sp/>custom<sp/>table,</highlight></codeline>
<codeline lineno="519"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/>please<sp/>define<sp/>it<sp/>first&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;%table&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>);</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="524"><highlight class="normal"></highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>template<sp/>required<sp/>fields<sp/>are<sp/>present.<sp/>if<sp/>a<sp/>required<sp/>field<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>missing<sp/>and<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>an<sp/>optional<sp/>record<sp/>then<sp/>just<sp/>return.<sp/>otherwise<sp/>raise<sp/>an<sp/>error</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/>$skip_optional<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($table_data[</highlight><highlight class="stringliteral">&apos;required&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$field<sp/>=&gt;<sp/>$required)<sp/>{</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($required)<sp/>{</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>if<sp/>the<sp/>field<sp/>has<sp/>no<sp/>value<sp/>(or<sp/>array<sp/>is<sp/>empty)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!isset(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field])<sp/>or</highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(is_array(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field])<sp/>and<sp/>count(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field])<sp/>==<sp/>0))<sp/>{</highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>if<sp/>the<sp/>record<sp/>is<sp/>optional.<sp/><sp/>For<sp/>backwards<sp/>compatiblity<sp/>we<sp/>need<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>if<sp/>the<sp/>&apos;mode&apos;<sp/>is<sp/>set<sp/>to<sp/>&apos;optional&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($table_data[</highlight><highlight class="stringliteral">&apos;optional&apos;</highlight><highlight class="normal">]<sp/>or<sp/>preg_match(</highlight><highlight class="stringliteral">&apos;/optional/&apos;</highlight><highlight class="normal">,<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">])<sp/>or</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$table_data[</highlight><highlight class="stringliteral">&apos;select_optional&apos;</highlight><highlight class="normal">])<sp/><sp/>{</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$skip_optional<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>the<sp/>values<sp/>array<sp/>to<sp/>be<sp/>empty<sp/>since<sp/>we<sp/>all<sp/>required<sp/>fields<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>optional<sp/>and<sp/>we<sp/>can&apos;t<sp/>do<sp/>a<sp/>select/insert<sp/>so<sp/>we<sp/>don&apos;t<sp/>want<sp/>to<sp/>keep</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>values<sp/>if<sp/>this<sp/>record<sp/>is<sp/>used<sp/>in<sp/>a<sp/>later<sp/>FK<sp/>relationship.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$msg<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Line<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$addt-&gt;line_num<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>&quot;&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]<sp/>.</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;&quot;<sp/>(&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;)<sp/>Missing<sp/>template<sp/>required<sp/>value:<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal"><sp/>.<sp/>$field;</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a179264461824ee52a7a08ebef9150e4b" kindref="member">TRIPAL_WARNING</ref>);</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="554"><highlight class="normal"></highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>an<sp/>insert,<sp/>check<sp/>that<sp/>all<sp/>database<sp/>required<sp/>fields<sp/>are<sp/>present<sp/>in<sp/>the<sp/>values<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>check<sp/>for<sp/>&apos;optional&apos;<sp/>in<sp/>the<sp/>mode<sp/>for<sp/>backwards<sp/>compatibility.<sp/>The<sp/>&apos;optional&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>mode<sp/>used<sp/>to<sp/>be<sp/>a<sp/>type<sp/>of<sp/>insert</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$skip_optional<sp/>and<sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/insert/&apos;</highlight><highlight class="normal">,<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">])<sp/>or</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>preg_match(</highlight><highlight class="stringliteral">&apos;/optional/&apos;</highlight><highlight class="normal">,<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">])))<sp/>{</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>all<sp/>database<sp/>table<sp/>required<sp/>fields<sp/>are<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d2/ded/tripal__bulk__loader__fields_8tpl_8php_1ab2303c817e3b402b77b7f99627b9c319" kindref="member">$fields</ref><sp/>=<sp/>$table_desc[</highlight><highlight class="stringliteral">&apos;fields&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="d2/ded/tripal__bulk__loader__fields_8tpl_8php_1ab2303c817e3b402b77b7f99627b9c319" kindref="member">$fields</ref><sp/>as<sp/>$field<sp/>=&gt;<sp/>$def)<sp/>{</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>field<sp/>is<sp/>considered<sp/>missing<sp/>if<sp/>it<sp/>cannot<sp/>be<sp/>null<sp/>and<sp/>there<sp/>is<sp/>no<sp/>default</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>value<sp/>for<sp/>it<sp/>or<sp/>it<sp/>is<sp/>not<sp/>of<sp/>type<sp/>&apos;serial&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;not<sp/>null&apos;</highlight><highlight class="normal">,<sp/>$def)<sp/>and<sp/>$def[</highlight><highlight class="stringliteral">&apos;not<sp/>null&apos;</highlight><highlight class="normal">]<sp/>==<sp/>1<sp/>and<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>field<sp/>must<sp/>have<sp/>a<sp/>value</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!array_key_exists($field,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>and<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>there<sp/>is<sp/>not<sp/>a<sp/>value<sp/>for<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!array_key_exists(</highlight><highlight class="stringliteral">&apos;default&apos;</highlight><highlight class="normal">,<sp/>$def)<sp/>and<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>there<sp/>is<sp/>no<sp/>default<sp/>for<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strcmp($def[</highlight><highlight class="stringliteral">&apos;type&apos;</highlight><highlight class="normal">],<sp/></highlight><highlight class="stringliteral">&apos;serial&apos;</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/>{<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>is<sp/>not<sp/>a<sp/>&apos;serial&apos;<sp/>type<sp/>column</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$msg<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Line<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$addt-&gt;line_num<sp/>.<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]<sp/>.</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;<sp/>(&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;)<sp/>Missing<sp/>Database<sp/>Required<sp/>Value:<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal"><sp/>.<sp/>$field;</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>);</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="577"><highlight class="normal"></highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>updated<sp/>values<sp/>array<sp/>into<sp/>the<sp/>data<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>;</highlight></codeline>
<codeline lineno="580"><highlight class="normal"></highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>there<sp/>was<sp/>an<sp/>error<sp/>already<sp/>-&gt;<sp/>don&apos;t<sp/>insert</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">,<sp/>$data[$priority])<sp/>and<sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">])<sp/>{</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>(</highlight><highlight class="stringliteral">&apos;Skipping<sp/>processing<sp/>of<sp/>%table<sp/>due<sp/>to<sp/>previous<sp/>errors&apos;</highlight><highlight class="normal">,array(</highlight><highlight class="stringliteral">&apos;%table&apos;</highlight><highlight class="normal">=&gt;<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>),<ref refid="dd/d45/tripal_8notice_8api_8inc_1ad9759873be1ae0c3d8ccc37d121aeb3c" kindref="member">TRIPAL_NOTICE</ref>);</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$no_errors;</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="586"><highlight class="normal"></highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>skip<sp/>optional<sp/>fields</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($skip_optional)<sp/>{</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SPF<sp/>--<sp/>Commented<sp/>out<sp/>the<sp/>following<sp/>line.<sp/><sp/>This<sp/>state<sp/>is<sp/>intentional<sp/>due</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>the<sp/>loader<sp/>setup<sp/>and<sp/>and<sp/>is<sp/>not<sp/>an<sp/>error.<sp/><sp/>If<sp/>informational<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prints<sp/>too<sp/>much<sp/>to<sp/>the<sp/>terminal.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tripal_bulk_loader_throw_error(&apos;Skipping<sp/>an<sp/>optional<sp/>record<sp/>(%record)&apos;,array(&apos;%record&apos;=&gt;$table_data[&apos;record_id&apos;]),TRIPAL_NOTICE);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$no_errors;</highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="595"><highlight class="normal"></highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>if<sp/>it<sp/>is<sp/>already<sp/>inserted</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;inserted&apos;</highlight><highlight class="normal">,<sp/>$table_data)<sp/>and<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;inserted&apos;</highlight><highlight class="normal">])<sp/>{</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SPF<sp/>--<sp/>Commented<sp/>out<sp/>the<sp/>following<sp/>line.<sp/><sp/>This<sp/>state<sp/>is<sp/>intentional<sp/>due</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>the<sp/>loader<sp/>setup<sp/>and<sp/>and<sp/>is<sp/>not<sp/>an<sp/>error.<sp/><sp/>If<sp/>informational<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prints<sp/>too<sp/>much<sp/>to<sp/>the<sp/>terminal.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tripal_bulk_loader_throw_error(&apos;Skipping<sp/>%record<sp/>since<sp/>it<sp/>is<sp/>already<sp/>inserted&apos;,array(&apos;%record&apos;=&gt;$table_data[&apos;record_id&apos;]),TRIPAL_NOTICE);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$no_errors;</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="604"><highlight class="normal"></highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>if<sp/>it<sp/>is<sp/>already<sp/>selected,<sp/>if<sp/>so,<sp/>just<sp/>get<sp/>the<sp/>value<sp/>stored<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>default_data<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;selected&apos;</highlight><highlight class="normal">,<sp/>$table_data)<sp/>and<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;selected&apos;</highlight><highlight class="normal">])<sp/>{</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SPF<sp/>--<sp/>Commented<sp/>out<sp/>the<sp/>following<sp/>line.<sp/><sp/>This<sp/>state<sp/>is<sp/>intentional<sp/>due</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>the<sp/>loader<sp/>setup<sp/>and<sp/>and<sp/>is<sp/>not<sp/>an<sp/>error.<sp/><sp/>If<sp/>informational<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prints<sp/>too<sp/>much<sp/>to<sp/>the<sp/>terminal.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tripal_bulk_loader_throw_error(&apos;%record<sp/>was<sp/>already<sp/>selected<sp/>thus<sp/>we<sp/>are<sp/>just<sp/>returning<sp/>the<sp/>values<sp/>previously<sp/>selected.&apos;,array(&apos;%record&apos;=&gt;$table_data[&apos;record_id&apos;]),TRIPAL_NOTICE);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$no_errors;</highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="615"><highlight class="normal"></highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>make<sp/>sure<sp/>we<sp/>have<sp/>some<sp/>value<sp/>in<sp/>the<sp/>select_if_duplicate<sp/>and<sp/>update_if_duplicate<sp/>options</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;select_if_duplicate&apos;</highlight><highlight class="normal">,<sp/>$table_data))<sp/>{</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/>$table_data[</highlight><highlight class="stringliteral">&apos;select_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="620"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;update_if_duplicate&apos;</highlight><highlight class="normal">,<sp/>$table_data))<sp/>{</highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/>$table_data[</highlight><highlight class="stringliteral">&apos;update_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="623"><highlight class="normal"></highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>&quot;select<sp/>if<sp/>duplicate&quot;<sp/>is<sp/>enabled<sp/>then<sp/>check<sp/>to<sp/>ensure<sp/>unique<sp/>constraint<sp/>is<sp/>not<sp/>violated.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>it<sp/>is<sp/>violated<sp/>then<sp/>simply<sp/>return,<sp/>the<sp/>record<sp/>already<sp/>exists<sp/>in<sp/>the<sp/>database.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>check<sp/>for<sp/>&quot;insert_unique&quot;<sp/>for<sp/>backwards<sp/>compatibilty<sp/>but<sp/>that<sp/>mode<sp/>no<sp/>longer<sp/>exists</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;is_duplicate&apos;</highlight><highlight class="normal">]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/insert_unique/&apos;</highlight><highlight class="normal">,<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">])<sp/>or</highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>$table_data[</highlight><highlight class="stringliteral">&apos;select_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>==<sp/>1<sp/>or</highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>$table_data[</highlight><highlight class="stringliteral">&apos;update_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="631"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref><sp/>=<sp/>array(</highlight><highlight class="stringliteral">&apos;is_duplicate&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>TRUE,<sp/></highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>TRUE);</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/>$duplicate<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gad84b24dc3ed2e18b053977221f997a35" kindref="member">chado_select_record</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,<sp/>array_keys($table_desc[</highlight><highlight class="stringliteral">&apos;fields&apos;</highlight><highlight class="normal">]),<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>);</highlight></codeline>
<codeline lineno="633"><highlight class="normal"></highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>this<sp/>is<sp/>a<sp/>duplicate<sp/>then<sp/>substitute<sp/>the<sp/>values<sp/>in<sp/>the<sp/>table_data<sp/>array<sp/>so</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>for<sp/>future<sp/>records<sp/>that<sp/>may<sp/>depend<sp/>on<sp/>this<sp/>one,<sp/>they<sp/>can<sp/>get<sp/>the<sp/>values<sp/>needed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($duplicate<sp/>and<sp/>is_array($duplicate)<sp/>and<sp/>count($duplicate)<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$dup_record<sp/>=<sp/>$duplicate[0];</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>save<sp/>the<sp/>duplicate<sp/>record<sp/>for<sp/>later.<sp/><sp/>If<sp/>this<sp/>is<sp/>an<sp/>update_if_duplicate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>then<sp/>we&apos;ll<sp/>need<sp/>this<sp/>record<sp/>as<sp/>the<sp/>match</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;is_duplicate&apos;</highlight><highlight class="normal">]<sp/>=<sp/>(array)<sp/>$dup_record;</highlight></codeline>
<codeline lineno="641"><highlight class="normal"></highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>all<sp/>we<sp/>have<sp/>is<sp/>one<sp/>field<sp/>then<sp/>we<sp/>will<sp/>just<sp/>use<sp/>the<sp/>value<sp/>returned</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>rather<sp/>than<sp/>create<sp/>an<sp/>array<sp/>of<sp/>values.<sp/>This<sp/>way<sp/>it<sp/>will<sp/>prevent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>tripal_core_chado_(select|insert|update)<sp/>from<sp/>recursing<sp/>on</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>foreign<sp/>keys<sp/>and<sp/>make<sp/>the<sp/>loader<sp/>go<sp/>faster.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(count((array)<sp/>$dup_record)<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($dup_record<sp/>as<sp/>$key<sp/>=&gt;<sp/>$value)<sp/>{</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$value;</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>we<sp/>have<sp/>multiple<sp/>fields<sp/>returned<sp/>then<sp/>we<sp/>need<sp/>to<sp/>set<sp/>the<sp/>values</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>new<sp/>array.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>convert<sp/>object<sp/>to<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$new_values<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($dup_record<sp/>as<sp/>$key<sp/>=&gt;<sp/>$value)<sp/>{</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$new_values[$key]<sp/>=<sp/>$value;</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$new_values;</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>return<sp/>if<sp/>this<sp/>is<sp/>a<sp/>select_if_duplicate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($table_data[</highlight><highlight class="stringliteral">&apos;select_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SPF<sp/>--<sp/>Commented<sp/>out<sp/>the<sp/>following<sp/>line.<sp/><sp/>This<sp/>state<sp/>is<sp/>intentional<sp/>due</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>the<sp/>loader<sp/>setup<sp/>and<sp/>and<sp/>is<sp/>not<sp/>an<sp/>error.<sp/><sp/>If<sp/>informational<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prints<sp/>too<sp/>much<sp/>to<sp/>the<sp/>terminal.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tripal_bulk_loader_throw_error(&apos;Simply<sp/>returning<sp/>values<sp/>for<sp/>%record<sp/>since<sp/>it<sp/>was<sp/>already<sp/>inserted&apos;,array(&apos;%record&apos;=&gt;$table_data[&apos;record_id&apos;]),TRIPAL_NOTICE);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$no_errors;</highlight></codeline>
<codeline lineno="668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="669"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="671"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="672"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/><sp/><sp/>#<sp/>TODO:<sp/>what<sp/>to<sp/>do<sp/>if<sp/>there<sp/>are<sp/>more<sp/>than<sp/>one<sp/>value<sp/>returned<sp/>when</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="673"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/><sp/><sp/>#<sp/>checking<sp/>for<sp/>a<sp/>duplicate?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="675"><highlight class="normal"></highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!preg_match(</highlight><highlight class="stringliteral">&apos;/select/&apos;</highlight><highlight class="normal">,<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>prepared<sp/>statement?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(variable_get(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_prepare&apos;</highlight><highlight class="normal">,<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref><sp/>=<sp/>array(</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><sp/></highlight><highlight class="stringliteral">&apos;record_&apos;</highlight><highlight class="normal"><sp/>.<sp/>$addt-&gt;nid<sp/>.<sp/></highlight><highlight class="charliteral">&apos;_&apos;</highlight><highlight class="normal"><sp/>.<sp/>$priority);</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(($addt-&gt;line_num<sp/>&gt;<sp/>1<sp/>&amp;&amp;<sp/>$addt-&gt;group_index<sp/>==<sp/>1)<sp/>OR<sp/>$addt-&gt;group_index<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//$options[&apos;is_prepared&apos;]<sp/>=<sp/>TRUE;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref><sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="686"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Skip<sp/>chado_insert_record()<sp/>built-in<sp/>validation?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(variable_get(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_skip_validation&apos;</highlight><highlight class="normal">,<sp/>FALSE))<sp/>{</highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;skip_validation&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="691"><highlight class="normal"></highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($table_data[</highlight><highlight class="stringliteral">&apos;update_if_duplicate&apos;</highlight><highlight class="normal">]<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal">,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>))<sp/>{</highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal">]<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;upd_&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>should<sp/>have<sp/>been<sp/>set<sp/>on<sp/>the<sp/>first<sp/>round<sp/>of<sp/>inserts<sp/>for<sp/>this<sp/>record</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$match<sp/>=<sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;is_duplicate&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>However,<sp/>sometimes<sp/>there<sp/>is<sp/>a<sp/>pre-existing<sp/>record<sp/>before<sp/>the<sp/>loader<sp/>starts</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Thus<sp/>check<sp/>that<sp/>this<sp/>value<sp/>is<sp/>set<sp/>and<sp/>if<sp/>not,<sp/>then<sp/>generate<sp/>a<sp/>match<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>based<sp/>on<sp/>the<sp/>unique<sp/>keys<sp/>for<sp/>this<sp/>record.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(empty($match))<sp/>{</highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$match<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>check<sp/>to<sp/>see<sp/>if<sp/>we<sp/>have<sp/>fields<sp/>for<sp/>the<sp/>primary<sp/>key</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($table_desc[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$k_field)<sp/>{</highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!empty(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$k_field]))<sp/>{</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$match[$k_field]<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$k_field];</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise<sp/>check<sp/>the<sp/>fields<sp/>that<sp/>are<sp/>part<sp/>of<sp/>the<sp/>unique<sp/>key</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(empty($match))<sp/>{</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($table_desc[</highlight><highlight class="stringliteral">&apos;unique<sp/>keys&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$u_keys)<sp/>{</highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($u_keys<sp/>as<sp/>$u_field)<sp/>{</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!empty(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$u_field]))<sp/>{</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$match[$u_field]<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$u_field];</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!empty($match))<sp/>{</highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>we<sp/>need<sp/>to<sp/>check<sp/>if<sp/>it<sp/>already<sp/>exists<sp/>via<sp/>a<sp/>select</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gad84b24dc3ed2e18b053977221f997a35" kindref="member">chado_select_record</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,<sp/>array_keys($table_desc[</highlight><highlight class="stringliteral">&apos;fields&apos;</highlight><highlight class="normal">]),<sp/>$match,<sp/>array(</highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>TRUE));</highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>not<sp/>then<sp/>insert</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(empty(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref>))<sp/>{</highlight></codeline>
<codeline lineno="725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal">]<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;ins_&apos;</highlight><highlight class="normal">.$options[</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga5c5f09d0a7dc5a6ecf00cc226692bd19" kindref="member">chado_insert_record</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>);</highlight></codeline>
<codeline lineno="728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;return_record&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga35aa655c2c929858ab05df18bc807541" kindref="member">chado_update_record</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,<sp/>$match,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>);</highlight></codeline>
<codeline lineno="733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$msg<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;\nLine<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$addt-&gt;line_num<sp/>.<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>(&apos;</highlight><highlight class="normal"><sp/>.</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;)<sp/>Unable<sp/>to<sp/>update<sp/>record<sp/>since<sp/>none<sp/>of<sp/>the<sp/>unique<sp/>key<sp/>or<sp/>primary<sp/>key<sp/>fields<sp/>were<sp/>available<sp/>&apos;</highlight><highlight class="normal"><sp/>.</highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;<sp/>where<sp/>values:&apos;</highlight><highlight class="normal"><sp/>.<sp/>print_r(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>TRUE);</highlight></codeline>
<codeline lineno="739"><highlight class="normal"></highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>);</highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="744"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga5c5f09d0a7dc5a6ecf00cc226692bd19" kindref="member">chado_insert_record</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>);</highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="749"><highlight class="normal"></highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>insert<sp/>was<sp/>not<sp/>successful</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>)<sp/>{</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$msg<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;\nLine<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$addt-&gt;line_num<sp/>.<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>(&apos;</highlight><highlight class="normal"><sp/>.</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;)<sp/>Unable<sp/>to<sp/>insert<sp/>record<sp/>into<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.</highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;<sp/>where<sp/>values:&apos;</highlight><highlight class="normal"><sp/>.<sp/>print_r(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>TRUE);</highlight></codeline>
<codeline lineno="755"><highlight class="normal"></highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>);</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="759"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>insert<sp/>was<sp/>succesful</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="761"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="762"><highlight class="normal"></highlight></codeline>
<codeline lineno="763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>mode=insert_once<sp/>then<sp/>ensure<sp/>we<sp/>only<sp/>insert<sp/>it<sp/>once</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/insert_once/&apos;</highlight><highlight class="normal">,<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;inserted&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="767"><highlight class="normal"></highlight></codeline>
<codeline lineno="768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>to<sp/>tripal_bulk_loader_inserted</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($addt-&gt;node-&gt;keep_track_inserted)<sp/>{</highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$insert_record<sp/>=<sp/>db_query(</highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>*<sp/>FROM<sp/>{tripal_bulk_loader_inserted}<sp/>WHERE<sp/>table_inserted_into=:table<sp/>AND<sp/>nid=:nid&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight></codeline>
<codeline lineno="773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;:table&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,</highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$addt-&gt;nid</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>))-&gt;fetchObject();</highlight></codeline>
<codeline lineno="776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($insert_record)<sp/>{</highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$insert_record-&gt;ids_inserted<sp/>.=<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>[$table_desc[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">][0]<sp/>];</highlight></codeline>
<codeline lineno="778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_write_record(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_inserted&apos;</highlight><highlight class="normal">,<sp/>$insert_record,<sp/></highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_inserted_id&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//print<sp/>&apos;Update:<sp/>&apos;.print_r($insert_record,TRUE).&quot;\n&quot;;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//return<sp/>$no_errors;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$insert_record<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$addt-&gt;nid,</highlight></codeline>
<codeline lineno="785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;table_inserted_into&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,</highlight></codeline>
<codeline lineno="786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;table_primary_key&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$table_desc[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">][0],</highlight></codeline>
<codeline lineno="787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;ids_inserted&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>[<sp/>$table_desc[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">][0]<sp/>],</highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//print<sp/>&apos;New:<sp/>&apos;.print_r($insert_record,TRUE).&quot;\n&quot;;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$success<sp/>=<sp/>drupal_write_record(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_inserted&apos;</highlight><highlight class="normal">,<sp/>$insert_record);</highlight></codeline>
<codeline lineno="791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//return<sp/>$no_errors;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="comment">//end<sp/>of<sp/>if<sp/>insert<sp/>record</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="comment">//<sp/>end<sp/>of<sp/>if<sp/>keeping<sp/>track<sp/>of<sp/>records<sp/>inserted</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="794"><highlight class="normal"></highlight></codeline>
<codeline lineno="795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>substitute<sp/>the<sp/>values<sp/>array<sp/>for<sp/>the<sp/>primary<sp/>key<sp/>if<sp/>it<sp/>exists</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>is<sp/>a<sp/>single<sp/>field</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">,<sp/>$table_desc))<sp/>{</highlight></codeline>
<codeline lineno="798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(count($table_desc[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">])<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$pkey_field<sp/>=<sp/>$table_desc[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">][0];</highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>[$pkey_field];</highlight></codeline>
<codeline lineno="801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//add<sp/>changes<sp/>back<sp/>to<sp/>values<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>;</highlight></codeline>
<codeline lineno="806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>;</highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="808"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//end<sp/>of<sp/>if<sp/>insert<sp/>was<sp/>successful</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="809"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>perform<sp/>a<sp/>select</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>the<sp/>matches<sp/>for<sp/>this<sp/>select</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/><sp/><sp/>$matches<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_array(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>and<sp/>count(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$matches<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gad84b24dc3ed2e18b053977221f997a35" kindref="member">chado_select_record</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,<sp/>array_keys($table_desc[</highlight><highlight class="stringliteral">&apos;fields&apos;</highlight><highlight class="normal">]),<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>array(</highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>TRUE));</highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>record<sp/>doesn&apos;t<sp/>exist<sp/>and<sp/>it&apos;s<sp/>not<sp/>optional<sp/>then<sp/>generate<sp/>an<sp/>error</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(count($matches)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>record<sp/>on<sp/>select</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($table_data[</highlight><highlight class="stringliteral">&apos;select_optional&apos;</highlight><highlight class="normal">]<sp/>!=<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$msg<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;\nLine<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$addt-&gt;line_num<sp/>.<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>(&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;)<sp/>No<sp/>Matching<sp/>record<sp/>in<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>where<sp/>values:&apos;</highlight><highlight class="normal"><sp/>.<sp/>print_r(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>TRUE);</highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>);</highlight></codeline>
<codeline lineno="823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>there<sp/>is<sp/>no<sp/>match<sp/>and<sp/>select<sp/>optional<sp/>is<sp/>turned<sp/>on,<sp/>so<sp/>we<sp/>want<sp/>to<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>values<sp/>to<sp/>empty<sp/>for<sp/>any<sp/>records<sp/>with<sp/>an<sp/>FK<sp/>relationship<sp/>on<sp/>this<sp/>one</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>we<sp/>have<sp/>more<sp/>than<sp/>one<sp/>record<sp/>matching<sp/>and<sp/>this<sp/>select<sp/>isn&apos;t<sp/>optional<sp/>then<sp/>fail</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(count($matches)<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($table_data[</highlight><highlight class="stringliteral">&apos;select_optional&apos;</highlight><highlight class="normal">]<sp/>!=<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$msg<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;\nLine<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$addt-&gt;line_num<sp/>.<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>(&apos;</highlight><highlight class="normal"><sp/>.<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;)<sp/>Too<sp/>many<sp/>matching<sp/>records<sp/>in<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>where<sp/>values:&apos;</highlight><highlight class="normal"><sp/>.<sp/>print_r(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>TRUE);</highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a179264461824ee52a7a08ebef9150e4b" kindref="member">TRIPAL_WARNING</ref>);</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$no_errors<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>there<sp/>are<sp/>too<sp/>many<sp/>matches<sp/>and<sp/>this<sp/>is<sp/>an<sp/>optional<sp/>select<sp/>so<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>values<sp/>to<sp/>empty<sp/>for<sp/>any<sp/>records<sp/>with<sp/>an<sp/>FK<sp/>relationship<sp/>on<sp/>this<sp/>one</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$data[$priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">]<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="846"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>mode=select_once<sp/>then<sp/>ensure<sp/>we<sp/>only<sp/>select<sp/>it<sp/>once</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/select_once/&apos;</highlight><highlight class="normal">,<sp/>$table_data[</highlight><highlight class="stringliteral">&apos;mode&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;selected&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="849"><highlight class="normal"></highlight></codeline>
<codeline lineno="850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>save<sp/>the<sp/>pkey</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">,<sp/>$table_desc))<sp/>{</highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$new_values<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($matches[0]<sp/>as<sp/>$key<sp/>=&gt;<sp/>$value)<sp/>{</highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$new_values[$key]<sp/>=<sp/>$value;</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$default_data[$priority][</highlight><highlight class="stringliteral">&apos;values_default&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$new_values;</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="859"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="860"><highlight class="normal"></highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$no_errors;</highlight></codeline>
<codeline lineno="862"><highlight class="normal">}</highlight></codeline>
<codeline lineno="863"><highlight class="normal"></highlight></codeline>
<codeline lineno="878" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a3f6c4d50cbf34a9c42ed3b888a82e9ef" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a3f6c4d50cbf34a9c42ed3b888a82e9ef" kindref="member">tripal_bulk_loader_add_spreadsheetdata_to_values</ref>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>$line,<sp/>$field2column)<sp/>{</highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>as<sp/>$field<sp/>=&gt;<sp/>$value)<sp/>{</highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_array($value))<sp/>{</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="883"><highlight class="normal"></highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/>$column<sp/>=<sp/>$field2column[$field]<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($column<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="888"><highlight class="normal"></highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match(</highlight><highlight class="stringliteral">&apos;/\S+/&apos;</highlight><highlight class="normal">,<sp/>$line[$column]))<sp/>{</highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]<sp/>=<sp/>$line[$column];</highlight></codeline>
<codeline lineno="891"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>unset(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]);</highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="896"><highlight class="normal"></highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>;</highlight></codeline>
<codeline lineno="898"><highlight class="normal">}</highlight></codeline>
<codeline lineno="899"><highlight class="normal"></highlight></codeline>
<codeline lineno="909" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1ad1535d34d616ebc2e5059247b78a2c68" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1ad1535d34d616ebc2e5059247b78a2c68" kindref="member">tripal_bulk_loader_add_foreignkey_to_values</ref>($table_array,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>$data,<sp/>$record2priority,<sp/>$nid,<sp/>$priority,<sp/>$default_data)<sp/>{</highlight></codeline>
<codeline lineno="910"><highlight class="normal"></highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>iterate<sp/>through<sp/>each<sp/>field<sp/>in<sp/>the<sp/>$values<sp/>arrray<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="912"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>substitute<sp/>any<sp/>values<sp/>for<sp/>FK<sp/>/<sp/>referring<sp/>fields</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="913"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>as<sp/>$field<sp/>=&gt;<sp/>$value)<sp/>{</highlight></codeline>
<codeline lineno="914"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>field<sp/>value<sp/>is<sp/>an<sp/>array<sp/>then<sp/>it<sp/>is<sp/>an<sp/>FK</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_array($value))<sp/>{</highlight></codeline>
<codeline lineno="916"><highlight class="normal"></highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>the<sp/>name<sp/>and<sp/>priority<sp/>of<sp/>the<sp/>foreign<sp/>record</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$foreign_record<sp/><sp/><sp/>=<sp/>$value[</highlight><highlight class="stringliteral">&apos;foreign<sp/>record&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;record&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$foreign_priority<sp/>=<sp/>$record2priority[$foreign_record];</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$foreign_table<sp/><sp/><sp/><sp/>=<sp/>$value[</highlight><highlight class="stringliteral">&apos;foreign<sp/>record&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$foreign_field<sp/><sp/><sp/><sp/>=<sp/>$value[</highlight><highlight class="stringliteral">&apos;foreign<sp/>record&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="922"><highlight class="normal"></highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>the<sp/>values<sp/>of<sp/>the<sp/>foreign<sp/>record<sp/>and<sp/>substitute<sp/>those<sp/>for<sp/>the<sp/>values</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$foreign_values<sp/><sp/><sp/>=<sp/>$data[$foreign_priority][</highlight><highlight class="stringliteral">&apos;values_array&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="925"><highlight class="normal"></highlight></codeline>
<codeline lineno="926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>to<sp/>see<sp/>if<sp/>we<sp/>have<sp/>any<sp/>default<sp/>values<sp/>in<sp/>the<sp/>$default_data<sp/>array</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>these<sp/>were<sp/>populated<sp/>from<sp/>select<sp/>statements<sp/>that<sp/>only<sp/>need<sp/>to<sp/>run<sp/>once</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>we<sp/>can<sp/>reuse<sp/>the<sp/>values<sp/>from<sp/>those<sp/>previous<sp/>selects.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists($foreign_priority,<sp/>$default_data)<sp/>and</highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array_key_exists(</highlight><highlight class="stringliteral">&apos;values_default&apos;</highlight><highlight class="normal">,<sp/>$default_data[$foreign_priority])<sp/>and</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array_key_exists($foreign_field,<sp/>$default_data[$foreign_priority][</highlight><highlight class="stringliteral">&apos;values_default&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]<sp/>=<sp/>$default_data[$foreign_priority][</highlight><highlight class="stringliteral">&apos;values_default&apos;</highlight><highlight class="normal">][$foreign_field];</highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="935"><highlight class="normal"></highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>field<sp/>in<sp/>the<sp/>Referral<sp/>records<sp/>is<sp/>in<sp/>a<sp/>FK<sp/>relationship<sp/>with</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>field<sp/>then<sp/>we<sp/>can<sp/>simply<sp/>keep<sp/>the<sp/>value<sp/>we<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$tbl_description<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>($table_array[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($tbl_description<sp/>and</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array_key_exists(</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">,<sp/>$tbl_description)<sp/>and</highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array_key_exists($foreign_table,<sp/>$tbl_description[</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">])<sp/>and</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array_key_exists($field,<sp/>$tbl_description[</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">][$foreign_table][</highlight><highlight class="stringliteral">&apos;columns&apos;</highlight><highlight class="normal">])<sp/>and</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$foreign_field<sp/>==<sp/>$tbl_description[</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">][$foreign_table][</highlight><highlight class="stringliteral">&apos;columns&apos;</highlight><highlight class="normal">][$field])<sp/>{</highlight></codeline>
<codeline lineno="944"><highlight class="normal"></highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]<sp/>=<sp/>$foreign_values;</highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>field<sp/>in<sp/>the<sp/>Referral<sp/>records<sp/>is<sp/>not<sp/>in<sp/>an<sp/>FK<sp/>relationship</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>with<sp/>this<sp/>field<sp/>then<sp/>we<sp/>we<sp/>have<sp/>to<sp/>get<sp/>the<sp/>requested<sp/>value,<sp/>we<sp/>must</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>return<sp/>only<sp/>a<sp/>single<sp/>value</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>current<sp/>value<sp/>of<sp/>the<sp/>referral<sp/>records<sp/>is<sp/>a<sp/>non-array<sp/>then<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>the<sp/>primary<sp/>key,<sp/>we<sp/>can<sp/>use<sp/>it<sp/>to<sp/>select<sp/>the<sp/>value<sp/>we<sp/>need.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$fk_description<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>($foreign_table);</highlight></codeline>
<codeline lineno="954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!is_array($foreign_values))<sp/>{</highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>we<sp/>have<sp/>a<sp/>value<sp/>then<sp/>use<sp/>it<sp/>to<sp/>get<sp/>the<sp/>field<sp/>we<sp/>need</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($foreign_values)<sp/>{</highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$fvalues<sp/>=<sp/>array($fk_description[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">][0]<sp/>=&gt;<sp/>$foreign_values);</highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a19d2a3d21fe02053311fde465e6ae2e9" kindref="member">$columns</ref><sp/>=<sp/>array($foreign_field);</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref><sp/>=<sp/>array(</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;pk_&apos;</highlight><highlight class="normal"><sp/>.<sp/>$foreign_table);</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/><sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gad84b24dc3ed2e18b053977221f997a35" kindref="member">chado_select_record</ref>($foreign_table,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a19d2a3d21fe02053311fde465e6ae2e9" kindref="member">$columns</ref>,<sp/>$fvalues,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>);</highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>)<sp/>{</highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]<sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>[0]-&gt;$foreign_field;</highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]);</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>we<sp/>don&apos;t<sp/>have<sp/>a<sp/>value<sp/>then<sp/>there&apos;s<sp/>nothing<sp/>we<sp/>can<sp/>do<sp/>so</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>this<sp/>value<sp/>to<sp/>nothing<sp/>as<sp/>well</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]);</highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>current<sp/>value<sp/>is<sp/>an<sp/>array<sp/>and<sp/>our<sp/>field<sp/>is<sp/>not<sp/>in<sp/>it,<sp/>then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>need<sp/>to<sp/>select<sp/>a<sp/>value<sp/>for<sp/>our<sp/>field.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$fvalues<sp/><sp/>=<sp/>$foreign_values;</highlight></codeline>
<codeline lineno="979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a19d2a3d21fe02053311fde465e6ae2e9" kindref="member">$columns</ref><sp/>=<sp/>array($foreign_field);</highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref><sp/>=<sp/>array(</highlight><highlight class="stringliteral">&apos;statement_name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;blk_&apos;</highlight><highlight class="normal"><sp/>.<sp/>$nid<sp/>.<sp/>$priority<sp/>.<sp/>$foreign_table);</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;print_errors&apos;</highlight><highlight class="normal">]<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/><sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1gad84b24dc3ed2e18b053977221f997a35" kindref="member">chado_select_record</ref>($foreign_table,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a19d2a3d21fe02053311fde465e6ae2e9" kindref="member">$columns</ref>,<sp/>$fvalues,<sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>);</highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>)<sp/>{</highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]<sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>[0]-&gt;$foreign_field;</highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]);</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>end<sp/>else<sp/>from:<sp/>if<sp/>(!is_array($foreign_values)<sp/>...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>end<sp/>else<sp/>from:<sp/>if<sp/>($tbl_description<sp/>...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="991"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>end<sp/>if(is_array($value))<sp/>...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="992"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>end<sp/>foreach<sp/>($values<sp/>...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="993"><highlight class="normal"></highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>return<sp/>the<sp/>updated<sp/>field<sp/>values</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="995"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>;</highlight></codeline>
<codeline lineno="996"><highlight class="normal">}</highlight></codeline>
<codeline lineno="997"><highlight class="normal"></highlight></codeline>
<codeline lineno="1008" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1aba46b252142760b713ed73150e11295c" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1aba46b252142760b713ed73150e11295c" kindref="member">tripal_bulk_loader_regex_tranform_values</ref>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>$table_data,<sp/>$line)<sp/>{</highlight></codeline>
<codeline lineno="1009"><highlight class="normal"></highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;regex_transform&apos;</highlight><highlight class="normal">,<sp/>$table_data)<sp/>or</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>empty($table_data[</highlight><highlight class="stringliteral">&apos;regex_transform&apos;</highlight><highlight class="normal">])<sp/>or</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>!array_key_exists(</highlight><highlight class="stringliteral">&apos;regex_transform&apos;</highlight><highlight class="normal">,<sp/>$table_data)<sp/>or</highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>!is_array($table_data[</highlight><highlight class="stringliteral">&apos;regex_transform&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>;</highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1016"><highlight class="normal"></highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//tripal_core_report_error(&apos;T_bulk_loader&apos;,<sp/>TRIPAL_NOTICE,&apos;Regex<sp/>Transformation:&lt;pre&gt;&apos;.print_r($table_data[&apos;regex_transform&apos;],<sp/>TRUE).&apos;&lt;/pre&gt;&apos;,<sp/>array());</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1018"><highlight class="normal"></highlight></codeline>
<codeline lineno="1019"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($table_data[</highlight><highlight class="stringliteral">&apos;regex_transform&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$field<sp/>=&gt;<sp/>$regex_array)<sp/>{</highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;replace&apos;</highlight><highlight class="normal">,<sp/>$regex_array)<sp/>or</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!array_key_exists(</highlight><highlight class="stringliteral">&apos;pattern&apos;</highlight><highlight class="normal">,<sp/>$regex_array)<sp/>or</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!is_array($regex_array[</highlight><highlight class="stringliteral">&apos;replace&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"></highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>&lt;#column:\d+#&gt;<sp/>notation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1027"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>present<sp/>replace<sp/>with<sp/>that<sp/>column<sp/>in<sp/>the<sp/>current<sp/>line</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($regex_array[</highlight><highlight class="stringliteral">&apos;replace&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$key<sp/>=&gt;<sp/>$replace)<sp/>{</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match_all(</highlight><highlight class="stringliteral">&apos;/&lt;#column:(\d+)#&gt;/&apos;</highlight><highlight class="normal">,<sp/>$replace,<sp/>$matches))<sp/>{</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($matches[1]<sp/>as<sp/>$k<sp/>=&gt;<sp/>$column_num)<sp/>{</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$replace<sp/>=<sp/>preg_replace(</highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal"><sp/>.<sp/>$matches[0][$k]<sp/>.</highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">,<sp/>$line[$column_num-1],<sp/>$replace);</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$regex_array[</highlight><highlight class="stringliteral">&apos;replace&apos;</highlight><highlight class="normal">][$key]<sp/>=<sp/>$replace;</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1035"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1036"><highlight class="normal"></highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>do<sp/>the<sp/>full<sp/>replacement</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/>$old_value<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field];</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"><sp/><sp/><sp/><sp/>$new_value<sp/>=<sp/>preg_replace($regex_array[</highlight><highlight class="stringliteral">&apos;pattern&apos;</highlight><highlight class="normal">],<sp/>$regex_array[</highlight><highlight class="stringliteral">&apos;replace&apos;</highlight><highlight class="normal">],<sp/>$old_value);</highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]<sp/>=<sp/>$new_value;</highlight></codeline>
<codeline lineno="1041"><highlight class="normal"></highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]<sp/>===<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>unset(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[$field]);</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//print<sp/>&apos;Now:&apos;.$values[$field].&quot;\n&quot;;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"></highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>;</highlight></codeline>
<codeline lineno="1049"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1050"><highlight class="normal"></highlight></codeline>
<codeline lineno="1057" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a10c50320f3b4b1709556e32a08d78fa9" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a10c50320f3b4b1709556e32a08d78fa9" kindref="member">tripal_bulk_loader_flatten_array</ref>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/>$flattened_values<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"></highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref><sp/>as<sp/>$k<sp/>=&gt;<sp/>$v)<sp/>{</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_array($v))<sp/>{</highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$vstr<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($v<sp/>as<sp/>$vk<sp/>=&gt;<sp/>$vv)<sp/>{</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(drupal_strlen($vv)<sp/>&gt;<sp/>20)<sp/>{</highlight></codeline>
<codeline lineno="1065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$vstr[]<sp/>=<sp/>$vk<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;=&gt;&apos;</highlight><highlight class="normal"><sp/>.<sp/>drupal_substr($vv,<sp/>0,<sp/>20)<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;...&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$vstr[]<sp/>=<sp/>$vk<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;=&gt;&apos;</highlight><highlight class="normal"><sp/>.<sp/>$vv;</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$v<sp/>=<sp/></highlight><highlight class="charliteral">&apos;{&apos;</highlight><highlight class="normal"><sp/>.<sp/>implode(</highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">,<sp/>$vstr)<sp/>.<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/><sp/><sp/>elseif<sp/>(drupal_strlen($v)<sp/>&gt;<sp/>20)<sp/>{</highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$v<sp/>=<sp/>drupal_substr($v,<sp/>0,<sp/>20)<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;...&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/>$flattened_values[]<sp/>=<sp/>$k<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;=&gt;&apos;</highlight><highlight class="normal"><sp/>.<sp/>$v;</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1078"><highlight class="normal"></highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>implode(</highlight><highlight class="stringliteral">&apos;,<sp/>&apos;</highlight><highlight class="normal">,<sp/>$flattened_values);</highlight></codeline>
<codeline lineno="1080"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"></highlight></codeline>
<codeline lineno="1087" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a6295d053f208f0a93ff62995f96993cd" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a6295d053f208f0a93ff62995f96993cd" kindref="member">tripal_bulk_loader_progress_bar</ref>($current=0,<sp/>$total=100,<sp/>$size=50)<sp/>{</highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/>$new_bar<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="1089"><highlight class="normal"><sp/><sp/>$mem<sp/>=<sp/>memory_get_usage();</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"></highlight></codeline>
<codeline lineno="1091"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>iteration</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($current<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/><sp/><sp/>$new_bar<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/><sp/><sp/>fputs(STDOUT,<sp/></highlight><highlight class="stringliteral">&quot;Progress:\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1096"><highlight class="normal"></highlight></codeline>
<codeline lineno="1097"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Percentage<sp/>round<sp/>off<sp/>for<sp/>a<sp/>more<sp/>clean,<sp/>consistent<sp/>look</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><sp/><sp/>$percent<sp/>=<sp/>sprintf(</highlight><highlight class="stringliteral">&quot;%.02f&quot;</highlight><highlight class="normal">,<sp/>round(($current/$total)<sp/>*<sp/>100,<sp/>2));</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>percent<sp/>indicator<sp/>must<sp/>be<sp/>four<sp/>characters,<sp/>if<sp/>shorter,<sp/>add<sp/>some<sp/>spaces</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>($i<sp/>=<sp/>strlen($percent);<sp/>$i<sp/>&lt;=<sp/>4;<sp/>$i++)<sp/>{</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/>$percent<sp/>=<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>$percent;</highlight></codeline>
<codeline lineno="1102"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1103"><highlight class="normal"></highlight></codeline>
<codeline lineno="1104"><highlight class="normal"></highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/>$total_size<sp/>=<sp/>$size<sp/>+<sp/>$i<sp/>+<sp/>3<sp/>+<sp/>2;</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/>$place<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>it&apos;s<sp/>not<sp/>first<sp/>go,<sp/>remove<sp/>the<sp/>previous<sp/>bar</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$new_bar)<sp/>{</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>($place<sp/>=<sp/>$total_size;<sp/>$place<sp/>&gt;<sp/>0;<sp/>$place--)<sp/>{</highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>echo<sp/>a<sp/>backspace<sp/>(hex:08)<sp/>to<sp/>remove<sp/>the<sp/>previous<sp/>character</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//echo<sp/>&quot;\x08&quot;;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"></highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>output<sp/>the<sp/>progess<sp/>bar<sp/>as<sp/>it<sp/>should<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>with<sp/>a<sp/>border</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/>echo<sp/></highlight><highlight class="charliteral">&apos;[&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>($place<sp/>=<sp/>0;<sp/>$place<sp/>&lt;=<sp/>$size;<sp/>$place++)<sp/>{</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>output<sp/>&quot;full&quot;<sp/>spaces<sp/>if<sp/>this<sp/>portion<sp/>is<sp/>completed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1120"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($place<sp/>&lt;=<sp/>($current<sp/>/<sp/>$total<sp/>*<sp/>$size))<sp/>{</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>echo<sp/></highlight><highlight class="charliteral">&apos;|&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise<sp/>empty<sp/>space</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>echo<sp/></highlight><highlight class="charliteral">&apos;-&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>End<sp/>with<sp/>a<sp/>border</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1129"><highlight class="normal"><sp/><sp/>echo<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1130"><highlight class="normal"></highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>end<sp/>a<sp/>bar<sp/>with<sp/>a<sp/>percent<sp/>indicator</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/>echo<sp/></highlight><highlight class="stringliteral">&quot;<sp/>$percent%.<sp/>($current<sp/>of<sp/>$total)<sp/>Memory:<sp/>$mem\r&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"></highlight></codeline>
<codeline lineno="1134"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>it&apos;s<sp/>the<sp/>end,<sp/>add<sp/>a<sp/>new<sp/>line</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1135"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($current<sp/>==<sp/>$total)<sp/>{</highlight></codeline>
<codeline lineno="1136"><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"></highlight></codeline>
<codeline lineno="1139"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"></highlight></codeline>
<codeline lineno="1163" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a984a22a1a599ccdfbc92228c4da38205" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a984a22a1a599ccdfbc92228c4da38205" kindref="member">tripal_bulk_loader_progress_file_track_job</ref>($job_id,<sp/>$record_added,<sp/>$line_complete<sp/>=<sp/>FALSE,<sp/>$close<sp/>=<sp/>FALSE)<sp/>{</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>retrieve<sp/>the<sp/>file<sp/>handle</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1165"><highlight class="normal"><sp/><sp/>$file_handle<sp/>=<sp/>variable_get(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_progress_file_handle&apos;</highlight><highlight class="normal">,<sp/>NULL);</highlight></codeline>
<codeline lineno="1166"><highlight class="normal"></highlight></codeline>
<codeline lineno="1167"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>open<sp/>file<sp/>for<sp/>reading<sp/>if<sp/>not<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$file_handle)<sp/>{</highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/>$file_handle<sp/>=<sp/>fopen(</highlight><highlight class="stringliteral">&apos;/tmp/tripal_bulk_loader_progress-&apos;</highlight><highlight class="normal">.<sp/>$job_id<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;.out&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="charliteral">&apos;w&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/><sp/><sp/>variable_set(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_progress_file_handle&apos;</highlight><highlight class="normal">,<sp/>$file_handle);</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"></highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($record_added)<sp/>{</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"><sp/><sp/><sp/><sp/>fwrite($file_handle,<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"></highlight></codeline>
<codeline lineno="1177"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($line_complete)<sp/>{</highlight></codeline>
<codeline lineno="1178"><highlight class="normal"><sp/><sp/><sp/><sp/>fwrite($file_handle,<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"></highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>close<sp/>the<sp/>file<sp/>if<sp/>finished</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1182"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($close)<sp/>{</highlight></codeline>
<codeline lineno="1183"><highlight class="normal"><sp/><sp/><sp/><sp/>fclose($file_handle);</highlight></codeline>
<codeline lineno="1184"><highlight class="normal"><sp/><sp/><sp/><sp/>variable_set(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader_progress_file_handle&apos;</highlight><highlight class="normal">,<sp/>NULL);</highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1186"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"></highlight></codeline>
<codeline lineno="1193" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a937777f2c235ca69b81ffcd1ecf2efb3" kindref="member">tripal_bulk_loader_throw_error</ref>($msg,<sp/>$args,<sp/>$severity)<sp/>{</highlight></codeline>
<codeline lineno="1194"><highlight class="normal"><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref><sp/>=<sp/>array(</highlight><highlight class="stringliteral">&apos;print&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>TRUE);</highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($severity<sp/>==<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1ad9759873be1ae0c3d8ccc37d121aeb3c" kindref="member">TRIPAL_NOTICE</ref><sp/>OR<sp/>$severity<sp/>==<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1ae3246842a9b0bc4b8ecf2951cb1a949a" kindref="member">TRIPAL_INFO</ref><sp/>OR<sp/>$severity<sp/>==<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4199d13e9eb402a5881442421a0d8099" kindref="member">TRIPAL_DEBUG</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"><sp/><sp/><sp/><sp/>unset(<ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref>[</highlight><highlight class="stringliteral">&apos;print&apos;</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"></highlight></codeline>
<codeline lineno="1199"><highlight class="normal"><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight></codeline>
<codeline lineno="1200"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;tripal_bulk&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1201"><highlight class="normal"><sp/><sp/><sp/><sp/>$severity,</highlight></codeline>
<codeline lineno="1202"><highlight class="normal"><sp/><sp/><sp/><sp/>$msg,</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/><sp/><sp/>$args,</highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d5/d66/tripal__organism__properties_8tpl_8php_1a011800c63ece4cbbfa77136a20607023" kindref="member">$options</ref></highlight></codeline>
<codeline lineno="1205"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="1206"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"></highlight></codeline>
<codeline lineno="1213" refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a8e75f5e948ddf5dab63f2f77800b82da" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="dd/d2a/tripal__bulk__loader_8loader_8inc_1a8e75f5e948ddf5dab63f2f77800b82da" kindref="member">tripal_bulk_loader_finish_loading</ref>($nid,<sp/>$loaded_without_errors)<sp/>{</highlight></codeline>
<codeline lineno="1214"><highlight class="normal"></highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>the<sp/>status<sp/>of<sp/>the<sp/>job<sp/>(in<sp/>the<sp/>node<sp/>not<sp/>the<sp/>tripal<sp/>jobs)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($loaded_without_errors)<sp/>{</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/><sp/><sp/>$status<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;Loading<sp/>Completed<sp/>Successfully&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/>$status<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;Errors<sp/>Encountered&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1222"><highlight class="normal"><sp/><sp/>db_update(</highlight><highlight class="stringliteral">&apos;tripal_bulk_loader&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(array(</highlight><highlight class="stringliteral">&apos;job_status&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$status))</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">,<sp/>$nid)</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline lineno="1226"><highlight class="normal"></highlight></codeline>
<codeline lineno="1227"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!$loaded_without_errors)<sp/>{</highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/><sp/><sp/>drush_set_error(</highlight><highlight class="stringliteral">&apos;BULK_LOAD_FAILED&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;Execution<sp/>aborted<sp/>due<sp/>to<sp/>errors.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"><sp/><sp/><sp/><sp/>exit();</highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1231"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="tripal_bulk_loader/includes/tripal_bulk_loader.loader.inc"/>
  </compounddef>
</doxygen>

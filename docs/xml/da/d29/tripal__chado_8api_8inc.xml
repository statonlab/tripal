<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.15">
  <compounddef id="da/d29/tripal__chado_8api_8inc" kind="file" language="PHP">
    <compoundname>tripal_chado.api.inc</compoundname>
      <sectiondef kind="func">
      <memberdef kind="function" id="d5/db8/group__tripal__chado__api_1ga3dbd8ba8743f7d742963a7323cb4a960" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_get_tokens</definition>
        <argsstring>($base_table)</argsstring>
        <name>chado_get_tokens</name>
        <param>
          <declname>$base_table</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns an array of tokens based on Tripal Entity Fields.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$base_table</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of a base table in Chado. </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>An array of tokens where the key is the machine_name of the token. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.api.inc" line="321" column="1" bodyfile="tripal_chado/api/tripal_chado.api.inc" bodystart="321" bodyend="362"/>
      </memberdef>
      <memberdef kind="function" id="d5/db8/group__tripal__chado__api_1gaf3e6c2a98f3e9ca76d67cbda86a0fe2b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_publish_records</definition>
        <argsstring>($values, $job_id=NULL)</argsstring>
        <name>chado_publish_records</name>
        <param>
          <declname>$values</declname>
        </param>
        <param>
          <declname>$job_id</declname>
          <defval>NULL</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Publishes content in Chado as a new <ref refid="db/d44/classTripalEntity" kindref="compound">TripalEntity</ref> entity.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>$values</parametername>
</parameternamelist>
<parameterdescription>
<para>A key/value associative array that supports the following keys:<itemizedlist>
<listitem><para>bundle_name: The name of the the <ref refid="d4/daf/classTripalBundle" kindref="compound">TripalBundle</ref> (e.g. bio_data-12345). </para></listitem></itemizedlist>
</para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$job_id</parametername>
</parameternamelist>
<parameterdescription>
<para>(Optional) The numeric job ID as provided by the Tripal jobs system. There is no need to specify this argument if this function is being called outside of the jobs systems.</para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>boolean TRUE if all of the records of the given bundle type were published, and FALSE if a failure occured. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.api.inc" line="40" column="1" bodyfile="tripal_chado/api/tripal_chado.api.inc" bodystart="40" bodyend="309"/>
      </memberdef>
      <memberdef kind="function" id="d5/db8/group__tripal__chado__api_1ga45a053b33a6f2968ba83788a420e6f80" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>chado_replace_tokens</definition>
        <argsstring>($string, $record)</argsstring>
        <name>chado_replace_tokens</name>
        <param>
          <declname>$string</declname>
        </param>
        <param>
          <declname>$record</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Replace all Chado Tokens in a given string.</para><para>NOTE: If there is no value for a token then the token is removed.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametertype>string</parametertype>
<parametername>$string</parametername>
</parameternamelist>
<parameterdescription>
<para>The string containing tokens. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>$record</parametername>
</parameternamelist>
<parameterdescription>
<para>A Chado record as generated by <ref refid="dd/d88/group__tripal__chado__variables__api_1ga6d6af1f6e23e5bbfae0d7867ce09af5a" kindref="member">chado_generate_var()</ref></para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The string will all tokens replaced with values. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="tripal_chado/api/tripal_chado.api.inc" line="379" column="1" bodyfile="tripal_chado/api/tripal_chado.api.inc" bodystart="379" bodyend="426"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
<para>This file contains miscellaneous API functions specific to working with records in Chado that do not have a home in any other sub category of API functions. </para>    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal">&lt;?php</highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="40" refid="d5/db8/group__tripal__chado__api_1gaf3e6c2a98f3e9ca76d67cbda86a0fe2b" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d5/db8/group__tripal__chado__api_1gaf3e6c2a98f3e9ca76d67cbda86a0fe2b" kindref="member">chado_publish_records</ref>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>,<sp/>$job_id<sp/>=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Used<sp/>for<sp/>adding<sp/>runtime<sp/>to<sp/>the<sp/>progress<sp/>report.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/>$started_at<sp/>=<sp/>microtime(</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>want<sp/>the<sp/>job<sp/>object<sp/>in<sp/>order<sp/>to<sp/>report<sp/>progress.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_object($job_id))<sp/>{</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/>$job<sp/>=<sp/>$job_id;</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_numeric($job_id))<sp/>{</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/>$job<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="d5/d64/classTripalJob" kindref="compound">TripalJob</ref>();</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/>$job-&gt;load($job_id);</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/>$report_progress<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_object($job))<sp/>{</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/>$report_progress<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="57"><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>an<sp/>array<sp/>for<sp/>caching<sp/>objects<sp/>to<sp/>save<sp/>performance.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/>$cache<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>we<sp/>have<sp/>the<sp/>required<sp/>options:<sp/>bundle_name.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;bundle_name&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>or<sp/>!<ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[</highlight><highlight class="stringliteral">&apos;bundle_name&apos;</highlight><highlight class="normal">])<sp/>{</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>publish<sp/>record:<sp/>@error&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;@error&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;The<sp/>bundle<sp/>name<sp/>must<sp/>be<sp/>provided&apos;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>incoming<sp/>arguments<sp/>from<sp/>the<sp/>$values<sp/>array.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/>$bundle_name<sp/>=<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[</highlight><highlight class="stringliteral">&apos;bundle_name&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/>$filters<sp/>=<sp/>array_key_exists(</highlight><highlight class="stringliteral">&apos;filters&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>?<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[</highlight><highlight class="stringliteral">&apos;filters&apos;</highlight><highlight class="normal">]<sp/>:<sp/>array();</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/>$sync_node<sp/>=<sp/>array_key_exists(</highlight><highlight class="stringliteral">&apos;sync_node&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>)<sp/>?<sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1affc45c6ace2eeb3f300b054dbf9592b6" kindref="member">$values</ref>[</highlight><highlight class="stringliteral">&apos;sync_node&apos;</highlight><highlight class="normal">]<sp/>:<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>want<sp/>to<sp/>break<sp/>the<sp/>number<sp/>of<sp/>records<sp/>to<sp/>publish<sp/>into<sp/>chunks<sp/>in<sp/>order<sp/>to<sp/>ensure</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>do<sp/>not<sp/>run<sp/>for<sp/>too<sp/>long<sp/>(performance<sp/>issue).<sp/>The<sp/>number<sp/>of<sp/>records</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>be<sp/>processed<sp/>per<sp/>chunk<sp/>is<sp/>set<sp/>here:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/>$chunk_size<sp/>=<sp/>500;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Load<sp/>the<sp/>bundle<sp/>entity<sp/>so<sp/>we<sp/>can<sp/>get<sp/>information<sp/>about<sp/>which<sp/>Chado</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>table/field<sp/>this<sp/>entity<sp/>belongs<sp/>to.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/>$bundle<sp/>=<sp/><ref refid="d5/dce/group__tripal__entities__api_1ga5f53c10c88edbd9405697ffd7bca2094" kindref="member">tripal_load_bundle_entity</ref>(array(</highlight><highlight class="stringliteral">&apos;name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$bundle_name));</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/>$cache[</highlight><highlight class="stringliteral">&apos;bundle&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$bundle;</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$bundle)<sp/>{</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Unknown<sp/>bundle.<sp/>Could<sp/>not<sp/>publish<sp/>record:<sp/>@error&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;@error&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/></highlight><highlight class="stringliteral">&apos;The<sp/>bundle<sp/>name<sp/>must<sp/>be<sp/>provided&apos;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/>$chado_entity_table<sp/>=<sp/><ref refid="dd/d83/group__tripal__chado__entity__api_1gade39580cff59082ed7d9e3774703631a" kindref="member">chado_get_bundle_entity_table</ref>($bundle);</highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>mapping<sp/>of<sp/>the<sp/>bio<sp/>data<sp/>type<sp/>to<sp/>the<sp/>Chado<sp/>table.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/>$chado_bundle<sp/>=<sp/>db_select(</highlight><highlight class="stringliteral">&apos;chado_bundle&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;cb&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fields(</highlight><highlight class="stringliteral">&apos;cb&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;condition(</highlight><highlight class="stringliteral">&apos;bundle_id&apos;</highlight><highlight class="normal">,<sp/>$bundle-&gt;id)</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;execute()</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/>-&gt;fetchObject();</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!$chado_bundle)<sp/>{</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Cannot<sp/>find<sp/>mapping<sp/>of<sp/>bundle<sp/>to<sp/>Chado<sp/>tables.<sp/>Could<sp/>not<sp/>publish<sp/>record.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Load<sp/>the<sp/>term<sp/>for<sp/>use<sp/>in<sp/>setting<sp/>the<sp/>alias<sp/>for<sp/>each<sp/>entity<sp/>created.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/>$term<sp/>=<sp/>entity_load(</highlight><highlight class="stringliteral">&apos;TripalTerm&apos;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$entity-&gt;term_id));</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/>$cache[</highlight><highlight class="stringliteral">&apos;term&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$term;</highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>=<sp/>$chado_bundle-&gt;data_table;</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/>$type_column<sp/>=<sp/>$chado_bundle-&gt;type_column;</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/>$type_linker_table<sp/>=<sp/>$chado_bundle-&gt;type_linker_table;</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/>$cvterm_id<sp/><sp/>=<sp/>$chado_bundle-&gt;type_id;</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/>$type_value<sp/>=<sp/>$chado_bundle-&gt;type_value;</highlight></codeline>
<codeline lineno="112"><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>table<sp/>information<sp/>for<sp/>the<sp/>Chado<sp/>table.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/>$table_schema<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>);</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/>$pkey_field<sp/>=<sp/>$table_schema[</highlight><highlight class="stringliteral">&apos;primary<sp/>key&apos;</highlight><highlight class="normal">][0];</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>the<sp/>SQL<sp/>for<sp/>identifying<sp/>which<sp/>records<sp/>should<sp/>be<sp/>published.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/>$args<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/>$select<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>T.$pkey_field<sp/>as<sp/>record_id<sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/>$from<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;</highlight></codeline>
<codeline lineno="121"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>FROM<sp/>{&quot;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.<sp/></highlight><highlight class="stringliteral">&quot;}<sp/>T</highlight></codeline>
<codeline lineno="122"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/>LEFT<sp/>JOIN<sp/>[&quot;</highlight><highlight class="normal"><sp/>.<sp/>$chado_entity_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;]<sp/>CE<sp/>on<sp/>CE.record_id<sp/>=<sp/>T.$pkey_field</highlight></codeline>
<codeline lineno="123"><highlight class="stringliteral"><sp/><sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>migration<sp/>of<sp/>Tripal<sp/>v2<sp/>nodes<sp/>to<sp/>entities<sp/>we<sp/>want<sp/>to<sp/>include<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>coresponding<sp/>chado<sp/>linker<sp/>table.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($sync_node<sp/>&amp;&amp;<sp/>db_table_exists(</highlight><highlight class="stringliteral">&apos;chado_&apos;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>))<sp/>{</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/>$select<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>T.$pkey_field<sp/>as<sp/>record_id,<sp/>CT.nid<sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/>$from<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;<sp/>INNER<sp/>JOIN<sp/>[chado_&quot;</highlight><highlight class="normal"><sp/>.<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>.<sp/></highlight><highlight class="stringliteral">&quot;]<sp/>CT<sp/>ON<sp/>CT.$pkey_field<sp/>=<sp/>T.$pkey_field&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/>$where<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;<sp/>WHERE<sp/>CE.record_id<sp/>IS<sp/>NULL<sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Handle<sp/>records<sp/>that<sp/>are<sp/>mapped<sp/>to<sp/>property<sp/>tables.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($type_linker_table<sp/>and<sp/>$type_column<sp/>and<sp/>$type_value)<sp/>{</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/>$propschema<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>($type_linker_table);</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/>$fkeys<sp/>=<sp/>$propschema[</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">][<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>][</highlight><highlight class="stringliteral">&apos;columns&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($fkeys<sp/>as<sp/>$leftkey<sp/>=&gt;<sp/>$rightkey)<sp/>{</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($rightkey<sp/>==<sp/>$pkey_field)<sp/>{</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$from<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;<sp/>INNER<sp/>JOIN<sp/>{&quot;</highlight><highlight class="normal"><sp/>.<sp/>$type_linker_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;}<sp/>LT<sp/>ON<sp/>T.$pkey_field<sp/>=<sp/>LT.$leftkey<sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/>$where<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;AND<sp/>LT.$type_column<sp/>=<sp/>:cvterm_id<sp/>and<sp/>LT.value<sp/>=<sp/>:prop_value&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>$args[</highlight><highlight class="stringliteral">&apos;:cvterm_id&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$cvterm_id;</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/>$args[</highlight><highlight class="stringliteral">&apos;:prop_value&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$type_value;</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Handle<sp/>records<sp/>that<sp/>are<sp/>mapped<sp/>to<sp/>cvterm<sp/>linking<sp/>tables.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($type_linker_table<sp/>and<sp/>$type_column<sp/>and<sp/>!$type_value)<sp/>{</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/>$cvtschema<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>($type_linker_table);</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/>$fkeys<sp/>=<sp/>$cvtschema[</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">][<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>][</highlight><highlight class="stringliteral">&apos;columns&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($fkeys<sp/>as<sp/>$leftkey<sp/>=&gt;<sp/>$rightkey)<sp/>{</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($rightkey<sp/>==<sp/>$pkey_field)<sp/>{</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$from<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;<sp/>INNER<sp/>JOIN<sp/>{&quot;</highlight><highlight class="normal"><sp/>.<sp/>$type_linker_table<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;}<sp/>LT<sp/>ON<sp/>T.$pkey_field<sp/>=<sp/>LT.$leftkey<sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/>$where<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;AND<sp/>LT.$type_column<sp/>=<sp/>:cvterm_id&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/>$args[</highlight><highlight class="stringliteral">&apos;:cvterm_id&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$cvterm_id;</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="159"><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Handle<sp/>records<sp/>that<sp/>are<sp/>mapped<sp/>via<sp/>a<sp/>type_id<sp/>column<sp/>in<sp/>the<sp/>base<sp/>table.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$type_linker_table<sp/>and<sp/>$type_column)<sp/>{</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/>$where<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;AND<sp/>T.$type_column<sp/>=<sp/>:cvterm_id&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/>$args[</highlight><highlight class="stringliteral">&apos;:cvterm_id&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$cvterm_id;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="165"><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Handle<sp/>the<sp/>case<sp/>where<sp/>records<sp/>are<sp/>in<sp/>the<sp/>cvterm<sp/>table<sp/>and<sp/>mapped<sp/>via<sp/>a<sp/>single</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>vocab.<sp/><sp/>Here<sp/>we<sp/>use<sp/>the<sp/>type_value<sp/>for<sp/>the<sp/>cv_id.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>==<sp/></highlight><highlight class="stringliteral">&apos;cvterm&apos;</highlight><highlight class="normal"><sp/>and<sp/>$type_value)<sp/>{</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/>$where<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;AND<sp/>T.cv_id<sp/>=<sp/>:cv_id&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/>$args[</highlight><highlight class="stringliteral">&apos;:cv_id&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$type_value;</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Handle<sp/>the<sp/>case<sp/>where<sp/>records<sp/>are<sp/>in<sp/>the<sp/>cvterm<sp/>table<sp/>but<sp/>we<sp/>want<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>use<sp/>all<sp/>of<sp/>the<sp/>child<sp/>terms.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>==<sp/></highlight><highlight class="stringliteral">&apos;cvterm&apos;</highlight><highlight class="normal"><sp/>and<sp/>!$type_value)<sp/>{</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/>$where<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;AND<sp/>T.cvterm_id<sp/>IN<sp/>(</highlight></codeline>
<codeline lineno="177"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SELECT<sp/>CVTP.subject_id</highlight></codeline>
<codeline lineno="178"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FROM<sp/>{cvtermpath}<sp/>CVTP</highlight></codeline>
<codeline lineno="179"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>WHERE<sp/>CVTP.object_id<sp/>=<sp/>:cvterm_id)</highlight></codeline>
<codeline lineno="180"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/>$args[</highlight><highlight class="stringliteral">&apos;:cvterm_id&apos;</highlight><highlight class="normal">]<sp/>=<sp/>$cvterm_id;</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>add<sp/>in<sp/>any<sp/>additional<sp/>filters</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><ref refid="d2/ded/tripal__bulk__loader__fields_8tpl_8php_1ab2303c817e3b402b77b7f99627b9c319" kindref="member">$fields</ref><sp/>=<sp/>field_info_field_map();</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="d2/ded/tripal__bulk__loader__fields_8tpl_8php_1ab2303c817e3b402b77b7f99627b9c319" kindref="member">$fields</ref><sp/>as<sp/>$field_name<sp/>=&gt;<sp/>$details)<sp/>{</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;TripalEntity&apos;</highlight><highlight class="normal">,<sp/>$details[</highlight><highlight class="stringliteral">&apos;bundles&apos;</highlight><highlight class="normal">])<sp/>and</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>in_array($bundle_name,<sp/>$details[</highlight><highlight class="stringliteral">&apos;bundles&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;TripalEntity&apos;</highlight><highlight class="normal">])<sp/>and</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>in_array($field_name,<sp/>array_keys($filters))){</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$instance<sp/>=<sp/>field_info_instance(</highlight><highlight class="stringliteral">&apos;TripalEntity&apos;</highlight><highlight class="normal">,<sp/>$field_name,<sp/>$bundle_name);</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$chado_table<sp/>=<sp/>$instance[</highlight><highlight class="stringliteral">&apos;settings&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;chado_table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$chado_column<sp/>=<sp/>$instance[</highlight><highlight class="stringliteral">&apos;settings&apos;</highlight><highlight class="normal">][</highlight><highlight class="stringliteral">&apos;chado_column&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($chado_table<sp/>==<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>)<sp/>{</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$where<sp/>.=<sp/></highlight><highlight class="stringliteral">&quot;<sp/>AND<sp/>T.$chado_column<sp/>=<sp/>:$field_name&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$args[</highlight><highlight class="stringliteral">&quot;:$field_name&quot;</highlight><highlight class="normal">]<sp/>=<sp/>$filters[$field_name];</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>get<sp/>the<sp/>count</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>@performance<sp/>optimize,<sp/>estimate<sp/>or<sp/>remove<sp/>this.<sp/>It&apos;s<sp/>only<sp/>used<sp/>for<sp/>reporting<sp/>progress<sp/>on<sp/>the<sp/>command-line.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/>$sql<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>count(*)<sp/>as<sp/>num_records<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$from<sp/>.<sp/>$where;</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/>$result<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>($sql,<sp/>$args);</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/>$count<sp/>=<sp/>$result-&gt;fetchField();</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\nThere<sp/>are<sp/>$count<sp/>records<sp/>to<sp/>publish.\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="206"><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/>print<sp/></highlight><highlight class="stringliteral">&quot;\nNOTE:<sp/>publishing<sp/>records<sp/>is<sp/>performed<sp/>using<sp/>database<sp/>transactions.<sp/>If<sp/>the<sp/>job<sp/>fails\n&quot;</highlight><highlight class="normal"><sp/>.</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;or<sp/>is<sp/>terminated<sp/>prematurely<sp/>then<sp/>the<sp/>current<sp/>set<sp/>of<sp/>$chunk_size<sp/>is<sp/>rolled<sp/>back<sp/>with\n&quot;</highlight><highlight class="normal"><sp/>.</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;no<sp/>changes<sp/>to<sp/>the<sp/>database.<sp/>Simply<sp/>re-run<sp/>the<sp/>publishing<sp/>job<sp/>to<sp/>publish<sp/>any<sp/>remaining\n&quot;</highlight><highlight class="normal">.</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;content<sp/>after<sp/>fixing<sp/>the<sp/>issue<sp/>that<sp/>caused<sp/>the<sp/>job<sp/>to<sp/>fail.\n\n&quot;</highlight><highlight class="normal"><sp/>.</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Also,<sp/>the<sp/>following<sp/>progress<sp/>only<sp/>updates<sp/>every<sp/>$chunk_size<sp/>records.\n&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Perform<sp/>the<sp/>query.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/>$sql<sp/>=<sp/>$select<sp/>.<sp/>$from<sp/>.<sp/>$where<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>LIMIT<sp/>&apos;</highlight><highlight class="normal">.$chunk_size;</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/>$more_records_to_publish<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/>$total_published<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>($more_records_to_publish)<sp/>{</highlight></codeline>
<codeline lineno="218"><highlight class="normal"></highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/>$records<sp/>=<sp/><ref refid="de/dc4/group__tripal__chado__query__api_1ga73e802bb6e6daa31f712682939c270fb" kindref="member">chado_query</ref>($sql,<sp/>$args);</highlight></codeline>
<codeline lineno="220"><highlight class="normal"></highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>the<sp/>job<sp/>status<sp/>every<sp/>chunk<sp/>start.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Because<sp/>this<sp/>is<sp/>outside<sp/>of<sp/>hte<sp/>transaction,<sp/>we<sp/>can<sp/>update<sp/>the<sp/>admin<sp/>through<sp/>the<sp/>jobs<sp/>UI.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/>$complete<sp/>=<sp/>($total_published<sp/>/<sp/>$count)<sp/>*<sp/>33.33333333;</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($report_progress)<sp/>{<sp/>$job-&gt;setProgress(intval($complete<sp/>*<sp/>3));<sp/>}</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($total_published<sp/>===<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;%d<sp/>of<sp/>%d<sp/>records.<sp/>(%0.2f%%)<sp/>Memory:<sp/>%s<sp/>bytes.\r&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$i,<sp/>$count,<sp/>0,<sp/>number_format(memory_get_usage()),<sp/>0);</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;%d<sp/>of<sp/>%d<sp/>records.<sp/>(%0.2f%%)<sp/>Memory:<sp/>%s<sp/>bytes;<sp/>Current<sp/>run<sp/>time:<sp/>%s<sp/>minutes.\r&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$total_published,<sp/>$count,<sp/>$complete<sp/>*<sp/>3,<sp/>number_format(memory_get_usage()),<sp/>number_format((microtime(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>-<sp/>$started_at)/60,<sp/>2));</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="233"><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>is<sp/>no<sp/>need<sp/>to<sp/>cache<sp/>transactions<sp/>since<sp/>Drupal<sp/>handles<sp/>nested<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>&quot;by<sp/>performing<sp/>no<sp/>transactional<sp/>operations<sp/>(as<sp/>far<sp/>as<sp/>the<sp/>database<sp/>sees)<sp/>within</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>inner<sp/>nesting<sp/>layers&quot;.<sp/>Effectively,<sp/>Drupal<sp/>ensures<sp/>nested<sp/>trasactions<sp/>work<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>same<sp/>as<sp/>passing<sp/>a<sp/>transaction<sp/>through<sp/>to<sp/>the<sp/>deepest<sp/>level<sp/>and<sp/>not<sp/>starting<sp/>a<sp/>new</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>if<sp/>we<sp/>are<sp/>already<sp/>in<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/>$transaction<sp/>=<sp/>db_transaction();</highlight></codeline>
<codeline lineno="240"><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(<ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref><sp/>=<sp/>$records-&gt;fetchObject())<sp/>{</highlight></codeline>
<codeline lineno="244"><highlight class="normal"></highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>save<sp/>the<sp/>tripal_entity<sp/>record.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>@performace<sp/>This<sp/>is<sp/>likely<sp/>a<sp/>bottleneck.<sp/>Too<sp/>bad<sp/>we<sp/>can&apos;t<sp/>create</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>multiple<sp/>entities<sp/>at<sp/>once...<sp/>sort<sp/>of<sp/>like<sp/>the<sp/>copy<sp/>method.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$record_id<sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;record_id;</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$ec<sp/>=<sp/>entity_get_controller(</highlight><highlight class="stringliteral">&apos;TripalEntity&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$entity<sp/>=<sp/>$ec-&gt;create(array(</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;bundle&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$bundle_name,</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;term_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$bundle-&gt;term_id,</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>in<sp/>the<sp/>Chado<sp/>details<sp/>for<sp/>when<sp/>the<sp/>hook_entity_create()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>called<sp/>and<sp/>our<sp/>tripal_chado_entity_create()<sp/>implementation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>can<sp/>deal<sp/>with<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;chado_record&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/><ref refid="dd/d88/group__tripal__chado__variables__api_1ga6d6af1f6e23e5bbfae0d7867ce09af5a" kindref="member">chado_generate_var</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>,<sp/>array($pkey_field<sp/>=&gt;<sp/>$record_id),<sp/>array(</highlight><highlight class="stringliteral">&apos;include_fk&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>0)),</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;chado_record_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$record_id,</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;publish&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>TRUE,</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;bundle_object&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$bundle,</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>));</highlight></codeline>
<codeline lineno="262"><highlight class="normal"></highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$entity<sp/>=<sp/>$entity-&gt;save($cache);</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$entity)<sp/>{</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>Exception(</highlight><highlight class="stringliteral">&apos;Could<sp/>not<sp/>create<sp/>entity.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Next<sp/>save<sp/>the<sp/>chado<sp/>entity<sp/>record.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$entity_record<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;entity_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$entity-&gt;id,</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;record_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$record_id,</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>the<sp/>Tv2<sp/>to<sp/>Tv3<sp/>migration<sp/>we<sp/>want<sp/>to<sp/>add<sp/>the<sp/>nid<sp/>to<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>entity<sp/>so<sp/>we<sp/>can<sp/>associate<sp/>the<sp/>node<sp/>with<sp/>the<sp/>entity.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(property_exists(<ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>,<sp/></highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$entity_record[</highlight><highlight class="stringliteral">&apos;nid&apos;</highlight><highlight class="normal">]<sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;nid;</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$result<sp/>=<sp/>db_insert($chado_entity_table)</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;fields($entity_record)</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-&gt;execute();</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!$result){</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>Exception(</highlight><highlight class="stringliteral">&apos;Could<sp/>not<sp/>create<sp/>mapping<sp/>of<sp/>entity<sp/>to<sp/>Chado<sp/>record.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$i++;</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$total_published++;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>$e)<sp/>{</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$transaction-&gt;rollback();</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$error<sp/>=<sp/>$e-&gt;getMessage();</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>publish<sp/>record:<sp/>@error&quot;</highlight><highlight class="normal">,<sp/>array(</highlight><highlight class="stringliteral">&apos;@error&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$error));</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>drupal_set_message(</highlight><highlight class="stringliteral">&apos;Failed<sp/>publishing<sp/>record.<sp/>See<sp/>recent<sp/>logs<sp/>for<sp/>more<sp/>details.&apos;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&apos;error&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="297"><highlight class="normal"></highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>get<sp/>through<sp/>the<sp/>loop<sp/>and<sp/>haven&apos;t<sp/>completed<sp/>100<sp/>records,<sp/>then<sp/>we&apos;re<sp/>done!</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($i<sp/>&lt;<sp/>$chunk_size)<sp/>{</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$more_records_to_publish<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="302"><highlight class="normal"></highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Commit<sp/>our<sp/>current<sp/>chunk.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/>unset($transaction);</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="306"><highlight class="normal"></highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/>drupal_set_message(</highlight><highlight class="stringliteral">&quot;Succesfully<sp/>published<sp/>$total_published<sp/>&quot;</highlight><highlight class="normal"><sp/>.<sp/>$bundle-&gt;label<sp/>.<sp/></highlight><highlight class="stringliteral">&quot;<sp/>record(s).&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="309"><highlight class="normal">}</highlight></codeline>
<codeline lineno="310"><highlight class="normal"></highlight></codeline>
<codeline lineno="321" refid="d5/db8/group__tripal__chado__api_1ga3dbd8ba8743f7d742963a7323cb4a960" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d5/db8/group__tripal__chado__api_1ga3dbd8ba8743f7d742963a7323cb4a960" kindref="member">chado_get_tokens</ref>($base_table)<sp/>{</highlight></codeline>
<codeline lineno="322"><highlight class="normal"></highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/>$tokens<sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/>$table_descrip<sp/>=<sp/><ref refid="d4/d51/group__tripal__chado__schema__api_1ga4b5ac309e4f88af0e2454099336ac1d8" kindref="member">chado_get_schema</ref>($base_table);</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($table_descrip[</highlight><highlight class="stringliteral">&apos;fields&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$field_name<sp/>=&gt;<sp/>$field_details)<sp/>{</highlight></codeline>
<codeline lineno="326"><highlight class="normal"></highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/>$token<sp/>=<sp/></highlight><highlight class="charliteral">&apos;[&apos;</highlight><highlight class="normal"><sp/>.<sp/>$base_table<sp/>.<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal"><sp/>.<sp/>$field_name<sp/>.<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/>$location<sp/>=<sp/>implode(</highlight><highlight class="stringliteral">&apos;<sp/>&gt;<sp/>&apos;</highlight><highlight class="normal">,array($base_table,<sp/>$field_name));</highlight></codeline>
<codeline lineno="329"><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/>$tokens[$token]<sp/>=<sp/>array(</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;name&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>ucwords(str_replace(</highlight><highlight class="charliteral">&apos;_&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">,$base_table))<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;:<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>ucwords(str_replace(</highlight><highlight class="charliteral">&apos;_&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">,$field_name)),</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$base_table,</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;field&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$field_name,</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;token&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$token,</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;description&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>array_key_exists(</highlight><highlight class="stringliteral">&apos;description&apos;</highlight><highlight class="normal">,<sp/>$field_details)<sp/>?<sp/>$field_details[</highlight><highlight class="stringliteral">&apos;description&apos;</highlight><highlight class="normal">]<sp/>:<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;location&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$location</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="338"><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!array_key_exists(</highlight><highlight class="stringliteral">&apos;description&apos;</highlight><highlight class="normal">,<sp/>$field_details)<sp/>or<sp/>preg_match(</highlight><highlight class="stringliteral">&apos;/TODO/&apos;</highlight><highlight class="normal">,$field_details[</highlight><highlight class="stringliteral">&apos;description&apos;</highlight><highlight class="normal">]))<sp/>{</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$tokens[$token][</highlight><highlight class="stringliteral">&apos;description&apos;</highlight><highlight class="normal">]<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;The<sp/>&apos;</highlight><highlight class="normal">.$field_name.</highlight><highlight class="stringliteral">&apos;<sp/>field<sp/>of<sp/>the<sp/>&apos;</highlight><highlight class="normal">.$base_table.</highlight><highlight class="stringliteral">&apos;<sp/>table.&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="343"><highlight class="normal"></highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>RECURSION:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Follow<sp/>the<sp/>foreign<sp/>key<sp/>relationships<sp/>recursively</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(array_key_exists(</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">,<sp/>$table_descrip))<sp/>{</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($table_descrip[</highlight><highlight class="stringliteral">&apos;foreign<sp/>keys&apos;</highlight><highlight class="normal">]<sp/>as<sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>=&gt;<sp/>$details)<sp/>{</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($details[</highlight><highlight class="stringliteral">&apos;columns&apos;</highlight><highlight class="normal">]<sp/>as<sp/>$left_field<sp/>=&gt;<sp/>$right_field)<sp/>{</highlight></codeline>
<codeline lineno="349"><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$sub_token_prefix<sp/>=<sp/>$base_table<sp/>.<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal"><sp/>.<sp/>$left_field;</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$sub_location_prefix<sp/>=<sp/>implode(</highlight><highlight class="stringliteral">&apos;<sp/>&gt;<sp/>&apos;</highlight><highlight class="normal">,array($base_table,<sp/>$left_field));</highlight></codeline>
<codeline lineno="352"><highlight class="normal"></highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$sub_tokens<sp/>=<sp/><ref refid="d5/db8/group__tripal__chado__api_1ga3dbd8ba8743f7d742963a7323cb4a960" kindref="member">chado_get_tokens</ref>(<ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref>);</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_array($sub_tokens))<sp/>{</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$tokens<sp/>=<sp/>array_merge($tokens,<sp/>$sub_tokens);</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="360"><highlight class="normal"></highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$tokens;</highlight></codeline>
<codeline lineno="362"><highlight class="normal">}</highlight></codeline>
<codeline lineno="363"><highlight class="normal"></highlight></codeline>
<codeline lineno="379" refid="d5/db8/group__tripal__chado__api_1ga45a053b33a6f2968ba83788a420e6f80" refkind="member"><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d5/db8/group__tripal__chado__api_1ga45a053b33a6f2968ba83788a420e6f80" kindref="member">chado_replace_tokens</ref>($string,<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>)<sp/>{</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>list<sp/>of<sp/>tokens</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/>$tokens<sp/>=<sp/><ref refid="d5/db8/group__tripal__chado__api_1ga3dbd8ba8743f7d742963a7323cb4a960" kindref="member">chado_get_tokens</ref>(<ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>-&gt;tablename);</highlight></codeline>
<codeline lineno="382"><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>which<sp/>tokens<sp/>were<sp/>used<sp/>in<sp/>the<sp/>format<sp/>string</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(preg_match_all(</highlight><highlight class="stringliteral">&apos;/\[[^]]+\]/&apos;</highlight><highlight class="normal">,<sp/>$string,<sp/>$used_tokens))<sp/>{</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>value<sp/>for<sp/>each<sp/>token<sp/>used</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($used_tokens[0]<sp/>as<sp/>$token)<sp/>{</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$token_info<sp/>=<sp/>$tokens[$token];</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!empty($token_info))<sp/>{</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="de/d3f/tripal__bulk__loader__base_8tpl_8php_1aaa4465d9cb3f23c8fc7902e11c65437c" kindref="member">$table</ref><sp/>=<sp/>$token_info[</highlight><highlight class="stringliteral">&apos;table&apos;</highlight><highlight class="normal">];</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$var<sp/>=<sp/><ref refid="d5/d5b/tripal__library__base_8tpl_8php_1acbcb6dcb11c8755d5ffab0b45aac7a22" kindref="member">$record</ref>;</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$value<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"></highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Iterate<sp/>through<sp/>each<sp/>portion<sp/>of<sp/>the<sp/>location<sp/>string.<sp/>An<sp/>example<sp/>string</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>might<sp/>be:<sp/><sp/>stock<sp/>&gt;<sp/>type_id<sp/>&gt;<sp/>name.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$location<sp/>=<sp/>explode(</highlight><highlight class="charliteral">&apos;&gt;&apos;</highlight><highlight class="normal">,<sp/>$token_info[</highlight><highlight class="stringliteral">&apos;location&apos;</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>($location<sp/>as<sp/>$index)<sp/>{</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$index<sp/>=<sp/>trim($index);</highlight></codeline>
<codeline lineno="398"><highlight class="normal"></highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>$var<sp/>is<sp/>an<sp/>object<sp/>then<sp/>it<sp/>is<sp/>the<sp/>$node<sp/>object<sp/>or<sp/>a<sp/>table</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>has<sp/>been<sp/>expanded.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_object($var))<sp/>{</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>to<sp/>see<sp/>if<sp/>the<sp/>index<sp/>is<sp/>a<sp/>member<sp/>of<sp/>the<sp/>object.<sp/>If<sp/>so,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>then<sp/>reset<sp/>the<sp/>$var<sp/>to<sp/>this<sp/>value.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(property_exists($var,<sp/>$index))<sp/>{</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$value<sp/>=<sp/>$var-&gt;$index;</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>the<sp/>$var<sp/>is<sp/>an<sp/>array<sp/>then<sp/>there<sp/>are<sp/>multiple<sp/>instances<sp/>of<sp/>the<sp/>same</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>table<sp/>in<sp/>a<sp/>FK<sp/>relationship<sp/>(e.g.<sp/>relationship<sp/>tables)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elseif<sp/>(is_array($var))<sp/>{</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$value<sp/>=<sp/>$var[$index];</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="d9/dae/group__tripal__notify__api_1ga2240e326e18c3074843ac815e4629ee2" kindref="member">tripal_report_error</ref>(</highlight><highlight class="stringliteral">&apos;tripal_chado&apos;</highlight><highlight class="normal">,<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a179264461824ee52a7a08ebef9150e4b" kindref="member">TRIPAL_WARNING</ref>,</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;Tokens:<sp/>Unable<sp/>to<sp/>determine<sp/>the<sp/>value<sp/>of<sp/>%token.<sp/>Things<sp/>went<sp/>awry<sp/>when<sp/>trying<sp/>&apos;</highlight><highlight class="normal"><sp/>.</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;to<sp/>access<sp/>\&apos;%index\&apos;<sp/>for<sp/>the<sp/>following:<sp/>\&apos;%var\&apos;.&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;%token&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$token,<sp/></highlight><highlight class="stringliteral">&apos;%index&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$index,<sp/></highlight><highlight class="stringliteral">&apos;%var&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>print_r($var,TRUE))</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$string<sp/>=<sp/>str_replace($token,<sp/>$value,<sp/>$string);</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$string;</highlight></codeline>
<codeline lineno="426"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="tripal_chado/api/tripal_chado.api.inc"/>
  </compounddef>
</doxygen>

<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.15">
  <compounddef id="d6/d53/TripalDaemon_8inc" kind="file" language="PHP">
    <compoundname>TripalDaemon.inc</compoundname>
    <innerclass refid="d1/dc1/classTripalDaemon" prot="public">TripalDaemon</innerclass>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
<para>Implements the Tripal Daemon functionality by using the Daemon API. </para>    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal">&lt;?php</highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="14" refid="d1/dc1/classTripalDaemon" refkind="compound"><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="d1/dc1/classTripalDaemon" kindref="compound">TripalDaemon</ref><sp/></highlight><highlight class="keyword">extends</highlight><highlight class="normal"><sp/>DrushDaemon<sp/>{</highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>OPTIONAL:<sp/>Set<sp/>how<sp/>often<sp/>in<sp/>seconds<sp/>your<sp/>executeTask()<sp/>should<sp/>be<sp/>called.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Keep<sp/>in<sp/>mind<sp/>that<sp/>this<sp/>time<sp/>does<sp/>not<sp/>include<sp/>the<sp/>amount<sp/>of<sp/>time<sp/>spent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>executing<sp/>your<sp/>tasks.<sp/>For<sp/>example,<sp/>if<sp/>you<sp/>set<sp/>this<sp/>to<sp/>5<sp/>seconds<sp/>and<sp/>you</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>have<sp/>2<sp/>tasks<sp/>in<sp/>your<sp/>execute_tasks()<sp/>function,<sp/>each<sp/>of<sp/>which<sp/>take<sp/>15</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>seconds,<sp/>then<sp/>your<sp/>loop<sp/>will<sp/>iterate<sp/>(and<sp/>thus<sp/>your<sp/>execute_task()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>function<sp/>will<sp/>be<sp/>called<sp/>again)<sp/>before<sp/>your<sp/>tasks<sp/>finish.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>CODING<sp/>STANDARDS:<sp/>Can&apos;t<sp/>change<sp/>this<sp/>variable<sp/>to<sp/>lowerCamel<sp/>since<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>inherits<sp/>from<sp/>a<sp/>library<sp/>class.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24" refid="d1/dc1/classTripalDaemon_1ab215e4bee4f7b4f2604dda0e1ad9d48d" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1ab215e4bee4f7b4f2604dda0e1ad9d48d" kindref="member">$loop_interval</ref><sp/>=<sp/>20;</highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Keep<sp/>track<sp/>of<sp/>whether<sp/>we<sp/>are<sp/>running<sp/>a<sp/>Tripal<sp/>job<sp/>or<sp/>not</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>if<sp/>so,<sp/>which<sp/>Tripal<sp/>jobs<sp/>are<sp/>we<sp/>running.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>array<sp/>is<sp/>empty<sp/>then<sp/>we<sp/>are<sp/>waiting<sp/>for<sp/>jobs<sp/>;-).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29" refid="d1/dc1/classTripalDaemon_1ac1a229a9652c2330b54a8b78b49802fe" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1ac1a229a9652c2330b54a8b78b49802fe" kindref="member">$tripal_jobs</ref><sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Queue<sp/>of<sp/>Tripal<sp/>Jobs<sp/>waiting<sp/>to<sp/>be<sp/>run.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32" refid="d1/dc1/classTripalDaemon_1a853073c61a3561e00b26e7f2c5e592a1" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1a853073c61a3561e00b26e7f2c5e592a1" kindref="member">$queue</ref><sp/>=<sp/>array();</highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Boolean<sp/>as<sp/>to<sp/>whether<sp/>we<sp/>are<sp/>aloud<sp/>to<sp/>process<sp/>jobs<sp/>in<sp/>parallel.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>@todo:<sp/>Implement<sp/>actually<sp/>changing<sp/>this<sp/>setting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>NOTE:<sp/>Can&apos;t<sp/>be<sp/>set<sp/>via<sp/>a<sp/>drush<sp/>option<sp/>to<sp/>trpjob-daemon<sp/>since</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>tripal<sp/>daemon<sp/>calls<sp/>drush<sp/>daemon<sp/>which<sp/>then<sp/>forks<sp/>and<sp/>can&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>pass<sp/>on<sp/>the<sp/>options<sp/>to<sp/>the<sp/>child.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39" refid="d1/dc1/classTripalDaemon_1afe5323f91f48109a6db38a3cb1ceb60c" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1afe5323f91f48109a6db38a3cb1ceb60c" kindref="member">$do_parallel</ref><sp/>=<sp/>FALSE;<sp/></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Maximum<sp/>number<sp/>of<sp/>jobs<sp/>that<sp/>can<sp/>be<sp/>run<sp/>in<sp/>parallel.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>@todo:<sp/>Implement<sp/>actually<sp/>changing<sp/>this<sp/>setting<sp/>(see<sp/>above<sp/>note).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43" refid="d1/dc1/classTripalDaemon_1afda0e18585c39d5757958d9357913f42" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1afda0e18585c39d5757958d9357913f42" kindref="member">$max_num_jobs</ref><sp/>=<sp/>3;</highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight></codeline>
<codeline lineno="59" refid="d1/dc1/classTripalDaemon_1a7fc1c5d36101cbe8f6664173bc1c66fa" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1a7fc1c5d36101cbe8f6664173bc1c66fa" kindref="member">executeTask</ref>($iteration_number)<sp/>{</highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>jobs<sp/>are<sp/>being<sp/>run<sp/>in<sp/>parallel<sp/>then<sp/>we<sp/>need<sp/>to<sp/>check<sp/>to<sp/>see<sp/>if<sp/>jobs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>think<sp/>are<sp/>running<sp/>have<sp/>actually<sp/>been<sp/>completed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($this-&gt;do_parallel)<sp/>{</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;<ref refid="d1/dc1/classTripalDaemon_1adb0792e21e59145e76a36ffa477aaee8" kindref="member">checkJobStatus</ref>();</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>the<sp/>loop<sp/>by<sp/>seeing<sp/>if<sp/>there<sp/>is<sp/>a<sp/>job<sp/>to<sp/>be<sp/>run<sp/>:-).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/>$job_id<sp/>=<sp/>$this-&gt;<ref refid="d1/dc1/classTripalDaemon_1a419099e112056b59452cc0b26c9a6ede" kindref="member">getTripalJobID</ref>();</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>($job_id)<sp/>{</highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Simply<sp/>run<sp/>the<sp/>job<sp/>:-D.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;<ref refid="d1/dc1/classTripalDaemon_1aa8546f228a9b6686bea8c4f3b514c635" kindref="member">runTripalJob</ref>($job_id);</highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>next<sp/>job<sp/>(if<sp/>we&apos;re<sp/>aloud<sp/>to<sp/>run<sp/>another<sp/>one)...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job_id<sp/>=<sp/>$this-&gt;<ref refid="d1/dc1/classTripalDaemon_1a419099e112056b59452cc0b26c9a6ede" kindref="member">getTripalJobID</ref>();</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>jobs<sp/>are<sp/>being<sp/>run<sp/>in<sp/>parallel<sp/>then<sp/>we<sp/>need<sp/>to<sp/>check<sp/>to<sp/>see<sp/>if<sp/>jobs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>think<sp/>are<sp/>running<sp/>have<sp/>actually<sp/>been<sp/>completed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($this-&gt;do_parallel)<sp/>{</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;<ref refid="d1/dc1/classTripalDaemon_1adb0792e21e59145e76a36ffa477aaee8" kindref="member">checkJobStatus</ref>();</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="84"><highlight class="normal"></highlight></codeline>
<codeline lineno="90" refid="d1/dc1/classTripalDaemon_1a419099e112056b59452cc0b26c9a6ede" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1a419099e112056b59452cc0b26c9a6ede" kindref="member">getTripalJobID</ref>()<sp/>{</highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>we<sp/>need<sp/>to<sp/>determine<sp/>if<sp/>we<sp/>are<sp/>in<sp/>sequenctial<sp/>mode<sp/>or<sp/>parallel<sp/>mode.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Parallel:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($this-&gt;do_parallel)<sp/>{</highlight></codeline>
<codeline lineno="95"><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>we<sp/>arn&apos;t<sp/>already<sp/>running<sp/>the<sp/>maximum<sp/>number<sp/>of<sp/>jobs.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="d0/db7/group__tripal__jobs__api_1ga3de6b96aba36fd173ae6118ce40897c1" kindref="member">tripal_max_jobs_exceeded</ref>($this-&gt;max_num_jobs))<sp/>{</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Already<sp/>running<sp/>the<sp/>maximum<sp/>number<sp/>of<sp/>jobs.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Also<sp/>check<sp/>based<sp/>on<sp/>our<sp/>list<sp/>of<sp/>running<sp/>jobs<sp/>just<sp/>in<sp/>case<sp/>they<sp/>haven&apos;t<sp/>yet<sp/>registered<sp/>in<sp/>the<sp/>db.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">($this-&gt;tripal_jobs)<sp/>&gt;=<sp/>$this-&gt;max_num_jobs)<sp/>{</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Already<sp/>running<sp/>the<sp/>maximum<sp/>number<sp/>of<sp/>jobs.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sequential:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="109"><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>we<sp/>arn&apos;t<sp/>already<sp/>running<sp/>a<sp/>job.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="d0/db7/group__tripal__jobs__api_1gab9662b101766216caf761807eb2d5e6c" kindref="member">tripal_is_job_running</ref>())<sp/>{</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Job<sp/>is<sp/>still<sp/>running.<sp/>Waiting<sp/>until<sp/>it<sp/>completes<sp/>before<sp/>starting<sp/>another<sp/>one.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>reach<sp/>this<sp/>point<sp/>then<sp/>we&apos;re<sp/>aloud<sp/>to<sp/>run<sp/>a<sp/>job!<sp/>:-D.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//-----------------------------------------------------------</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>would<sp/>like<sp/>to<sp/>use<sp/>a<sp/>queue<sp/>to<sp/>keep<sp/>track<sp/>of<sp/>Tripal<sp/>Jobs<sp/>to<sp/>be<sp/>run.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>will<sp/>cut<sp/>down<sp/>on<sp/>the<sp/>number<sp/>of<sp/>queries<sp/>and<sp/>help<sp/>ensure<sp/>that<sp/>the<sp/>same<sp/>job<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>not<sp/>run<sp/>repeatedly<sp/>with<sp/>parallel<sp/>processing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>step,<sp/>fill<sp/>the<sp/>queue<sp/>if<sp/>it&apos;s<sp/>empty.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(empty($this-&gt;queue))<sp/>{</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;queue<sp/>=<sp/>db_query(</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;SELECT<sp/>job_id<sp/>FROM<sp/>{tripal_jobs}<sp/>TJ</highlight></codeline>
<codeline lineno="127"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>WHERE<sp/>TJ.start_time<sp/>IS<sp/>NULL<sp/>AND<sp/>TJ.end_time<sp/>IS<sp/>NULL<sp/>AND<sp/>TJ.status<sp/>!=<sp/>&apos;Cancelled&apos;</highlight></codeline>
<codeline lineno="128"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ORDER<sp/>BY<sp/>priority<sp/>ASC,<sp/>job_id<sp/>ASC&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>)-&gt;fetchCol();</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>queue<sp/>is<sp/>still<sp/>empty<sp/>then<sp/>there<sp/>are<sp/>no<sp/>jobs<sp/>waiting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(empty($this-&gt;queue))<sp/>{</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Return<sp/>the<sp/>next<sp/>job<sp/>in<sp/>line.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/>$job_id<sp/>=<sp/>array_shift($this-&gt;queue);</highlight></codeline>
<codeline lineno="139"><highlight class="normal"></highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>But<sp/>only<sp/>if<sp/>it<sp/>wasn&apos;t<sp/>already<sp/>run.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!isset($this-&gt;tripal_jobs[$job_id]))<sp/>{</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$job_id;</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="145"><highlight class="normal"></highlight></codeline>
<codeline lineno="149" refid="d1/dc1/classTripalDaemon_1aa8546f228a9b6686bea8c4f3b514c635" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1aa8546f228a9b6686bea8c4f3b514c635" kindref="member">runTripalJob</ref>($job_id)<sp/>{</highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Load<sp/>the<sp/>job<sp/>we<sp/>are<sp/>going<sp/>to<sp/>run.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/>$job<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="d5/d64/classTripalJob" kindref="compound">TripalJob</ref>();</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/>$job-&gt;load($job_id);</highlight></codeline>
<codeline lineno="154"><highlight class="normal"></highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Tell<sp/>admins<sp/>we<sp/>are<sp/>running<sp/>a<sp/>job.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/>$this-&gt;tripal_jobs[$job_id]<sp/>=<sp/>$job;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/>$this-&gt;setStatus();</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>And<sp/>log<sp/>the<sp/>details.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Job<sp/>(ID=&apos;</highlight><highlight class="normal">.$job_id.</highlight><highlight class="stringliteral">&apos;)<sp/>Started<sp/>at<sp/>&apos;</highlight><highlight class="normal">.format_date(time(),<sp/></highlight><highlight class="stringliteral">&apos;small&apos;</highlight><highlight class="normal">).</highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="160"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Parallel:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($this-&gt;do_parallel)<sp/>{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;<ref refid="d1/dc1/classTripalDaemon_1a6cdd2a3f29d24965351b716f4c32a805" kindref="member">runParallelTripalJob</ref>($job_id);</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sequential:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job<sp/>=<sp/>$this-&gt;<ref refid="d1/dc1/classTripalDaemon_1ac109d9aa3dc5901df037cfc33e38e65b" kindref="member">runSequentialTripalJob</ref>($job);</highlight></codeline>
<codeline lineno="168"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Job<sp/>needs<sp/>to<sp/>be<sp/>re-loaded<sp/>to<sp/>reflect<sp/>the<sp/>new<sp/>end<sp/>time<sp/>and<sp/>status</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>since<sp/>this<sp/>does<sp/>not<sp/>seem<sp/>to<sp/>be<sp/>set<sp/>by<sp/>run().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;load($job_id);</highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>job<sp/>is<sp/>sequential<sp/>then<sp/>we<sp/>know<sp/>we<sp/>are<sp/>done<sp/>the<sp/>job</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>just<sp/>by<sp/>the<sp/>virtue<sp/>of<sp/>having<sp/>reached<sp/>this<sp/>code.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>As<sp/>such,<sp/>tell<sp/>the<sp/>admin<sp/>:-).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>unset($this-&gt;tripal_jobs[$job_id]);</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;setStatus();</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>And<sp/>log<sp/>the<sp/>details.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Job<sp/>(ID=&apos;</highlight><highlight class="normal">.$job_id.</highlight><highlight class="stringliteral">&apos;)<sp/>Completed&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;End<sp/>DateTime:<sp/>&apos;</highlight><highlight class="normal">.format_date($job-&gt;getEndTime(),<sp/></highlight><highlight class="stringliteral">&apos;small&apos;</highlight><highlight class="normal">),<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Status:<sp/>&apos;</highlight><highlight class="normal">.$job-&gt;getStatus(),<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="182"><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="185"><highlight class="normal"></highlight></codeline>
<codeline lineno="189" refid="d1/dc1/classTripalDaemon_1a6cdd2a3f29d24965351b716f4c32a805" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1a6cdd2a3f29d24965351b716f4c32a805" kindref="member">runParallelTripalJob</ref>($job_id)<sp/>{</highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Tripal<sp/>job<sp/>launcher<sp/>needs<sp/>the<sp/>user...<sp/>Unfortunatly<sp/>we<sp/>cannot<sp/>pass<sp/>one<sp/>through<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>drush<sp/>command<sp/>since<sp/>that<sp/>is<sp/>intercepted<sp/>by<sp/>drushd.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>As<sp/>such<sp/>we<sp/>are<sp/>going<sp/>ot<sp/>use<sp/>the<sp/>god<sp/>user<sp/>(uid=1)<sp/>as<sp/>a<sp/>default<sp/>that<sp/>can<sp/>be<sp/>overriden</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>by<sp/>passing<sp/>in<sp/>the<sp/>drush<sp/>&quot;user&quot;<sp/>option.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/>$uid<sp/>=<sp/>drush_get_option(</highlight><highlight class="stringliteral">&apos;user&apos;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/>$user<sp/>=<sp/>user_load($uid);</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/>$username<sp/>=<sp/>$user-&gt;name;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>use<sp/>drush_invoke_process()<sp/>to<sp/>fork<sp/>the<sp/>daemon<sp/>safely<sp/>to<sp/>run</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>multiple<sp/>jobs<sp/>concurrently.<sp/>We<sp/>can&apos;t<sp/>use<sp/>the<sp/>PHP-daemon<sp/>built</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>functionality<sp/>such<sp/>as<sp/>workers<sp/>&amp;<sp/>tasks<sp/>b/c<sp/>they<sp/>copy<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>entire<sp/>enviro.<sp/>resulting<sp/>in<sp/>mutliple<sp/>processes<sp/>using<sp/>the<sp/>same</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>database<sp/>connection<sp/>(which<sp/>causes<sp/>errors).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/>drush_invoke_process(</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;@self&apos;</highlight><highlight class="normal">,<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Obviously<sp/>run<sp/>on<sp/>the<sp/>current<sp/>site.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;trp-run-jobs&apos;</highlight><highlight class="normal">,<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>the<sp/>tripal<sp/>job<sp/>launcher.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>array(),<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>arguments<sp/>(only<sp/>options<sp/>below).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;job_id&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$job_id,<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>job<sp/>to<sp/>be<sp/>run.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;username&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$username,<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>user<sp/>to<sp/>run<sp/>it<sp/>as.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;single&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>1,<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>run<sp/>a<sp/>single<sp/>job!</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;parallel&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$this-&gt;do_parallel,<sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;re<sp/>aloud<sp/>to<sp/>run<sp/>in<sp/>parallel.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;max_jobs&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$this-&gt;max_num_jobs,<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>But<sp/>only<sp/>this<sp/>many<sp/>jobs<sp/>at<sp/>once.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>),</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;fork&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>TRUE)<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>tells<sp/>drush<sp/>to<sp/>spawn<sp/>a<sp/>new<sp/>process.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="219"><highlight class="normal"></highlight></codeline>
<codeline lineno="223" refid="d1/dc1/classTripalDaemon_1ac109d9aa3dc5901df037cfc33e38e65b" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1ac109d9aa3dc5901df037cfc33e38e65b" kindref="member">runSequentialTripalJob</ref>($job)<sp/>{</highlight></codeline>
<codeline lineno="224"><highlight class="normal"></highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>the<sp/>job.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;run();</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>$e)<sp/>{</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;logMessage($e-&gt;getMessage(),<sp/>array(),<sp/><ref refid="dd/d45/tripal_8notice_8api_8inc_1a4b04c4b1ce52da710d57abf5c4b09dd3" kindref="member">TRIPAL_ERROR</ref>);</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="232"><highlight class="normal"></highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$job;</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="235"><highlight class="normal"></highlight></codeline>
<codeline lineno="242" refid="d1/dc1/classTripalDaemon_1adb0792e21e59145e76a36ffa477aaee8" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1adb0792e21e59145e76a36ffa477aaee8" kindref="member">checkJobStatus</ref>($job_id<sp/>=<sp/>FALSE)<sp/>{</highlight></codeline>
<codeline lineno="243"><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($job_id)<sp/>{</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="d5/d64/classTripalJob" kindref="compound">TripalJob</ref>();</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;load($job_id);</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$jobs<sp/>=<sp/>array($job_id);</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/>elseif<sp/>(!empty($this-&gt;tripal_jobs))<sp/>{</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>$jobs<sp/>=<sp/>array_keys($this-&gt;tripal_jobs);</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="255"><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>=<sp/>db_query(</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&apos;SELECT<sp/>job_id,<sp/>pid,<sp/>end_time,<sp/>status<sp/>FROM<sp/>{tripal_jobs}<sp/>WHERE<sp/>job_id<sp/>IN<sp/>(:jobs)&apos;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>array(</highlight><highlight class="stringliteral">&apos;:jobs&apos;</highlight><highlight class="normal"><sp/>=&gt;<sp/>$jobs));</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">foreach</highlight><highlight class="normal"><sp/>(<ref refid="dd/d72/tripal__library__features_8tpl_8php_1a233d12bd8b6d3453e9a7a3f0b8c31db2" kindref="member">$results</ref><sp/>as<sp/>$job)<sp/>{</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>system<sp/>still<sp/>thinks<sp/>the<sp/>job<sp/>is<sp/>running<sp/>then<sp/>check<sp/>it&apos;s<sp/>pid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($job-&gt;status<sp/>==<sp/></highlight><highlight class="stringliteral">&apos;Running&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$status<sp/>=<sp/>shell_exec(</highlight><highlight class="stringliteral">&apos;ps<sp/>-p<sp/>&apos;</highlight><highlight class="normal"><sp/>.<sp/>escapeshellarg($job-&gt;pid)<sp/>.<sp/></highlight><highlight class="stringliteral">&apos;<sp/>-o<sp/>pid=&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!$status)<sp/>{</highlight></codeline>
<codeline lineno="264"><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>the<sp/>job.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;end_time<sp/>=<sp/>time();</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;error_msg<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;Unknown<sp/>Error<sp/>Encountered.&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;status<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;Error&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$job-&gt;pid<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>drupal_write_record(</highlight><highlight class="stringliteral">&apos;tripal_jobs&apos;</highlight><highlight class="normal">,<sp/>$job,<sp/></highlight><highlight class="stringliteral">&apos;job_id&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>job<sp/>is<sp/>finished<sp/>if<sp/>it&apos;s<sp/>not<sp/>running<sp/>or<sp/>waiting<sp/>-tell<sp/>the<sp/>admin.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>($job-&gt;status<sp/>!=<sp/></highlight><highlight class="stringliteral">&apos;Running&apos;</highlight><highlight class="normal"><sp/>AND<sp/>$job-&gt;status<sp/>!=<sp/></highlight><highlight class="stringliteral">&apos;Waiting&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="276"><highlight class="normal"></highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>As<sp/>such,<sp/>tell<sp/>the<sp/>admin<sp/>:-).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset($this-&gt;tripal_jobs[$job-&gt;job_id]);</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;setStatus();</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>And<sp/>log<sp/>the<sp/>details.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Job<sp/>(ID=&apos;</highlight><highlight class="normal">.$job-&gt;job_id.</highlight><highlight class="stringliteral">&apos;)<sp/>Completed&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;End<sp/>DateTime:<sp/>&apos;</highlight><highlight class="normal">.format_date($job-&gt;end_time,<sp/></highlight><highlight class="stringliteral">&apos;small&apos;</highlight><highlight class="normal">),<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$this-&gt;log(</highlight><highlight class="stringliteral">&apos;Status:<sp/>&apos;</highlight><highlight class="normal">.$job-&gt;status,<sp/></highlight><highlight class="stringliteral">&apos;&apos;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="284"><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="288"><highlight class="normal"></highlight></codeline>
<codeline lineno="296" refid="d1/dc1/classTripalDaemon_1ae982a294c6ba78d5dbab72586426e8a7" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">protected</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1ae982a294c6ba78d5dbab72586426e8a7" kindref="member">getStatusDetails</ref>()<sp/>{</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/>$status_details<sp/>=<sp/>parent::getStatusDetails();</highlight></codeline>
<codeline lineno="298"><highlight class="normal"></highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/>$status_details[</highlight><highlight class="stringliteral">&apos;Running<sp/>Job&apos;</highlight><highlight class="normal">]<sp/>=<sp/>(empty($this-&gt;tripal_jobs))<sp/>?<sp/>FALSE<sp/>:<sp/>TRUE;</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/>$status_details[</highlight><highlight class="stringliteral">&apos;Current<sp/>Jobs&apos;</highlight><highlight class="normal">]<sp/>=<sp/>array_keys($this-&gt;tripal_jobs);</highlight></codeline>
<codeline lineno="301"><highlight class="normal"></highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>$status_details;</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="304"><highlight class="normal"></highlight></codeline>
<codeline lineno="313" refid="d1/dc1/classTripalDaemon_1a6274f72f0aade217daaa436b01935c91" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/><ref refid="d1/dc1/classTripalDaemon_1a6274f72f0aade217daaa436b01935c91" kindref="member">setParallel</ref>(<ref refid="d1/dc1/classTripalDaemon_1afe5323f91f48109a6db38a3cb1ceb60c" kindref="member">$do_parallel</ref>,<sp/><ref refid="d1/dc1/classTripalDaemon_1afda0e18585c39d5757958d9357913f42" kindref="member">$max_num_jobs</ref>)<sp/>{</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/>$this-&gt;do_parallel<sp/>=<sp/><ref refid="d1/dc1/classTripalDaemon_1afe5323f91f48109a6db38a3cb1ceb60c" kindref="member">$do_parallel</ref>;</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/>$this-&gt;max_num_jobs<sp/>=<sp/><ref refid="d1/dc1/classTripalDaemon_1afda0e18585c39d5757958d9357913f42" kindref="member">$max_num_jobs</ref>;</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="317"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="tripal_daemon/TripalDaemon.inc"/>
  </compounddef>
</doxygen>
